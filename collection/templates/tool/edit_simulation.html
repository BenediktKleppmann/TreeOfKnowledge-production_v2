{% extends 'layouts/base_tool.html' %}
{% load staticfiles %}

<!-- 
####################################################################
# This file is part of the Tree of Knowledge project.
# Copyright (C) Benedikt Kleppmann - All Rights Reserved
#
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Benedikt Kleppmann <benedikt@kleppmann.de>, February 2021
#####################################################################
-->

{% block title %}
	Edit Simulation {{ model.name }}
{% endblock %}

{% block additionalcss %}


	<script src="{% static 'js/jointjs/jquery.js' %}"></script>
	<script src="{% static 'js/jointjs/lodash.js' %}"></script>
	<script src="{% static 'js/jointjs/backbone.js' %}"></script>
	<script src="{% static 'js/jointjs/joint.js' %}"></script>

	<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script type="text/javascript" src="https://rawgit.com/RickStrahl/jquery-resizable/master/src/jquery-resizable.js"></script>
	
	<script type="text/javascript" src="{% static 'js/datepicker/moment.min.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/datepicker/transition.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/datepicker/collapse.js' %}"></script>
	<script type="text/javascript" src="{% static 'js/datepicker/bootstrap-datetimepicker.min.js' %}"></script>
	
	<link rel="stylesheet" type="text/css" href="{% static 'js/jointjs/joint.css' %}" />
	<link rel="stylesheet" href="{% static 'css/jquery.highlight-within-textarea.css' %}">
	<link rel="stylesheet" href="{% static 'css/bootstrap-3.4.0.min.css' %}" />
	<link rel="stylesheet" href="{% static 'css/bootstrap-datetimepicker.min.css' %}" />

	
	

		

		
	
<style>
	.content {
		padding: 0px;
		height: calc(100% - 60px);
	}
	

	/* Top Menu -------------------------------------------------*/
	
	#profile-drop-down {
	    margin-right: 15px;
	}

	/* Resizable Panels -------------------------------------------------*/

	.panel-container {
	  display: flex;
	  flex-direction: row;
	  border: 1px solid silver;
	  overflow: hidden;
	  xtouch-action: none; /* avoid browser level touch actions */
	  height: 100%;
	}

	#left-panel {
	  flex: 0 0 auto;  /* only manually resize */
	  width: 300px;
	  min-width: 150px;
	  height:calc(100vh - 60px);
	  //white-space: nowrap;
	  background: rgb(226, 226, 226);
	}

	#splitter {
	  flex: 0 0 auto;
	  width: 4px;  
	  background: rgb(225, 225, 225);
	  border: 1px solid rgb(200, 200, 200);
	  cursor: col-resize;    
	  box-shadow: 3px  0 6px 0 rgba(0, 0, 0, 0.19);
	  z-index: 1;
	  height: calc(100vh - 60px);
	}

	#right-panel {
	  flex: 1 1 auto;   /* resizable */
	  padding: 10px;
	  width: 100%;
	  min-width: 200px;
	  height: calc(100vh - 60px);
	}
	
	/* -------------------------------------------------------------------*/
	/* LEFT PANEL --------------------------------------------------------*/
	/* -------------------------------------------------------------------*/
	
	
	/* Accorion -----*/
	.card-header {
		border-top: 1px solid rgb(180, 180, 180);
		border-bottom: 1px solid rgb(180, 180, 180);
	}
	
	.left-panel-header {
		font-size: 15.5px;
		background: rgb(226, 226, 226);
		width: 100%;
		padding-left: 20px;
		text-align: left;
		overflow: hidden;
	}
	
	.card-body {
		padding-left: 5px;
		padding-right: 5px;
		background-color: rgb(244, 244, 244);
	}
	
	/* Accorion0: Main */
	#accordion-left-content-0 .form-group.row {
		margin-bottom: 3px;
	}
	
	#accordion-left-content-0 .left-panel-body {
		padding: 23px 12px 9px 17px;
	}
	
	#open-execution-modal-button {
		border: 1px solid #ccc;
		background: white;
		width: 154px;
		text-align: left;
	}
	
	#copy-save-simulation-buttons {
		margin-top: 19px;
	}
	
	#copy-simulation-button {
		display: inline-block;
	}
	
	#save-simulation-button {
		display: inline-block;
		margin-left: 5px;
	}
	
	#open-copy-button {
		margin-top: 5px;
		border: 1px solid #ccc;
	}

	/* Accorion2: Objects */
	
	.objects-table-entry {
		float: left;
		width: 94px;
	}
	
	.object-icon {
		height: 55px;
		width: 55px;
		background: rgb(235, 235, 235);
		border: 1px solid rgb(183, 183, 183);
		border-radius: 4px;
		box-shadow: -1px 1px 2px 1px rgba(0, 0, 0, 0.075);
		margin-top: 6px;
		margin-left: 19px;
		padding-top: 5px;
		padding-left: 4px;
		padding-right: 5px;
	}
	
	.object-name {
		width: 93px;
		text-align: center;
		font-size: 12px;
		font-weight: 300;
	}
	
	
	/* Relations -----*/
	#relations-card {
		padding-bottom: 10px;
		padding-left: 17px;
	}
	
	.relation-button-box-header {
		margin-left: -5px;
		padding-top: 5px;
	}
	
	.relation-button-box-header-text {
		display: inline-block;
		color: rgb(140,140,140);
	}
	
	.hr {
		display: inline-block;
		width: 150px;
		border-top: 1px solid rgb(140,140,140);
		margin-left: 6px;
		height: 5px;
	}
	
	.relation-button {
		margin-top: 3px;
		margin-left: 3px;
	}
	
	.relation-button-box .btn-group > .btn {
		margin-right:43px;
		width:109px;	
		border: 1px solid black;
		border-radius: 0px;
		color:rgb(40, 40, 40);
		background-color: rgb(252, 252, 255);
		border-color: rgb(186, 187, 188);
		border-radius: 5px;
	  }
	  
	.relation-button:hover, 
	.relation-button.active  {
		background: linear-gradient(180deg,rgb(161, 161, 161) 0%,rgb(170, 170, 170) 96.48217237937519%);
		box-shadow: inset 1px 1px 02px 01px rgba(0%,0%,0%,0.082);
	  }
	  

	
	/* ---------------------------------------------------------------*/
	/* MIDDLE --------------------------------------------------------*/
	/* ---------------------------------------------------------------*/
	
	.paper {
		height: 100%;
		width:100%
	}
	
	#scenario-behaviour-button-group {
		position:absolute;
		top: 58px;
		left:40%;
	}
	
	.scenario-behaviour-button {
		border: 1px solid gray;
		border-top-left-radius: 0px;
		border-top-right-radius: 0px;
		border-bottom-left-radius: 10px;
		border-bottom-right-radius: 10px;
		background: linear-gradient(180deg,rgb(252, 252, 252) 0%,rgb(233, 233, 233) 96.48217237937519%);
		padding: 5px 19px;
		z-index: 1;
	}
	
	.scenario-behaviour-button.active {
		background: linear-gradient(180deg,rgb(161, 161, 161) 0%,rgb(170, 170, 170) 96.48217237937519%);
		box-shadow: inset 1px 1px 02px 01px rgba(0%,0%,0%,0.082);
	}
	
	/* the remove button (x) on the objects on the paper*/
	.element-tool-remove {
		display: none;
		cursor: pointer
	}


	/* ---------------------------------------------------------------*/
	/* RIGHT SIDEBAR -------------------------------------------------*/
	/* ---------------------------------------------------------------*/

	
	#right-sidebar {
		z-index: 2; 
		position: absolute; 
		top: 58px; 
		right: 0px; 
		width: 0px; 
		height: calc(100vh - 61px);
	}
	
	#right-sidebar-left-edge {
	  width: 4px;  
	  background: rgb(225, 225, 225);
	  border: 1px solid rgb(200, 200, 200);
	  box-shadow: -3px  0 6px 0 rgba(0, 0, 0, 0.19);
	  z-index: 1;
	  float:left;
	  display:inline-block;
	  height: 100%;
	  height: calc(100vh - 59px);
	}
	
	#right-sidebar-head {
		display: inline-block;
		width: 413px;
	}
	
	#right-sidebar-body {
		background: white;
	}

	/* Object Header -------------------------------------------------*/

	
	#object-header {
		background: rgb(226, 226, 226);
		box-shadow: 0  3px 6px 0 rgba(0, 0, 0, 0.20);
		position: relative;
		margin-left: 4px;
	}
	
	#object-icon-button {
		display: inline-block;
		margin-top: 5px;
		margin-left: 22px;
		margin-bottom: 8px;
		height: 49px;
		width: 49px;		
		//background: rgb(235, 235, 235);
		border: 1px solid rgb(183, 183, 183);
		border-radius: 4px;
		padding-top: 5px;
		padding-left: 5px;
		padding-right: 3px;
	}
	
	#object-name-field {
		margin-top: 25px;
		margin-left: 10px;
		margin-bottom: 21px;
		height: 40px;
		width: 280px;
	}
	

	/* Object Icon Popover ----*/
	
	.object-icon-box {
		height: 400px;
		overflow: auto;
		width: 265px;
	}
	
	.small-object-icon {
		height: 25px;
		width: 25px;
		background: rgb(249, 249, 249);
		border: 1px solid rgb(210, 210, 210);
		border-radius: 2px;
		box-shadow: -1px 1px 0px 2px rgba(0, 0, 0, 0.05);
		margin-top: 3px;
		margin-left: 1px;
		padding-top: 2px;
		padding-left: 2px;
		padding-right: 1px;
	}
	
	.small-object-icon:hover {
		background: rgb(235, 235, 235);
	}

	
	/* Object Filter Facts  ----------------------------------------------------------*/
	
	#object_facts_list {
		margin-top: 7px;
	}
	
	#object_facts_list > .list-group-item {
		width: 407px !important;
		margin-bottom: 0px !important;
	}

	.attribute-button {
		width: 163px;
		text-align: left;
		margin-left: 6px;
	}	
	
	.operator {
		width: 58px;
	}
	
	.value {
		width: 125px ;
		text-align: left;
	}

	.format-violation {
		position: absolute;
		margin-left: 369px;
	}
	
	/*the triangle on the 'Attribute'-button*/
	.fa-caret-down {
		float: right;
		margin-top: 3px;
	}
	
	.drop-down-display > .narrow {
		padding: 2px 0px;
	}
	
	#make-new-additional-fact-button {
		margin-left: 6px;
		width: 39px;
	}
	
	
</style>



{% endblock %}

{% block content %}

<div class="panel-container">

	<div id="left-panel"></div>

	<div id="splitter">
	</div>

	<div id="right-panel">	
		<div id="scenario-behaviour-button-group" class="btn-group" data-toggle="buttons">		
			<label id="scenario-button" class="btn scenario-behaviour-button active" onclick="changeWindowState('scenario')">Scenario</label>
			<label id="behaviour-button" class="btn scenario-behaviour-button" onclick="changeWindowState('behaviour')">Behaviour</label>
		</div>
		
		<div id="paper" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
	</div>
	
	<div id="right-sidebar">
		<div id="right-sidebar-left-edge" style="display:none;"></div>
		<div id="right-sidebar-head" class="form"  style="display:none;">
			<div id="object-header">
				<button type="button" id="object-icon-button" class="btn" style="display:inline-block;" data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" title="Choose icon" data-content=''>
					<img src="{% static "images/object_icons/" %}si-glyph-mustache.svg">
				</button>
				<input type="text" class="form-control" id="object-name-field" name="object_name" placeholder="Object Name" value="object_name" onchange="" style="display:inline-block;width:300px">
				<input type="hidden" id="object-number-field" value="">
			</div>
			
			<div id="right-sidebar-body"></div>
				
				

		</div>

	</div>

</div>





	
	<!--<script src="{% static 'js/jquery.js' %}"></script>-->
	<!--<script src="{% static 'js/jquery-2.2.4.js' %}"></script>-->
	<!--<script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>-->

	
	{% include "tool/includes/edit_simulation__simulate.html" %} 
	
	<script type="text/javascript" src="{% static 'js/bootstrap-3.4.0.min.js' %}"></script>
	{% include "tool/includes/additional_facts_functions.html" %} 

	
	

<script>
	// GLOBAL VARIABLES:
	
	var window_state = 'scenario';  // 'scenario' or 'behaviour'
	
	var available_object_types = {{ available_object_types|safe }};
	var object_icons = {{ object_icons|safe }};
	var available_relations = {{ available_relations|safe }};
	var available_execution_orders = {{ available_execution_orders|safe }};
	
	var is_timeseries_analysis = {{ simulation_model.is_timeseries_analysis|yesno:"true,false"  }};
	var objects_dict = {{ simulation_model.objects_dict|safe }};
	var manually_set_initial_values = {{ simulation_model.manually_set_initial_values|safe }};
	var sorted_attribute_ids = {{ simulation_model.sorted_attribute_ids|safe }};
	var object_type_counts = {{ simulation_model.object_type_counts|safe }};
	var total_object_count = {{ simulation_model.total_object_count|safe }};          
	var number_of_additional_object_facts = {{ simulation_model.number_of_additional_object_facts|safe }};
	var simulation_name = '{{ simulation_model.simulation_name }}';
	var y_value_attributes = {{ simulation_model.y_value_attributes|safe }};
	
	
	var paper = null;
	var graph = null;
	
	var environment_start_time = {{ simulation_model.environment_start_time|safe }};
	var environment_end_time =  {{ simulation_model.environment_end_time|safe }};
	var simulation_start_time = {{ simulation_model.simulation_start_time|safe }};
	var simulation_end_time =  {{ simulation_model.simulation_end_time|safe }};
	var timestep_size = {{ simulation_model.timestep_size|safe }};
	var nb_of_tested_parameters = {{ simulation_model.nb_of_tested_parameters|safe }};
	var max_number_of_instances = {{ simulation_model.max_number_of_instances|safe }};
	var error_threshold = {{ simulation_model.error_threshold|safe }};
	var run_locally = "{{ simulation_model.run_locally|safe }}";
	var limit_to_populated_y0_columns = "{{ simulation_model.limit_to_populated_y0_columns|safe }}";
	var data_querying_info = {{ simulation_model.data_querying_info|safe }};
	
	
	var execution_order_id = {{ simulation_model.execution_order_id }};
	var execution_order_description = '';
	var execution_order = {};
	var active_relation_button = null;
	var get_new_object_data = false;
	
	var simulation_results_exist = {{ simulation_results_exist|yesno:"true,false"  }};
	
	
	
	

	//========================================================================
	//==============    THE LEFT PANEL      ==================================
	//========================================================================
	

	 
	 // Draw the Left Panel (For the Scenario-State)    =============================================================================
	function drawLeftPanel__scenario() {
		
	
		left_panel__scenario = '<div class="accordion md-accordion" id="accordion-left" role="tablist" aria-multiselectable="true">' +	
								'<div class="card">' +
									'<div class="card-header" role="tab" id="accordion-left-header-0">' +
										'<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-0" aria-expanded="false" aria-controls="accordion-left-content-0">Main</button>' +
									'</div>' +
									'<div id="accordion-left-content-0" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-0" data-parent="#accordion-left">' +
										'<div class="card-body">' +
											'<div class="form left-panel-body">' +
												'<div class="form-group row">' +
													'<label for="max" class="col-sm-5">Simulation Name</label>' +
													'<div class="col-sm-7">' +
														'<input id="simulation-name" class="form-control" value="">' +
													'</div>' +
												'</div>' +
												'<div class="form-group row">' +
													'<label for="max" class="col-sm-5">Model</label>' +
													'<div class="col-sm-7">' +
														'<button id="open-execution-modal-button" class="btn btn-secondary" type="button" onclick="openSelectExecutionOrderModal()">' + available_execution_orders[execution_order_id]['name'] + '</button>' +
													'</div>' +
												'</div>' +
												'<div id="copy-save-simulation-buttons">' +
													'<button id="copy-simulation-button" class="btn btn-warning" type="button" onclick="copySimulation()">Copy Simulation</button>' +
													'<button id="save-simulation-button" class="btn btn-primary" type="button" onclick="saveSimulation()">Save Simulation</button>' +
												'</div>' +
												'<div id="open-copy-button-frame"></div>' +
											'</div>' +
										'</div>' +
									'</div>' +
								'</div>' +
								'<div class="card">' +
									'<div class="card-header" role="tab" id="accordion-left-header-1">' +
										'<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-1" aria-expanded="false" aria-controls="accordion-left-content-1">Initialization</button>' +
									'</div>' +
									'<div id="accordion-left-content-1" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-1" data-parent="#accordion-left">' +
										'<div class="card-body">' +
											'<div class="form left-panel-body">' +
												'<div class="form-group row">' +
													'<label for="max" class="col-sm-5">Start Time</label>' +
													'<div class="col-sm-7">' +
														'<input id="environment-start-time" class="datetimepicker form-control" value="">' +
													'</div>' +
												'</div>' +
												'<div class="form-group row">' +
													'<label for="max" class="col-sm-5">End Time</label>' +
													'<div class="col-sm-7">' +
														'<input id="environment-end-time" class="datetimepicker form-control" value="">' +
													'</div>' +
												'</div>' +
													'<div class="form-group row">' +
														'<label for="max_number_of_instances" class="col-sm-5">Max number of simulated systems</label>' +
														'<div class="col-sm-7">' +
															'<input type="text" id="max_number_of_instances" class="form-control" value="2000">' +
														'</div>' +
													'</div>' +
											'</div>' +
										'</div>' +
									'</div>' +
								'</div>' +
								'<div class="card">' +
									'<div class="card-header" role="tab" id="accordion-left-header-2">' +
										'<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-2" aria-expanded="false" aria-controls="accordion-left-content-2">Objects</button>' +
									'</div>' +
									'<div id="accordion-left-content-2" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-2" data-parent="#accordion-left">' +
										'<div class="card-body">' +
											'<table id="objects-table" style="width:100%">';
							
		object_type_ids = Object.keys(available_object_types);
		for (var i = 0; i < Math.ceil(object_type_ids.length/3) ; i++) {
			left_panel__scenario += 				"<tr>";
			
			for (var j = 0; j < 3 ; j++) {
				entry_number = i*3 + j
				if (entry_number < object_type_ids.length) {
					object_type_id = object_type_ids[entry_number];
					object_name = available_object_types[object_type_id]['name']
					object_icon = available_object_types[object_type_id]['object_type_icon']
					left_panel__scenario += 			'<td class="objects-table-entry">' +
														'<div class="object-icon" draggable="true" ondragstart="drag(event, \'' + object_type_id + '\')" onclick="createObject(\'' + object_type_id + '\', 100, 100)" data-object-type-id="' + object_type_id + '"> ' +
															'<img src="{% static "images/object_icons/" %}' + object_icon + '.svg">' +
														'</div>' +
														'<div class="object-name">' + object_name + '</div>' +
													'</td>';
				}
			}
			left_panel__scenario += 				"</tr>";
		}
			
		left_panel__scenario +=				'</table> ' +
										'</div>' +
									'</div>' +
								'</div>' +
								'<div class="card">' +
									'<div class="card-header" role="tab" id="accordion-left-header-3">' +
										'<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-3" aria-expanded="false" aria-controls="accordion-left-content-3">Relations</button>' +
									'</div>' +
									'<div id="accordion-left-content-3" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-3" data-parent="#accordion-left">' +
										'<div id="relations-card" class="card-body">' +
										'</div>' +
									'</div>' +
								'</div>' +
							'</div>';
	
		$("#left-panel").html(left_panel__scenario);	
		
		// initialize simulation-name
		$("#simulation-name").val(simulation_name);
		$("#simulation-name").focusout(function(){
			simulation_name = $("#simulation-name").val()
		});
		
		// initialize execution-order
		$("#execution-order").val(execution_order_id);
		$("#execution-order").change(function(){		
		if (execution_order_id == ''){
		
		} else {
			execution_order_id = $("#execution-order").val()
		}
		});
		
		// initialize max_number_of_instances
		$("#max_number_of_instances").val(max_number_of_instances);
		$("#max_number_of_instances").focusout(function(){
			max_number_of_instances = $("#max_number_of_instances").val()
		});
		
		
		
		//make the datetimepickers ---------------------------------
		$('.datetimepicker').datetimepicker({
			startView:'decade',
			minView:'hour',
			format: 'yyyy-mm-dd hh:ii',
			autoclose:true
		});
		
		// this showing and hiding makes sure that there are no open ones at the bottom of the page
		//$('.datetimepicker').datetimepicker('show');
		$('.datetimepicker').datetimepicker('hide');
		
		// initialize the datetimepickers
		var start_date = new Date(environment_start_time*1000);
		var end_date = new Date(environment_end_time*1000);
		var start_date_string = start_date.toISOString().replace('T', ' ').substring(0,16);
		var end_date_string = end_date.toISOString().replace('T', ' ').substring(0,16);
		$("#environment-start-time").val(start_date_string);
		$("#environment-end-time").val(end_date_string);
	
		
		// DATE CHANGE for DataTimePicker ---------------------------
		$("#environment-start-time").datetimepicker().on('changeDate', function(ev){
			//link the start- and end- datetimepickers
			$("#environment-end-time").datetimepicker("setStartDate", '"' + ev.date.toISOString().substring(0,10) + '"');
			environment_start_time = Math.round(ev.date.getTime() / 1000) - (ev.date.getTimezoneOffset()*60);
			get_new_object_data = true;
		});
		
		$("#environment-end-time").datetimepicker().on('changeDate', function(ev){
			$("#environment-start-time").datetimepicker("setEndDate", '"' + ev.date.toISOString().substring(0,10) + '"');
			environment_end_time = Math.round(ev.date.getTime() / 1000) - (ev.date.getTimezoneOffset()*60);
			get_new_object_data = true;
		});
		
		
		$('.accordion-toggle').click(function() {
			content_element = $($(this).attr('href'));
			if (content_element.hasClass('in')) {
				content_element.hide();
				content_element.removeClass('in')
			} else {
				content_element.show();
				content_element.addClass('in')
			}
		});
	}		
	
	
	
	
	
	function updateThePageAfterChangingExecutionOrder(){
		var url_components = window.location.href.split("/");
		var simulation_id = url_components[url_components.length - 2];

		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				simulation_results_exist = JSON.parse(this.responseText);
				drawScenarioBehaviourButtons();
			}
		};
		xhttp.open('GET', '/tool/check_if_simulation_results_exist?simulation_id=' + String(simulation_id) + '&execution_order_id=' + String(execution_order_id) , true);
		xhttp.send();
	}
	
	
	
	
	
	function listTheAvailableRelations(){
		relation_buttons_string = '';
		
		created_object_types = Object.keys(object_type_counts);
		relation_ids = Object.keys(available_relations);
		for (var i = 0; i < created_object_types.length; i++) {
			object_type_id = created_object_types[i];
			object_type_name = available_object_types[object_type_id]['name'];
			
			relation_buttons_string += '<div class="relation-button-box">' + 
											'<div class="relation-button-box-header">' +
												'<div class="relation-button-box-header-text">' + object_type_name + '</div>' +
												'<div class="hr"></div>' +
											'</div>';
											
			for (var j = 0; j < relation_ids.length; j++) {
				the_relation = available_relations[relation_ids[j]];
				if (the_relation['all_applicable_object_types'].includes(object_type_id)){
				
					related_object_type_name = available_object_types[the_relation['first_relation_object_type']]['name'];
					
					relation_buttons_string += '<button id="relation-button' + relation_ids[j] + '" class="relation-button btn" onclick="relationButtonClick(' + relation_ids[j] + ')">--  ' + the_relation['name'] + ' --> ' + '</button>';
					
					
					/*relation_buttons_string += '<div class="relation-button btn-group" data-toggle="buttons">' +
													'<label id="relation-button-label' + relation_ids[j] + '" class="btn" onclick="relationButtonClick(' + relation_ids[j] + ')" >' +          //data-toggle="tooltip" title="' + the_relation['description']  + '"
														'<input type="checkbox" autocomplete="off" id="relation-button' + relation_ids[j] + '">--  ' + the_relation['name'] + ' --> ' + 
													'</label>' +
												'</div>' + 
												'<input type="checkbox" autocomplete="off" id="relation-button' + relation_ids[j] + '-b">';  */
				}
			}
			
			relation_buttons_string += 		'</div>' + 
										'</div>';
		}
		
		$('#relations-card').html(relation_buttons_string);
		
	}
	
	function relationButtonClick(relation_button_number) {
		relation_button_number = String(relation_button_number);
		is_already_active =  $('#relation-button' + relation_button_number).hasClass("active");
		
		if (is_already_active) {
			//uncheck it and remove the linkability of the Paper elements
			$('#relation-button' + relation_button_number).removeClass("active");
			_.each(graph.getElements(), function(el) {
				el.removeAttr('rect/magnet').removeAttr('text/pointer-events');
			});
			active_relation_button = null;
		} else {
			//deactivate other buttons and activate this one 
			$('.relation-button').each(function() {
				$(this).removeClass("active");
			});
			$('#relation-button' + relation_button_number).addClass("active")
			
			//allow the linkability for the right Paper elements
			all_applicable_object_types = available_relations[relation_button_number]['all_applicable_object_types'];
			_.each(graph.getElements(), function(el) {
				object_type_id = el['attributes']['object_type_id'];
				if (all_applicable_object_types.includes(object_type_id)) {
					el.attr('rect/magnet', true).attr('text/pointer-events', 'none');
				} else {
				el.removeAttr('rect/magnet').removeAttr('text/pointer-events');
				}
			});			
			active_relation_button = relation_button_number;
		}
		
	}
	
	
	//========================================================================
	//=============    Scenario/Behaviour Buttons     ========================
	//========================================================================
	
	function drawScenarioBehaviourButtons(){
		if (window_state == 'scenario'){
			buttons_html_string = 	'<label id="scenario-button" class="btn scenario-behaviour-button active" onclick="changeWindowState(\'scenario\')">Scenario</label>' +
									'<label id="behaviour-button" class="btn scenario-behaviour-button" onclick="changeWindowState(\'behaviour\')">Behaviour</label>';
		} else {
			buttons_html_string = 	'<label id="scenario-button" class="btn scenario-behaviour-button" onclick="changeWindowState(\'scenario\')">Scenario</label>' +
									'<label id="behaviour-button" class="btn scenario-behaviour-button active" onclick="changeWindowState(\'behaviour\')">Behaviour</label>';
		}
	
		if (simulation_results_exist){
			buttons_html_string += 	'<label id="results-button" class="btn scenario-behaviour-button" onclick="openResultsInNewWindow()">Results</label>';
		}
		$('#scenario-behaviour-button-group').html(buttons_html_string)
	}



	function changeWindowState(new_state) {
		if (window_state != new_state) {
			window_state = new_state;
			
			if (new_state == 'scenario') {
				$('#scenario-button').attr('class','btn scenario-behaviour-button active');
				$('#behaviour-button').attr('class','btn scenario-behaviour-button');
				drawLeftPanel__scenario();
			} else {
				getObjectData();
				$('#scenario-button').attr('class','btn scenario-behaviour-button');
				$('#behaviour-button').attr('class','btn scenario-behaviour-button active');
				drawLeftPanel__behaviour();
				
				
				
			}
		}
	}
	
	function openResultsInNewWindow(){
		var url_components = window.location.href.split("/");
		var simulation_id = url_components[url_components.length - 2];
		var w = window.open("/tool/analyse_simulation/" + simulation_id + "/" + execution_order_id + "/");
	}
	
	//========================================================================
	//==================    THE PAPER      ==================================
	//========================================================================
	

	// Create the Paper    =============================================================================
	graph = new joint.dia.Graph();
	
	paper = new joint.dia.Paper({ 
		el: $('#paper'), 
		width: screen.width - 330, 
		height: screen.height - 70, 
		gridSize: 1, 
		model: graph 
	});


	
	// Drag & Drop objects into the Paper    =============================================================================
	 function allowDrop(ev) {
	  ev.preventDefault();
	}

	function drag(ev, object_type_id) {
	  ev.dataTransfer.setData("object_type_id", object_type_id);
	}

	function drop(ev) {
		var object_type_id = ev.dataTransfer.getData("object_type_id");

		var left_panel_width = parseInt($("#left-panel").css("width"),10);
		var x_coordinate = (ev.clientX-left_panel_width)-30;
		var y_coordinate = ev.clientY-90;

		createObject(object_type_id, x_coordinate, y_coordinate);
		
		ev.preventDefault();
	}
	
	// zoom the viewport by 50%
	//paper.scale(1.5,1.5);
	
	/*evt.stopPropagation();
	  if (confirm('Are you sure you want to delete this element?')) {
		  elementView.model.remove();
	  } */
	
	

	//========================================================================
	//==================   PAPER EVENTS     ==================================
	//========================================================================
	
	// Hover => Show/Hide Remove-buttons  =============================================================================
	var toolsView = new joint.dia.ToolsView({
		tools: [new joint.linkTools.Remove()]
	});

	paper.on('link:mouseenter', function(linkView) {
		if (window_state == 'scenario'){
			linkView.showTools();
		}
	});

	paper.on('link:mouseleave', function(linkView) {
		linkView.hideTools();
	});
	
	
	paper.on('element:mouseenter', function(elementView) {
		if (window_state == 'scenario'){
			var object_number = elementView.model.get('object_number');
			$('[model-id="' + object_number + '"] .element-tool-remove').css('display','inline-block');  //show the objects x-button
		}
	});

	paper.on('element:mouseleave', function(elementView) {
		var object_number = elementView.model.get('object_number');
		$('[model-id="' + object_number + '"] .element-tool-remove').css('display','none');  //hide the objects x-button
	});
	
	
	
	// Click on Object  =============================================================================
	paper.on('element:pointerup', function(elementView, evt) {
		var object_number = parseInt(elementView.model.get('object_number'));
		
		if (Object.keys(objects_dict).includes(String(object_number))) {
			//make the object on the paper purple
			elementView.model.attr({rect: { fill: '#9687fe', 'fill-opacity':'0.2'}})
			

			//draw the Right Sidebar Header ================================
			// draw the Icon  
			var object_icon = objects_dict[parseInt(object_number)]['object_icon'];
			$("#object-icon-button > img").attr('src','{% static "images/object_icons/" %}' + object_icon + '.svg');
			
			// draw the Icon Popover 
			popover_content = 	'<div class="object-icon-box">' +
									'<table>';
			for (var row = 0; row < Math.ceil(object_icons.length/8) ; row++) {
				popover_content += 	'<tr>';
				for (var column = 0; column < 8 ; column++) {
					icon_number = row*8 + column;
					if (icon_number < object_icons.length) {
						popover_content += '<td>' + 
												'<div class="small-object-icon" onclick="changeObjectIcon(' + object_number + ', &#39;' + object_icons[icon_number] + '&#39;)">' +
													'<img src="{% static "images/object_icons/" %}' + object_icons[icon_number] + '.svg" %}">' +
												'</div>' +
											'</td>';
					}
				}
				popover_content += 		'</tr>';
			}
			popover_content += 	'</table>' +
							'</div>';
			$("#object-icon-button").attr('data-content',popover_content);
			
			// write the Object Name  
			document.getElementById('object-name-field').value = objects_dict[object_number]['object_name'];
			document.getElementById('object-number-field').value = object_number;
			$("#object-name-field").attr('onchange', 'changeObjectName(' + object_number + ')');
		
			//draw the Right Sidebar Body  ================================
			if (window_state=='scenario') {
				drawObjectFilters(object_number);
			} else {
				drawObjectAttributeTable(object_number);
			}
			
			//show the right sidebar
			$('#right-sidebar-left-edge').css('display','block');
			$('#right-sidebar-head').css('display','block');
			$('#right-sidebar').animate({width: '415px'}, 200, 'linear');  
			
			if ($('#object-header-object-icon').length) {
				$('#object-header-object-icon').html('<img src="/static/images/object_icons/' + objects_dict[object_number]['object_icon'] + '.svg">');
				$('#object-header-object-name').html(objects_dict[object_number]['object_name']);
			}
		}
	});



	// Remove Object  ======================================================================================
	paper.on('element:removeclick', function(elementView, evt) {
		// remove from paper
		elementView.remove();
		
		var object_number = elementView.model.get('object_number');
		var object_type_id = objects_dict[object_number]['object_type_id']
		
		//remove incoming links
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			source_object_number = object_numbers[i];
			object_relations = objects_dict[source_object_number]['object_relations']
			if (typeof object_relations != 'undefined') {
				for (var j = 0; j < object_relations.length; j++) { 
					var target_object_number = object_relations[j]['target_object_number'];
					var attribute_id = object_relations[j]['attribute_id'];
					if (target_object_number == object_number) {
						var link_id = source_object_number + ',' + attribute_id + ',' + target_object_number;
						// remove link from paper
						graph.getCell(link_id).remove();       

						// remove link from objects_dict					
						objects_dict[source_object_number]['object_relations'].splice(j,1); 
						
					}
				}
			}
		}
		
		//remove outgoing links
		object_relations = objects_dict[object_number]['object_relations']
		if (typeof object_relations != 'undefined') {
			for (var j = 0; j < object_relations.length; j++) { 
				var target_object_number = object_relations[j]['target_object_number'];
				var attribute_id = object_relations[j]['attribute_id'];
				var link_id = object_number + ',' + attribute_id + ',' + target_object_number;
				// remove link from paper
				graph.getCell(link_id).remove();       
			}
			objects_dict[object_number]['object_relations'] = [];
		}
		
		// remove object from global variables
		delete objects_dict[object_number];
		total_object_count -= 1;
		object_type_counts[object_type_id] -= 1;
		if (object_type_counts[object_type_id] == 0) {delete object_type_counts[object_type_id];}
		
		// remove y0_values from this object
		for (var i = 0; i < y_value_attributes.length; i++) {
			if (y_value_attributes[i]['object_number'] == object_number) {
				y_value_attributes.splice(i, 1);
			}
		}
		
		get_new_object_data = true;
	});

	

	  
	  
	  
	//========================================================================
	//================   CREATE OBJECT	======================================
	//========================================================================
	
	
	//Add Object to objects_dict  ===============================================================================				
	function createObject(object_type_id, x_coordinate, y_coordinate) { 
	
		var object_type_name = available_object_types[object_type_id]['name'];
		var object_icon = available_object_types[object_type_id]['object_type_icon'];
		
		if (object_type_id in object_type_counts) {
			object_type_counts[object_type_id] += 1;
		} else {
			object_type_counts[object_type_id] = 1;
		}
		var object_name = object_type_name + ' ' + object_type_counts[object_type_id];
		
		total_object_count += 1;
		objects_dict[total_object_count] = {'object_name':object_name, 
									'object_type_id':object_type_id, 
									'object_type_name':object_type_name, 
									'object_icon':object_icon, 
									'object_id': null, 
									'object_attributes':{},
									'object_rules':{},
									'object_filter_facts':[],
									'object_relations': [],
									'position':{'x':x_coordinate, 'y':y_coordinate}};
		
		get_new_object_data = true;
		var object_number = total_object_count;
		addObjectToPaper(x_coordinate, y_coordinate, object_icon, object_type_id, object_type_name, object_number, object_name);
		
		// draw the object's relations at the left
		listTheAvailableRelations();
		
		
		//get the Object Rules
		getObjectRules(object_number, object_type_id);
		
	}
	
	
	
	
	//Def: Object Shape  ======================================================================================
	joint.shapes.basic.ObjectImage = joint.shapes.basic.Rect.extend({
		markup: ['<g class="rotatable" draggable="false">',
					'<image draggable="false"/>',
					'<text/>',
					'<g class="scalable" draggable="false">',
						'<rect/>',
					'</g>',
					'<g class="element-tool-remove">',
						'<circle fill="red" r="7" transform="translate(38, 0)" />',
						'<path transform="scale(.4) translate(78, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/>',
						'<title>Remove this element from the model</title>',
					'</g>',
				'</g>'].join(' '),
				
		defaults: joint.util.deepSupplement({
			type: 'basic.ObjectImage',
			size: { width: 43, height: 43 },
			attrs: {
				text: { 'ref-dy': -8},
				rect: { fill: '#ffffff', 'fill-opacity':'0.01', stroke: 'white' },
				image: {
					width: 43,
					height: 43,
					preserveAspectRatio: 'none',
					event: 'element:inspect',
				},
				'.element-tool-remove': {event: 'element:removeclick'}
			}

		}, joint.shapes.basic.Rect.prototype.defaults)
	});
	
	
	

	
	
	//Add Object to Paper  ======================================================================================
	function addObjectToPaper(x_coordinate, y_coordinate, object_icon, object_type_id, object_type_name, object_number, object_name) {
					
		//get svg_text from backend
	  	var xhttp = new XMLHttpRequest();       
		xhttp.open('GET', '{% static "images/object_icons/" %}' + object_icon + '.svg', false);
		xhttp.send();
		if (xhttp.readyState == 4 && xhttp.status == 200) {
		
			//create new shape on Paper
			var svg_text = xhttp.responseText.replace(/\n/g, '');
			
				var node = (new joint.shapes.basic.ObjectImage({
					id: object_number,
					position: { 
						x: x_coordinate,
						y: y_coordinate
					},
					attrs: {
						text: { text: object_name},
						image: {
							'xlink:href': 'data:image/svg+xml;utf8,' + encodeURIComponent(svg_text)
						}							
					},
					object_number: object_number,
					object_type_id: object_type_id,
					object_type_name: object_type_name
					
				})).addTo(graph);

		}

	}
	
	// Draw Links  ====================================================================================================
	
	// When a new link is created via UI (in Edit mode), remove the previous link
	// and create a new one that has the ID constructed as "nodeA,nodeB". The
	// reason we're removing the old link below is that it is not a good idea
	// to change ID's of any model in JointJS.
	graph.on('change:source change:target', function(link, collection, opt) {
		var sourceId = link.get('source').id;
		var targetId = link.get('target').id;
		var taget_has_correct_type = false;
		if(typeof targetId != 'undefined') {
			var target_object_type_id = objects_dict[targetId]['object_type_id'];
			taget_has_correct_type = available_relations[active_relation_button]['all_relation_object_types'].includes(target_object_type_id);
			
			if (opt.ui && sourceId && targetId && taget_has_correct_type) {
				new_relation = {'relation_name': available_relations[active_relation_button]['name'], 
								'attribute_id': available_relations[active_relation_button]['id'], 
								'target_object_number': targetId};
				link.remove();
				drawLink(sourceId, targetId, available_relations[active_relation_button]['id']);
				objects_dict[sourceId]['object_relations'].push(new_relation);
				get_new_object_data = true;
				
			} else {
				link.remove();
			}
		}

	});
	

	
	// Create a link 
	function drawLink(source, target, attribute_id) {
	
		new_link = (new joint.shapes.standard.Link({
			id: [source,attribute_id,target].join(),
			source: { id: source },
			target: { id: target },
			labels: [{ position: .5, attrs: { text: {	text: available_relations[active_relation_button]['name'] || '', 
														'font-weight': 'normal' } } }],
			attrs:  { line: { strokeWidth: 1}, 
					  'linktype': 'relation',
					  'attribute_id': attribute_id},
			vertices: []
		}))
		new_link.addTo(graph);
		
		linkView = new_link.findView(paper);
		linkView.addTools(toolsView);
		
		// uncheck the relation-button
		$('#relation-button' + String(active_relation_button)).removeClass("active");
		_.each(graph.getElements(), function(el) {
			el.removeAttr('rect/magnet').removeAttr('text/pointer-events');
		});
		active_relation_button = null;

	}
	
	
	// Remove Link  ====================================================================================================
	
	// remove links that are missing either source or target
	 paper.model.on('batch:stop', function () {
            var links = paper.model.getLinks();
            _.each(links, function (link) {
                var source = link.get('source');
                var target = link.get('target');
                if (source.id === undefined || target.id === undefined) {
                    link.remove();
                }
            });
        });
	
	
	// X-Button on the link -> remove link from data
	graph.on('remove', function(cell, collection, opt) {
		if (cell.isLink() && cell.attr('linktype')) {
			var sourceId = cell.get('source').id;
			var targetId = cell.get('target').id;
			var attribute_id = cell.attr('attribute_id');
			
			var object_relations = objects_dict[sourceId]['object_relations'];
			for (var j = 0; j < object_relations.length; j++) {
				var index_to_remove = null;
				if (object_relations[j]['target_object_number'] == targetId && object_relations[j]['attribute_id'] == attribute_id){
					index_to_remove = j;
				}
				if (index_to_remove != null) {
					object_relations.splice(index_to_remove,1);
					objects_dict[sourceId]['object_relations'] = object_relations;
					get_new_object_data = true;
				}
			}
		} 
	})
	


	
	//========================================================================
	//=================    RIGHT SIDEBAR    ==================================
	//========================================================================
	
	
	// hide the right sidebar if you click anywhere outside it   ----------
	$('body').on('mousedown', function (e) {
	
		if (['415px', '414px'].includes($('#right-sidebar').css('width'))) {
			var right_sidebar = document.getElementById('right-sidebar');
			var popover = document.getElementsByClassName('popover');
			var edit_object_behaviour_modal = document.getElementById('editObjectBehaviourModal');
			if (popover.length >0) {
				if ( e.target !== right_sidebar && !right_sidebar.contains(e.target) && !popover[0].contains(e.target) && !edit_object_behaviour_modal.contains(e.target) ) {  
					var object_number = document.getElementById('object-number-field').value;
					
					hide_right_sidebar();
					$('#object-icon-button').popover('hide');
					
					if (window_state=="scenario") {
						saveFilterFactChanges(object_number);
					} 
				}
			} else {
				if ( e.target !== right_sidebar && !right_sidebar.contains(e.target) && !edit_object_behaviour_modal.contains(e.target) ) {  
					var object_number = document.getElementById('object-number-field').value;
					
					hide_right_sidebar();
					$('#object-icon-button').popover('hide');
					
					if (window_state=="scenario") {
						saveFilterFactChanges(object_number);
					} 
				}
			}
		}
		
	});
	
	
	// hide the right sidebar    ----------------------------------------
	function hide_right_sidebar() {
		$('#right-sidebar').animate({width: '0px'}, 200, 'linear');
		$('#right-sidebar-left-edge').css('display','none');
		$('#right-sidebar-head').css('display','none');
		
		// if any of the objects on the paper is purple, turn it back to white
		_.each(graph.getElements(), function(el) {
			el.attr({rect: { fill: '#ffffff', 'fill-opacity':'0.01', stroke: 'white'}});
		});
	}
	
	
	// Save Changes ==========================================================
	function saveFilterFactChanges(object_number){
	
		if (Object.keys(objects_dict).includes(object_number)) {
			new_filter_facts = [];
		
			//for every filter-fact, get the attribute, operator and value and save to the object_dict
			for (var fact_number = 1; fact_number <= number_of_additional_object_facts; fact_number++) {
				
				new_fact = {};
				new_fact['attribute'] = $("#attribute-name" + fact_number).html();
				new_fact['attribute_id'] = $("#attribute" + fact_number).val();
				new_fact['operation'] = $("#operator" + fact_number).val();
				if (new_fact['operation'] == 'in'){
					new_fact['value'] = JSON.parse($("#value" + fact_number).val());
				} else {
					new_fact['value'] = $("#value" + fact_number).val();
				}
				var has_no_format_error = ($("#format_violation" + fact_number).attr("style") == "display:none;")
				
				if (new_fact['attribute'] != "" && new_fact['value'] != "" && has_no_format_error) {
					new_filter_facts.push(new_fact)
				}
			}
			var old_filter_facts = objects_dict[parseInt(object_number)]['object_filter_facts'];
			objects_dict[object_number]['object_filter_facts'] = new_filter_facts;
			
			if (JSON.stringify(new_filter_facts) != JSON.stringify(old_filter_facts)){
				get_new_object_data = true;
			}
		}
	}
	
	// Draw Right Sidebar ==============================================================
	function drawObjectFilters(object_number) {
	
		// object-header
		object_header_string = 	'<button type="button" id="object-icon-button" class="btn" style="display:inline-block;" data-container="body" data-toggle="popover" data-placement="bottom" data-html="true" title="Choose icon" data-content="">' +
									'<img src="/static/images/object_icons/' + objects_dict[object_number]['object_icon'] + '.svg">' +
								'</button>' +
								'<input type="text" class="form-control" id="object-name-field" name="object_name" placeholder="Object Name" value="' + objects_dict[object_number]['object_name'] + '" onchange="changeObjectName(' + object_number + ')" style="display:inline-block;width:300px">' +
								'<input type="hidden" id="object-number-field" value="' + object_number + '">';

		$('#object-header').html(object_header_string);
		
		
		// popover_content
		popover_content = 	'<div class="object-icon-box">' +
								'<table>';
		for (var row = 0; row < Math.ceil(object_icons.length/8) ; row++) {
			popover_content += 	'<tr>';
			for (var column = 0; column < 8 ; column++) {
				icon_number = row*8 + column;
				if (icon_number < object_icons.length) {
					popover_content += '<td>' + 
											'<div class="small-object-icon" onclick="changeObjectIcon(' + object_number + ', &#39;' + object_icons[icon_number] + '&#39;)">' +
												'<img src="{% static "images/object_icons/" %}' + object_icons[icon_number] + '.svg" %}">' +
											'</div>' +
										'</td>';
				}
			}
			popover_content += 		'</tr>';
		}
		popover_content += 	'</table>' +
						'</div>';
		$("#object-icon-button").attr('data-content',popover_content);
		$('#object-icon-button').popover(); 
			
	
		// object_filters
		object_filters_string = '<ul class="list-group" id="object_facts_list"> ' +
									'<li class="list-group-item broad new-fact-list-item" >' +
										'<div>' +
											'<div class="dropdown inline">' +
												'<button class="btn btn-secondary dropdown-toggle attribute-button" type="button" id="attributeMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name1">Attribute<span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>' +
												'<div class="dropdown-menu" aria-labelledby="attributeMenu1">' +
													'<div id="attributeList1">' +
														'<input type="text" class="search" id="dropDonwSearch1" onkeyup="filterAttributeDropDown(1)" placeholder=" Search">' +
														'<ul id="drop-down-display1" class="list-group drop-down-display"></ul>									' +
														'<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(1);">Reset</button>' +
													'</div>' +
												'</div>' +
											'</div>' +
											'<input type="hidden" id="attribute1" name="attribute1" value="">' +
											'<div class="form-group inline operator">' +
												'<select class="form-control form-control-lg" id="operator1" name="operator1">' +
													'<option value="=" selected>=</option>' +
													'<option value=">">></option>' +
													'<option value="<"><</option>' +
													'<option value="in">in</option>' +
												'</select>' +
											'</div> ' +
											'<div class="form-group inline value" onfocusout="checkAdditionalFactFormats()">' +
												'<input type="text" class="form-control" id="value1" name="value1" value="" size="15">' +
											'</div>' +
											'<button type="button" id="format_violation1" class="btn btn-danger format-violation" data-container="body" data-toggle="popover" data-placement="left" data-html="true" title="Invalid fact" style="display:none;" data-content="">!</button>' +
										'</div>' +
									'</li>' +
									'<li class="list-group-item broad new-fact-list-item" >' +
										'<div>' +
											'<div class="dropdown inline" >' +
												'<button class="btn btn-secondary dropdown-toggle attribute-button" type="button" id="attributeMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name2">Attribute<span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>' +
												'<div class="dropdown-menu" aria-labelledby="attributeMenu2">' +
													'<div id="attributeList2">' +
														'<input type="text" class="search" id="dropDonwSearch2" onkeyup="filterAttributeDropDown(2)" placeholder=" Search">' +
														'<ul id="drop-down-display2" class="list-group drop-down-display"></ul>									' +
														'<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(2);">Reset</button>' +
													'</div>' +
												'</div>' +
											'</div>' +
											'<input type="hidden" id="attribute2" name="attribute2" value="">' +
											'<div class="form-group inline operator">' +
												'<select class="form-control form-control-lg" id="operator2" name="operator2">' +
													'<option value="=" selected>=</option>' +
													'<option value=">">></option>' +
													'<option value="<"><</option>' +
													'<option value="in">in</option>' +
												'</select>' +
											'</div> ' +
											'<div class="form-group inline value" onfocusout="checkAdditionalFactFormats()">' +
												'<input type="text" class="form-control" id="value2" name="value2" value="" size="15">' +
											'</div>' +
											'<button type="button" id="format_violation2" class="btn btn-danger format-violation" data-container="body" data-toggle="popover" data-placement="left" data-html="true" title="Invalid fact" style="display:none;" data-content="">!</button>' +
										'</div>' +
									'</li>' +
									'<li class="list-group-item narrow" id="create-new-object-fact-button">' +
										'<button id="make-new-additional-fact-button" type="button" class="btn btn-outline-dark plus-button" onclick="newAdditionalFactInput(\'all\');" ><i class="fas fa-plus"></i></button> ' +
									'</li>' +
								'</ul>';
								
		$("#right-sidebar-body").html(object_filters_string);
		
		number_of_additional_object_facts = 2;
		var filter_facts = objects_dict[object_number]['object_filter_facts'];
		var object_type_id = objects_dict[object_number]['object_type_id'];
		
		// if required: make additional fact input rows
		$("#make-new-additional-fact-button").attr("onclick", "newAdditionalFactInput('" + object_type_id + "');"); //for the "+"-button change it so that the new attribute-drop-downs will list the object-types attributes
		var additionally_needed_fact_inputs = filter_facts.length - number_of_additional_object_facts;
		if (additionally_needed_fact_inputs > 0){
			for(var i = 0; i < additionally_needed_fact_inputs; i++) {
				document.getElementById("make-new-additional-fact-button").click();
			}
		}
		
		//populate the attribute drop downs
		for (var i = 1; i <= number_of_additional_object_facts; i++) {
			makeObjectsAdditionalAttributesDropdownEditSimulation( object_type_id , i);
		}
		
		//activate the popovers
		$('.format-violation').popover(); 
		
		//set the values for all the facts
		for(var i = 0; i < filter_facts.length; i++) {
			$("#attribute-name" + (i+1)).html(filter_facts[i]['attribute']);
			$("#attribute" + (i+1)).val(filter_facts[i]['attribute_id']);
			$("#operator" + (i+1)).val(filter_facts[i]['operation']);
			$("#value" + (i+1)).val(filter_facts[i]['value']);
		} 
		
	}
	
	

	
	// '+'-Button ==============================================================
	function newAdditionalFactInput(object_type_id) { 
	
		number_of_additional_object_facts += 1;
		fact_number = number_of_additional_object_facts;
		var insert_before = '#create-new-object-fact-button';

		
		var additionalFactHTMLString = 	'<li class="list-group-item broad new-fact-list-item" >' +
											'<div">' + 
												'<div class="dropdown inline" >' + 
													'<button class="btn btn-secondary dropdown-toggle attribute-button" type="button" id="attributeMenu' + fact_number + '" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name' + fact_number + '">Attribute<span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>' + 
													'<div class="dropdown-menu" aria-labelledby="attributeMenu' + fact_number + '">' + 
														'<div id="attributeList' + fact_number + '">' + 
															'<input type="text" class="search" id="dropDonwSearch' + fact_number + '" onkeyup="filterAttributeDropDown(' + fact_number + ')" placeholder=" Search">' +
															'<ul id="drop-down-display' + fact_number + '" class="list list-group drop-down-display"></ul>' +															
															'<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(' + fact_number + ');">Reset</button>' +
														'</div>' + 
													'</div>' + 
												'</div>' + 
												'<input type="hidden" id="attribute' + fact_number + '" name="attribute' + fact_number + '" value="">' + 
												'<div class="form-group inline operator">' + 
													'<select class="form-control form-control-lg" id="operator' + fact_number + '" name="operator' + fact_number + '">' + 
														'<option value="=" selected>=</option>' + 
														'<option value=">">></option>' + 
														'<option value="<"><</option>' + 
														'<option value="in">in</option>' +
													'</select>' + 
												'</div> ' + 
												'<div class="form-group inline value" onfocusout="checkAdditionalFactFormats()">' + 
													'<input type="text" class="form-control" id="value' + fact_number + '" name="value' + fact_number + '" size="15">' + 
												'</div>' + 
											'</div>' +
											'<button type="button" id="format_violation' + fact_number + '" class="btn btn-danger format-violation" data-container="body" data-toggle="popover" data-placement="left" data-html="true" title="Invalid fact" style="display:none;" data-content="">!</button>' +
										'</li>';
		$(additionalFactHTMLString).insertBefore(insert_before);
		
		makeObjectsAdditionalAttributesDropdownEditSimulation(object_type_id, fact_number);
	}
		
	
	
	
	

	
	

	
	//========================================================================
	//================   CHANGE OBJECT	======================================
	//========================================================================
	
	function changeObjectIcon(object_number, object_icon) {
		//change in Right Sidebar
		$("#object-icon-button > img").attr('src','{% static "images/object_icons/" %}' + object_icon + '.svg');
		
		//change in Object_Dict
		objects_dict[object_number]['object_icon'] = object_icon;
		
		//change on Paper
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				var svg_text = this.responseText.replace(/\n/g, '');
				cell = graph.getCell(object_number); 
				cell.attr('image/xlink:href', 'data:image/svg+xml;utf8,' + encodeURIComponent(svg_text));
				/*var cells = graph.getCells();
				for (var i = 0; i < cells.length; i++) {
					if (cells[i]['attributes']['object_number'] == object_number) {
						cells[i].attr('image/xlink:href', 'data:image/svg+xml;utf8,' + encodeURIComponent(svg_text));
					}
				}*/
			}
		};
		xhttp.open('GET', '{% static "images/object_icons/" %}' + object_icon + '.svg', true);
		xhttp.send();
		
		
	}
	
	function changeObjectName(object_number) {
		object_name = $('#object-name-field').val();
		objects_dict[object_number]['object_name'] = object_name;
		
		cell = graph.getCell(object_number); 
		cell.attr('text/text', object_name);
				
					
	}
	
	
	//========================================================================
	//========================    MAIN      ==================================
	//========================================================================
	
	
	
	
	
	 // Remove the resizable-ness, because it only works in very few jquery versions, which in turn cause trouble elsewhere
	// make the Left Panel resizable
	 $("#left-panel").resizable({
	   handleSelector: "#splitter",
	   resizeHeight: false
	 });

	 $("#right-panel").resizable({
	   handleSelector: ".splitter-horizontal",
	   resizeWidth: false
	 });
	 
	 

	// activate the Object Icon Popover
	$(document).ready(function(){
		$('#object-icon-button').popover();   
	});
	
		
	
		
	// draw the Left Panel
	window.onload = function() {
	
		drawScenarioBehaviourButtons();
	
		// load js/datepicker/bootstrap-datetimepicker.min.js, because it doesn't load correctly if the document is not ready (no idea why!!!)
		(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{if(typeof exports==="object"){a(require("jquery"))}else{a(jQuery)}}}(function(d,f){if(!("indexOf" in Array.prototype)){Array.prototype.indexOf=function(k,j){if(j===f){j=0}if(j<0){j+=this.length}if(j<0){j=0}for(var l=this.length;j<l;j++){if(j in this&&this[j]===k){return j}}return -1}}function a(){var q,k,p,l,j,n,m,o;k=(new Date()).toString();p=((m=k.split("(")[1])!=null?m.slice(0,-1):0)||k.split(" ");if(p instanceof Array){n=[];for(var l=0,j=p.length;l<j;l++){o=p[l];if((q=(m=o.match(/\b[A-Z]+\b/))!==null)?m[0]:0){n.push(q)}}p=n.pop()}return p}function h(){return new Date(Date.UTC.apply(Date,arguments))}var g=function(k,j){var m=this;this.element=d(k);this.container=j.container||"body";this.language=j.language||this.element.data("date-language")||"en";this.language=this.language in e?this.language:this.language.split("-")[0];this.language=this.language in e?this.language:"en";this.isRTL=e[this.language].rtl||false;this.formatType=j.formatType||this.element.data("format-type")||"standard";this.format=c.parseFormat(j.format||this.element.data("date-format")||e[this.language].format||c.getDefaultFormat(this.formatType,"input"),this.formatType);this.isInline=false;this.isVisible=false;this.isInput=this.element.is("input");this.fontAwesome=j.fontAwesome||this.element.data("font-awesome")||false;this.bootcssVer=j.bootcssVer||(this.isInput?(this.element.is(".form-control")?3:2):(this.bootcssVer=this.element.is(".input-group")?3:2));this.component=this.element.is(".date")?(this.bootcssVer===3?this.element.find(".input-group-addon .glyphicon-th, .input-group-addon .glyphicon-time, .input-group-addon .glyphicon-remove, .input-group-addon .glyphicon-calendar, .input-group-addon .fa-calendar, .input-group-addon .fa-clock-o").parent():this.element.find(".add-on .icon-th, .add-on .icon-time, .add-on .icon-calendar, .add-on .fa-calendar, .add-on .fa-clock-o").parent()):false;this.componentReset=this.element.is(".date")?(this.bootcssVer===3?this.element.find(".input-group-addon .glyphicon-remove, .input-group-addon .fa-times").parent():this.element.find(".add-on .icon-remove, .add-on .fa-times").parent()):false;this.hasInput=this.component&&this.element.find("input").length;if(this.component&&this.component.length===0){this.component=false}this.linkField=j.linkField||this.element.data("link-field")||false;this.linkFormat=c.parseFormat(j.linkFormat||this.element.data("link-format")||c.getDefaultFormat(this.formatType,"link"),this.formatType);this.minuteStep=j.minuteStep||this.element.data("minute-step")||5;this.pickerPosition=j.pickerPosition||this.element.data("picker-position")||"bottom-right";this.showMeridian=j.showMeridian||this.element.data("show-meridian")||false;this.initialDate=j.initialDate||new Date();this.zIndex=j.zIndex||this.element.data("z-index")||f;this.title=typeof j.title==="undefined"?false:j.title;this.timezone=j.timezone||a();this.icons={leftArrow:this.fontAwesome?"fa-arrow-left":(this.bootcssVer===3?"glyphicon-arrow-left":"icon-arrow-left"),rightArrow:this.fontAwesome?"fa-arrow-right":(this.bootcssVer===3?"glyphicon-arrow-right":"icon-arrow-right")};this.icontype=this.fontAwesome?"fa":"glyphicon";this._attachEvents();this.clickedOutside=function(n){if(d(n.target).closest(".datetimepicker").length===0){m.hide()}};this.formatViewType="datetime";if("formatViewType" in j){this.formatViewType=j.formatViewType}else{if("formatViewType" in this.element.data()){this.formatViewType=this.element.data("formatViewType")}}this.minView=0;if("minView" in j){this.minView=j.minView}else{if("minView" in this.element.data()){this.minView=this.element.data("min-view")}}this.minView=c.convertViewMode(this.minView);this.maxView=c.modes.length-1;if("maxView" in j){this.maxView=j.maxView}else{if("maxView" in this.element.data()){this.maxView=this.element.data("max-view")}}this.maxView=c.convertViewMode(this.maxView);this.wheelViewModeNavigation=false;if("wheelViewModeNavigation" in j){this.wheelViewModeNavigation=j.wheelViewModeNavigation}else{if("wheelViewModeNavigation" in this.element.data()){this.wheelViewModeNavigation=this.element.data("view-mode-wheel-navigation")}}this.wheelViewModeNavigationInverseDirection=false;if("wheelViewModeNavigationInverseDirection" in j){this.wheelViewModeNavigationInverseDirection=j.wheelViewModeNavigationInverseDirection}else{if("wheelViewModeNavigationInverseDirection" in this.element.data()){this.wheelViewModeNavigationInverseDirection=this.element.data("view-mode-wheel-navigation-inverse-dir")}}this.wheelViewModeNavigationDelay=100;if("wheelViewModeNavigationDelay" in j){this.wheelViewModeNavigationDelay=j.wheelViewModeNavigationDelay}else{if("wheelViewModeNavigationDelay" in this.element.data()){this.wheelViewModeNavigationDelay=this.element.data("view-mode-wheel-navigation-delay")}}this.startViewMode=2;if("startView" in j){this.startViewMode=j.startView}else{if("startView" in this.element.data()){this.startViewMode=this.element.data("start-view")}}this.startViewMode=c.convertViewMode(this.startViewMode);this.viewMode=this.startViewMode;this.viewSelect=this.minView;if("viewSelect" in j){this.viewSelect=j.viewSelect}else{if("viewSelect" in this.element.data()){this.viewSelect=this.element.data("view-select")}}this.viewSelect=c.convertViewMode(this.viewSelect);this.forceParse=true;if("forceParse" in j){this.forceParse=j.forceParse}else{if("dateForceParse" in this.element.data()){this.forceParse=this.element.data("date-force-parse")}}var l=this.bootcssVer===3?c.templateV3:c.template;while(l.indexOf("{iconType}")!==-1){l=l.replace("{iconType}",this.icontype)}while(l.indexOf("{leftArrow}")!==-1){l=l.replace("{leftArrow}",this.icons.leftArrow)}while(l.indexOf("{rightArrow}")!==-1){l=l.replace("{rightArrow}",this.icons.rightArrow)}this.picker=d(l).appendTo(this.isInline?this.element:this.container).on({click:d.proxy(this.click,this),mousedown:d.proxy(this.mousedown,this)});if(this.wheelViewModeNavigation){if(d.fn.mousewheel){this.picker.on({mousewheel:d.proxy(this.mousewheel,this)})}else{console.log("Mouse Wheel event is not supported. Please include the jQuery Mouse Wheel plugin before enabling this option")}}if(this.isInline){this.picker.addClass("datetimepicker-inline")}else{this.picker.addClass("datetimepicker-dropdown-"+this.pickerPosition+" dropdown-menu")}if(this.isRTL){this.picker.addClass("datetimepicker-rtl");var i=this.bootcssVer===3?".prev span, .next span":".prev i, .next i";this.picker.find(i).toggleClass(this.icons.leftArrow+" "+this.icons.rightArrow)}d(document).on("mousedown touchend",this.clickedOutside);this.autoclose=false;if("autoclose" in j){this.autoclose=j.autoclose}else{if("dateAutoclose" in this.element.data()){this.autoclose=this.element.data("date-autoclose")}}this.keyboardNavigation=true;if("keyboardNavigation" in j){this.keyboardNavigation=j.keyboardNavigation}else{if("dateKeyboardNavigation" in this.element.data()){this.keyboardNavigation=this.element.data("date-keyboard-navigation")}}this.todayBtn=(j.todayBtn||this.element.data("date-today-btn")||false);this.clearBtn=(j.clearBtn||this.element.data("date-clear-btn")||false);this.todayHighlight=(j.todayHighlight||this.element.data("date-today-highlight")||false);this.weekStart=0;if(typeof j.weekStart!=="undefined"){this.weekStart=j.weekStart}else{if(typeof this.element.data("date-weekstart")!=="undefined"){this.weekStart=this.element.data("date-weekstart")}else{if(typeof e[this.language].weekStart!=="undefined"){this.weekStart=e[this.language].weekStart}}}this.weekStart=this.weekStart%7;this.weekEnd=((this.weekStart+6)%7);this.onRenderDay=function(n){var p=(j.onRenderDay||function(){return[]})(n);if(typeof p==="string"){p=[p]}var o=["day"];return o.concat((p?p:[]))};this.onRenderHour=function(n){var p=(j.onRenderHour||function(){return[]})(n);var o=["hour"];if(typeof p==="string"){p=[p]}return o.concat((p?p:[]))};this.onRenderMinute=function(n){var p=(j.onRenderMinute||function(){return[]})(n);var o=["minute"];if(typeof p==="string"){p=[p]}if(n<this.startDate||n>this.endDate){o.push("disabled")}else{if(Math.floor(this.date.getUTCMinutes()/this.minuteStep)===Math.floor(n.getUTCMinutes()/this.minuteStep)){o.push("active")}}return o.concat((p?p:[]))};this.onRenderYear=function(o){var q=(j.onRenderYear||function(){return[]})(o);var p=["year"];if(typeof q==="string"){q=[q]}if(this.date.getUTCFullYear()===o.getUTCFullYear()){p.push("active")}var n=o.getUTCFullYear();var r=this.endDate.getUTCFullYear();if(o<this.startDate||n>r){p.push("disabled")}return p.concat((q?q:[]))};this.onRenderMonth=function(n){var p=(j.onRenderMonth||function(){return[]})(n);var o=["month"];if(typeof p==="string"){p=[p]}return o.concat((p?p:[]))};this.startDate=new Date(-8639968443048000);this.endDate=new Date(8639968443048000);this.datesDisabled=[];this.daysOfWeekDisabled=[];this.setStartDate(j.startDate||this.element.data("date-startdate"));this.setEndDate(j.endDate||this.element.data("date-enddate"));this.setDatesDisabled(j.datesDisabled||this.element.data("date-dates-disabled"));this.setDaysOfWeekDisabled(j.daysOfWeekDisabled||this.element.data("date-days-of-week-disabled"));this.setMinutesDisabled(j.minutesDisabled||this.element.data("date-minute-disabled"));this.setHoursDisabled(j.hoursDisabled||this.element.data("date-hour-disabled"));this.fillDow();this.fillMonths();this.update();this.showMode();if(this.isInline){this.show()}};g.prototype={constructor:g,_events:[],_attachEvents:function(){this._detachEvents();if(this.isInput){this._events=[[this.element,{focus:d.proxy(this.show,this),keyup:d.proxy(this.update,this),keydown:d.proxy(this.keydown,this)}]]}else{if(this.component&&this.hasInput){this._events=[[this.element.find("input"),{focus:d.proxy(this.show,this),keyup:d.proxy(this.update,this),keydown:d.proxy(this.keydown,this)}],[this.component,{click:d.proxy(this.show,this)}]];if(this.componentReset){this._events.push([this.componentReset,{click:d.proxy(this.reset,this)}])}}else{if(this.element.is("div")){this.isInline=true}else{this._events=[[this.element,{click:d.proxy(this.show,this)}]]}}}for(var j=0,k,l;j<this._events.length;j++){k=this._events[j][0];l=this._events[j][1];k.on(l)}},_detachEvents:function(){for(var j=0,k,l;j<this._events.length;j++){k=this._events[j][0];l=this._events[j][1];k.off(l)}this._events=[]},show:function(i){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();if(this.forceParse){this.update()}this.place();d(window).on("resize",d.proxy(this.place,this));if(i){i.stopPropagation();i.preventDefault()}this.isVisible=true;this.element.trigger({type:"show",date:this.date})},hide:function(){if(!this.isVisible){return}if(this.isInline){return}this.picker.hide();d(window).off("resize",this.place);this.viewMode=this.startViewMode;this.showMode();if(!this.isInput){d(document).off("mousedown",this.hide)}if(this.forceParse&&(this.isInput&&this.element.val()||this.hasInput&&this.element.find("input").val())){this.setValue()}this.isVisible=false;this.element.trigger({type:"hide",date:this.date})},remove:function(){this._detachEvents();d(document).off("mousedown",this.clickedOutside);this.picker.remove();delete this.picker;delete this.element.data().datetimepicker},getDate:function(){var i=this.getUTCDate();if(i===null){return null}return new Date(i.getTime()+(i.getTimezoneOffset()*60000))},getUTCDate:function(){return this.date},getInitialDate:function(){return this.initialDate},setInitialDate:function(i){this.initialDate=i},setDate:function(i){this.setUTCDate(new Date(i.getTime()-(i.getTimezoneOffset()*60000)))},setUTCDate:function(i){if(i>=this.startDate&&i<=this.endDate){this.date=i;this.setValue();this.viewDate=this.date;this.fill()}else{this.element.trigger({type:"outOfRange",date:i,startDate:this.startDate,endDate:this.endDate})}},setFormat:function(j){this.format=c.parseFormat(j,this.formatType);var i;if(this.isInput){i=this.element}else{if(this.component){i=this.element.find("input")}}if(i&&i.val()){this.setValue()}},setValue:function(){var i=this.getFormattedDate();if(!this.isInput){if(this.component){this.element.find("input").val(i)}this.element.data("date",i)}else{this.element.val(i)}if(this.linkField){d("#"+this.linkField).val(this.getFormattedDate(this.linkFormat))}},getFormattedDate:function(i){i=i||this.format;return c.formatDate(this.date,i,this.language,this.formatType,this.timezone)},setStartDate:function(i){this.startDate=i||this.startDate;if(this.startDate.valueOf()!==8639968443048000){this.startDate=c.parseDate(this.startDate,this.format,this.language,this.formatType,this.timezone)}this.update();this.updateNavArrows()},setEndDate:function(i){this.endDate=i||this.endDate;if(this.endDate.valueOf()!==8639968443048000){this.endDate=c.parseDate(this.endDate,this.format,this.language,this.formatType,this.timezone)}this.update();this.updateNavArrows()},setDatesDisabled:function(j){this.datesDisabled=j||[];if(!d.isArray(this.datesDisabled)){this.datesDisabled=this.datesDisabled.split(/,\s*/)}var i=this;this.datesDisabled=d.map(this.datesDisabled,function(k){return c.parseDate(k,i.format,i.language,i.formatType,i.timezone).toDateString()});this.update();this.updateNavArrows()},setTitle:function(i,j){return this.picker.find(i).find("th:eq(1)").text(this.title===false?j:this.title)},setDaysOfWeekDisabled:function(i){this.daysOfWeekDisabled=i||[];if(!d.isArray(this.daysOfWeekDisabled)){this.daysOfWeekDisabled=this.daysOfWeekDisabled.split(/,\s*/)}this.daysOfWeekDisabled=d.map(this.daysOfWeekDisabled,function(j){return parseInt(j,10)});this.update();this.updateNavArrows()},setMinutesDisabled:function(i){this.minutesDisabled=i||[];if(!d.isArray(this.minutesDisabled)){this.minutesDisabled=this.minutesDisabled.split(/,\s*/)}this.minutesDisabled=d.map(this.minutesDisabled,function(j){return parseInt(j,10)});this.update();this.updateNavArrows()},setHoursDisabled:function(i){this.hoursDisabled=i||[];if(!d.isArray(this.hoursDisabled)){this.hoursDisabled=this.hoursDisabled.split(/,\s*/)}this.hoursDisabled=d.map(this.hoursDisabled,function(j){return parseInt(j,10)});this.update();this.updateNavArrows()},place:function(){if(this.isInline){return}if(!this.zIndex){var j=0;d("div").each(function(){var o=parseInt(d(this).css("zIndex"),10);if(o>j){j=o}});this.zIndex=j+10}var n,m,l,k;if(this.container instanceof d){k=this.container.offset()}else{k=d(this.container).offset()}if(this.component){n=this.component.offset();l=n.left;if(this.pickerPosition==="bottom-left"||this.pickerPosition==="top-left"){l+=this.component.outerWidth()-this.picker.outerWidth()}}else{n=this.element.offset();l=n.left;if(this.pickerPosition==="bottom-left"||this.pickerPosition==="top-left"){l+=this.element.outerWidth()-this.picker.outerWidth()}}var i=document.body.clientWidth||window.innerWidth;if(l+220>i){l=i-220}if(this.pickerPosition==="top-left"||this.pickerPosition==="top-right"){m=n.top-this.picker.outerHeight()}else{m=n.top+this.height}m=m-k.top;l=l-k.left;this.picker.css({top:m,left:l,zIndex:this.zIndex})},hour_minute:"^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]",update:function(){var i,j=false;if(arguments&&arguments.length&&(typeof arguments[0]==="string"||arguments[0] instanceof Date)){i=arguments[0];j=true}else{i=(this.isInput?this.element.val():this.element.find("input").val())||this.element.data("date")||this.initialDate;if(typeof i==="string"){i=i.replace(/^\s+|\s+$/g,"")}}if(!i){i=new Date();j=false}if(typeof i==="string"){if(new RegExp(this.hour_minute).test(i)||new RegExp(this.hour_minute+":[0-5][0-9]").test(i)){i=this.getDate()}}this.date=c.parseDate(i,this.format,this.language,this.formatType,this.timezone);if(j){this.setValue()}if(this.date<this.startDate){this.viewDate=new Date(this.startDate)}else{if(this.date>this.endDate){this.viewDate=new Date(this.endDate)}else{this.viewDate=new Date(this.date)}}this.fill()},fillDow:function(){var i=this.weekStart,j="<tr>";while(i<this.weekStart+7){j+='<th class="dow">'+e[this.language].daysMin[(i++)%7]+"</th>"}j+="</tr>";this.picker.find(".datetimepicker-days thead").append(j)},fillMonths:function(){var l="";var m=new Date(this.viewDate);for(var k=0;k<12;k++){m.setUTCMonth(k);var j=this.onRenderMonth(m);l+='<span class="'+j.join(" ")+'">'+e[this.language].monthsShort[k]+"</span>"}this.picker.find(".datetimepicker-months td").html(l)},fill:function(){if(!this.date||!this.viewDate){return}var E=new Date(this.viewDate),t=E.getUTCFullYear(),G=E.getUTCMonth(),n=E.getUTCDate(),A=E.getUTCHours(),w=this.startDate.getUTCFullYear(),B=this.startDate.getUTCMonth(),p=this.endDate.getUTCFullYear(),x=this.endDate.getUTCMonth()+1,q=(new h(this.date.getUTCFullYear(),this.date.getUTCMonth(),this.date.getUTCDate())).valueOf(),D=new Date();this.setTitle(".datetimepicker-days",e[this.language].months[G]+" "+t);if(this.formatViewType==="time"){var k=this.getFormattedDate();this.setTitle(".datetimepicker-hours",k);this.setTitle(".datetimepicker-minutes",k)}else{this.setTitle(".datetimepicker-hours",n+" "+e[this.language].months[G]+" "+t);this.setTitle(".datetimepicker-minutes",n+" "+e[this.language].months[G]+" "+t)}this.picker.find("tfoot th.today").text(e[this.language].today||e.en.today).toggle(this.todayBtn!==false);this.picker.find("tfoot th.clear").text(e[this.language].clear||e.en.clear).toggle(this.clearBtn!==false);this.updateNavArrows();this.fillMonths();var I=h(t,G-1,28,0,0,0,0),z=c.getDaysInMonth(I.getUTCFullYear(),I.getUTCMonth());I.setUTCDate(z);I.setUTCDate(z-(I.getUTCDay()-this.weekStart+7)%7);var j=new Date(I);j.setUTCDate(j.getUTCDate()+42);j=j.valueOf();var r=[];var F;while(I.valueOf()<j){if(I.getUTCDay()===this.weekStart){r.push("<tr>")}F=this.onRenderDay(I);if(I.getUTCFullYear()<t||(I.getUTCFullYear()===t&&I.getUTCMonth()<G)){F.push("old")}else{if(I.getUTCFullYear()>t||(I.getUTCFullYear()===t&&I.getUTCMonth()>G)){F.push("new")}}if(this.todayHighlight&&I.getUTCFullYear()===D.getFullYear()&&I.getUTCMonth()===D.getMonth()&&I.getUTCDate()===D.getDate()){F.push("today")}if(I.valueOf()===q){F.push("active")}if((I.valueOf()+86400000)<=this.startDate||I.valueOf()>this.endDate||d.inArray(I.getUTCDay(),this.daysOfWeekDisabled)!==-1||d.inArray(I.toDateString(),this.datesDisabled)!==-1){F.push("disabled")}r.push('<td class="'+F.join(" ")+'">'+I.getUTCDate()+"</td>");if(I.getUTCDay()===this.weekEnd){r.push("</tr>")}I.setUTCDate(I.getUTCDate()+1)}this.picker.find(".datetimepicker-days tbody").empty().append(r.join(""));r=[];var u="",C="",s="";var l=this.hoursDisabled||[];E=new Date(this.viewDate);for(var y=0;y<24;y++){E.setUTCHours(y);F=this.onRenderHour(E);if(l.indexOf(y)!==-1){F.push("disabled")}var v=h(t,G,n,y);if((v.valueOf()+3600000)<=this.startDate||v.valueOf()>this.endDate){F.push("disabled")}else{if(A===y){F.push("active")}}if(this.showMeridian&&e[this.language].meridiem.length===2){C=(y<12?e[this.language].meridiem[0]:e[this.language].meridiem[1]);if(C!==s){if(s!==""){r.push("</fieldset>")}r.push('<fieldset class="hour"><legend>'+C.toUpperCase()+"</legend>")}s=C;u=(y%12?y%12:12);if(y<12){F.push("hour_am")}else{F.push("hour_pm")}r.push('<span class="'+F.join(" ")+'">'+u+"</span>");if(y===23){r.push("</fieldset>")}}else{u=y+":00";r.push('<span class="'+F.join(" ")+'">'+u+"</span>")}}this.picker.find(".datetimepicker-hours td").html(r.join(""));r=[];u="";C="";s="";var m=this.minutesDisabled||[];E=new Date(this.viewDate);for(var y=0;y<60;y+=this.minuteStep){if(m.indexOf(y)!==-1){continue}E.setUTCMinutes(y);E.setUTCSeconds(0);F=this.onRenderMinute(E);if(this.showMeridian&&e[this.language].meridiem.length===2){C=(A<12?e[this.language].meridiem[0]:e[this.language].meridiem[1]);if(C!==s){if(s!==""){r.push("</fieldset>")}r.push('<fieldset class="minute"><legend>'+C.toUpperCase()+"</legend>")}s=C;u=(A%12?A%12:12);r.push('<span class="'+F.join(" ")+'">'+u+":"+(y<10?"0"+y:y)+"</span>");if(y===59){r.push("</fieldset>")}}else{u=y+":00";r.push('<span class="'+F.join(" ")+'">'+A+":"+(y<10?"0"+y:y)+"</span>")}}this.picker.find(".datetimepicker-minutes td").html(r.join(""));var J=this.date.getUTCFullYear();var o=this.setTitle(".datetimepicker-months",t).end().find(".month").removeClass("active");if(J===t){o.eq(this.date.getUTCMonth()).addClass("active")}if(t<w||t>p){o.addClass("disabled")}if(t===w){o.slice(0,B).addClass("disabled")}if(t===p){o.slice(x).addClass("disabled")}r="";t=parseInt(t/10,10)*10;var H=this.setTitle(".datetimepicker-years",t+"-"+(t+9)).end().find("td");t-=1;E=new Date(this.viewDate);for(var y=-1;y<11;y++){E.setUTCFullYear(t);F=this.onRenderYear(E);if(y===-1||y===10){F.push(b)}r+='<span class="'+F.join(" ")+'">'+t+"</span>";t+=1}H.html(r);this.place()},updateNavArrows:function(){var m=new Date(this.viewDate),k=m.getUTCFullYear(),l=m.getUTCMonth(),j=m.getUTCDate(),i=m.getUTCHours();switch(this.viewMode){case 0:if(k<=this.startDate.getUTCFullYear()&&l<=this.startDate.getUTCMonth()&&j<=this.startDate.getUTCDate()&&i<=this.startDate.getUTCHours()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()&&l>=this.endDate.getUTCMonth()&&j>=this.endDate.getUTCDate()&&i>=this.endDate.getUTCHours()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break;case 1:if(k<=this.startDate.getUTCFullYear()&&l<=this.startDate.getUTCMonth()&&j<=this.startDate.getUTCDate()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()&&l>=this.endDate.getUTCMonth()&&j>=this.endDate.getUTCDate()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break;case 2:if(k<=this.startDate.getUTCFullYear()&&l<=this.startDate.getUTCMonth()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()&&l>=this.endDate.getUTCMonth()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break;case 3:case 4:if(k<=this.startDate.getUTCFullYear()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break}},mousewheel:function(j){j.preventDefault();j.stopPropagation();if(this.wheelPause){return}this.wheelPause=true;var i=j.originalEvent;var l=i.wheelDelta;var k=l>0?1:(l===0)?0:-1;if(this.wheelViewModeNavigationInverseDirection){k=-k}this.showMode(k);setTimeout(d.proxy(function(){this.wheelPause=false},this),this.wheelViewModeNavigationDelay)},click:function(m){m.stopPropagation();m.preventDefault();var n=d(m.target).closest("span, td, th, legend");if(n.is("."+this.icontype)){n=d(n).parent().closest("span, td, th, legend")}if(n.length===1){if(n.is(".disabled")){this.element.trigger({type:"outOfRange",date:this.viewDate,startDate:this.startDate,endDate:this.endDate});return}switch(n[0].nodeName.toLowerCase()){case"th":switch(n[0].className){case"switch":this.showMode(1);break;case"prev":case"next":var i=c.modes[this.viewMode].navStep*(n[0].className==="prev"?-1:1);switch(this.viewMode){case 0:this.viewDate=this.moveHour(this.viewDate,i);break;case 1:this.viewDate=this.moveDate(this.viewDate,i);break;case 2:this.viewDate=this.moveMonth(this.viewDate,i);break;case 3:case 4:this.viewDate=this.moveYear(this.viewDate,i);break}this.fill();this.element.trigger({type:n[0].className+":"+this.convertViewModeText(this.viewMode),date:this.viewDate,startDate:this.startDate,endDate:this.endDate});break;case"clear":this.reset();if(this.autoclose){this.hide()}break;case"today":var j=new Date();j=h(j.getFullYear(),j.getMonth(),j.getDate(),j.getHours(),j.getMinutes(),j.getSeconds(),0);if(j<this.startDate){j=this.startDate}else{if(j>this.endDate){j=this.endDate}}this.viewMode=this.startViewMode;this.showMode(0);this._setDate(j);this.fill();if(this.autoclose){this.hide()}break}break;case"span":if(!n.is(".disabled")){var p=this.viewDate.getUTCFullYear(),o=this.viewDate.getUTCMonth(),q=this.viewDate.getUTCDate(),r=this.viewDate.getUTCHours(),k=this.viewDate.getUTCMinutes(),s=this.viewDate.getUTCSeconds();if(n.is(".month")){this.viewDate.setUTCDate(1);o=n.parent().find("span").index(n);q=this.viewDate.getUTCDate();this.viewDate.setUTCMonth(o);this.element.trigger({type:"changeMonth",date:this.viewDate});if(this.viewSelect>=3){this._setDate(h(p,o,q,r,k,s,0))}}else{if(n.is(".year")){this.viewDate.setUTCDate(1);p=parseInt(n.text(),10)||0;this.viewDate.setUTCFullYear(p);this.element.trigger({type:"changeYear",date:this.viewDate});if(this.viewSelect>=4){this._setDate(h(p,o,q,r,k,s,0))}}else{if(n.is(".hour")){r=parseInt(n.text(),10)||0;if(n.hasClass("hour_am")||n.hasClass("hour_pm")){if(r===12&&n.hasClass("hour_am")){r=0}else{if(r!==12&&n.hasClass("hour_pm")){r+=12}}}this.viewDate.setUTCHours(r);this.element.trigger({type:"changeHour",date:this.viewDate});if(this.viewSelect>=1){this._setDate(h(p,o,q,r,k,s,0))}}else{if(n.is(".minute")){k=parseInt(n.text().substr(n.text().indexOf(":")+1),10)||0;this.viewDate.setUTCMinutes(k);this.element.trigger({type:"changeMinute",date:this.viewDate});if(this.viewSelect>=0){this._setDate(h(p,o,q,r,k,s,0))}}}}}if(this.viewMode!==0){var l=this.viewMode;this.showMode(-1);this.fill();if(l===this.viewMode&&this.autoclose){this.hide()}}else{this.fill();if(this.autoclose){this.hide()}}}break;case"td":if(n.is(".day")&&!n.is(".disabled")){var q=parseInt(n.text(),10)||1;var p=this.viewDate.getUTCFullYear(),o=this.viewDate.getUTCMonth(),r=this.viewDate.getUTCHours(),k=this.viewDate.getUTCMinutes(),s=this.viewDate.getUTCSeconds();if(n.is(".old")){if(o===0){o=11;p-=1}else{o-=1}}else{if(n.is(".new")){if(o===11){o=0;p+=1}else{o+=1}}}this.viewDate.setUTCFullYear(p);this.viewDate.setUTCMonth(o,q);this.element.trigger({type:"changeDay",date:this.viewDate});if(this.viewSelect>=2){this._setDate(h(p,o,q,r,k,s,0))}}var l=this.viewMode;this.showMode(-1);this.fill();if(l===this.viewMode&&this.autoclose){this.hide()}break}}},_setDate:function(i,k){if(!k||k==="date"){this.date=i}if(!k||k==="view"){this.viewDate=i}this.fill();this.setValue();var j;if(this.isInput){j=this.element}else{if(this.component){j=this.element.find("input")}}if(j){j.change()}this.element.trigger({type:"changeDate",date:this.getDate()});if(i===null){this.date=this.viewDate}},moveMinute:function(j,i){if(!i){return j}var k=new Date(j.valueOf());k.setUTCMinutes(k.getUTCMinutes()+(i*this.minuteStep));return k},moveHour:function(j,i){if(!i){return j}var k=new Date(j.valueOf());k.setUTCHours(k.getUTCHours()+i);return k},moveDate:function(j,i){if(!i){return j}var k=new Date(j.valueOf());k.setUTCDate(k.getUTCDate()+i);return k},moveMonth:function(j,k){if(!k){return j}var n=new Date(j.valueOf()),r=n.getUTCDate(),o=n.getUTCMonth(),m=Math.abs(k),q,p;k=k>0?1:-1;if(m===1){p=k===-1?function(){return n.getUTCMonth()===o}:function(){return n.getUTCMonth()!==q};q=o+k;n.setUTCMonth(q);if(q<0||q>11){q=(q+12)%12}}else{for(var l=0;l<m;l++){n=this.moveMonth(n,k)}q=n.getUTCMonth();n.setUTCDate(r);p=function(){return q!==n.getUTCMonth()}}while(p()){n.setUTCDate(--r);n.setUTCMonth(q)}return n},moveYear:function(j,i){return this.moveMonth(j,i*12)},dateWithinRange:function(i){return i>=this.startDate&&i<=this.endDate},keydown:function(o){if(this.picker.is(":not(:visible)")){if(o.keyCode===27){this.show()}return}var k=false,j,i,n;switch(o.keyCode){case 27:this.hide();o.preventDefault();break;case 37:case 39:if(!this.keyboardNavigation){break}j=o.keyCode===37?-1:1;var m=this.viewMode;if(o.ctrlKey){m+=2}else{if(o.shiftKey){m+=1}}if(m===4){i=this.moveYear(this.date,j);n=this.moveYear(this.viewDate,j)}else{if(m===3){i=this.moveMonth(this.date,j);n=this.moveMonth(this.viewDate,j)}else{if(m===2){i=this.moveDate(this.date,j);n=this.moveDate(this.viewDate,j)}else{if(m===1){i=this.moveHour(this.date,j);n=this.moveHour(this.viewDate,j)}else{if(m===0){i=this.moveMinute(this.date,j);n=this.moveMinute(this.viewDate,j)}}}}}if(this.dateWithinRange(i)){this.date=i;this.viewDate=n;this.setValue();this.update();o.preventDefault();k=true}break;case 38:case 40:if(!this.keyboardNavigation){break}j=o.keyCode===38?-1:1;m=this.viewMode;if(o.ctrlKey){m+=2}else{if(o.shiftKey){m+=1}}if(m===4){i=this.moveYear(this.date,j);n=this.moveYear(this.viewDate,j)}else{if(m===3){i=this.moveMonth(this.date,j);n=this.moveMonth(this.viewDate,j)}else{if(m===2){i=this.moveDate(this.date,j*7);n=this.moveDate(this.viewDate,j*7)}else{if(m===1){if(this.showMeridian){i=this.moveHour(this.date,j*6);n=this.moveHour(this.viewDate,j*6)}else{i=this.moveHour(this.date,j*4);n=this.moveHour(this.viewDate,j*4)}}else{if(m===0){i=this.moveMinute(this.date,j*4);n=this.moveMinute(this.viewDate,j*4)}}}}}if(this.dateWithinRange(i)){this.date=i;this.viewDate=n;this.setValue();this.update();o.preventDefault();k=true}break;case 13:if(this.viewMode!==0){var p=this.viewMode;this.showMode(-1);this.fill();if(p===this.viewMode&&this.autoclose){this.hide()}}else{this.fill();if(this.autoclose){this.hide()}}o.preventDefault();break;case 9:this.hide();break}if(k){var l;if(this.isInput){l=this.element}else{if(this.component){l=this.element.find("input")}}if(l){l.change()}this.element.trigger({type:"changeDate",date:this.getDate()})}},showMode:function(i){if(i){var j=Math.max(0,Math.min(c.modes.length-1,this.viewMode+i));if(j>=this.minView&&j<=this.maxView){this.element.trigger({type:"changeMode",date:this.viewDate,oldViewMode:this.viewMode,newViewMode:j});this.viewMode=j}}this.picker.find(">div").hide().filter(".datetimepicker-"+c.modes[this.viewMode].clsName).css("display","block");this.updateNavArrows()},reset:function(){this._setDate(null,"date")},convertViewModeText:function(i){switch(i){case 4:return"decade";case 3:return"year";case 2:return"month";case 1:return"day";case 0:return"hour"}}};var b=d.fn.datetimepicker;d.fn.datetimepicker=function(k){var i=Array.apply(null,arguments);i.shift();var j;this.each(function(){var n=d(this),m=n.data("datetimepicker"),l=typeof k==="object"&&k;if(!m){n.data("datetimepicker",(m=new g(this,d.extend({},d.fn.datetimepicker.defaults,l))))}if(typeof k==="string"&&typeof m[k]==="function"){j=m[k].apply(m,i);if(j!==f){return false}}});if(j!==f){return j}else{return this}};d.fn.datetimepicker.defaults={};d.fn.datetimepicker.Constructor=g;var e=d.fn.datetimepicker.dates={en:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],meridiem:["am","pm"],suffix:["st","nd","rd","th"],today:"Today",clear:"Clear"}};var c={modes:[{clsName:"minutes",navFnc:"Hours",navStep:1},{clsName:"hours",navFnc:"Date",navStep:1},{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],isLeapYear:function(i){return(((i%4===0)&&(i%100!==0))||(i%400===0))},getDaysInMonth:function(i,j){return[31,(c.isLeapYear(i)?29:28),31,30,31,30,31,31,30,31,30,31][j]},getDefaultFormat:function(i,j){if(i==="standard"){if(j==="input"){return"yyyy-mm-dd hh:ii"}else{return"yyyy-mm-dd hh:ii:ss"}}else{if(i==="php"){if(j==="input"){return"Y-m-d H:i"}else{return"Y-m-d H:i:s"}}else{throw new Error("Invalid format type.")}}},validParts:function(i){if(i==="standard"){return/t|hh?|HH?|p|P|z|Z|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g}else{if(i==="php"){return/[dDjlNwzFmMnStyYaABgGhHis]/g}else{throw new Error("Invalid format type.")}}},nonpunctuation:/[^ -\/:-@\[-`{-~\t\n\rTZ]+/g,parseFormat:function(l,j){var i=l.replace(this.validParts(j),"\0").split("\0"),k=l.match(this.validParts(j));if(!i||!i.length||!k||k.length===0){throw new Error("Invalid date format.")}return{separators:i,parts:k}},parseDate:function(A,y,v,j,r){if(A instanceof Date){var u=new Date(A.valueOf()-A.getTimezoneOffset()*60000);u.setMilliseconds(0);return u}if(/^\d{4}\-\d{1,2}\-\d{1,2}$/.test(A)){y=this.parseFormat("yyyy-mm-dd",j)}if(/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}$/.test(A)){y=this.parseFormat("yyyy-mm-dd hh:ii",j)}if(/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}\:\d{1,2}[Z]{0,1}$/.test(A)){y=this.parseFormat("yyyy-mm-dd hh:ii:ss",j)}if(/^[-+]\d+[dmwy]([\s,]+[-+]\d+[dmwy])*$/.test(A)){var l=/([-+]\d+)([dmwy])/,q=A.match(/([-+]\d+)([dmwy])/g),t,p;A=new Date();for(var x=0;x<q.length;x++){t=l.exec(q[x]);p=parseInt(t[1]);switch(t[2]){case"d":A.setUTCDate(A.getUTCDate()+p);break;case"m":A=g.prototype.moveMonth.call(g.prototype,A,p);break;case"w":A.setUTCDate(A.getUTCDate()+p*7);break;case"y":A=g.prototype.moveYear.call(g.prototype,A,p);break}}return h(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate(),A.getUTCHours(),A.getUTCMinutes(),A.getUTCSeconds(),0)}var q=A&&A.toString().match(this.nonpunctuation)||[],A=new Date(0,0,0,0,0,0,0),m={},z=["hh","h","ii","i","ss","s","yyyy","yy","M","MM","m","mm","D","DD","d","dd","H","HH","p","P","z","Z"],o={hh:function(s,i){return s.setUTCHours(i)},h:function(s,i){return s.setUTCHours(i)},HH:function(s,i){return s.setUTCHours(i===12?0:i)},H:function(s,i){return s.setUTCHours(i===12?0:i)},ii:function(s,i){return s.setUTCMinutes(i)},i:function(s,i){return s.setUTCMinutes(i)},ss:function(s,i){return s.setUTCSeconds(i)},s:function(s,i){return s.setUTCSeconds(i)},yyyy:function(s,i){return s.setUTCFullYear(i)},yy:function(s,i){return s.setUTCFullYear(2000+i)},m:function(s,i){i-=1;while(i<0){i+=12}i%=12;s.setUTCMonth(i);while(s.getUTCMonth()!==i){if(isNaN(s.getUTCMonth())){return s}else{s.setUTCDate(s.getUTCDate()-1)}}return s},d:function(s,i){return s.setUTCDate(i)},p:function(s,i){return s.setUTCHours(i===1?s.getUTCHours()+12:s.getUTCHours())},z:function(){return r}},B,k,t;o.M=o.MM=o.mm=o.m;o.dd=o.d;o.P=o.p;o.Z=o.z;A=h(A.getFullYear(),A.getMonth(),A.getDate(),A.getHours(),A.getMinutes(),A.getSeconds());if(q.length===y.parts.length){for(var x=0,w=y.parts.length;x<w;x++){B=parseInt(q[x],10);t=y.parts[x];if(isNaN(B)){switch(t){case"MM":k=d(e[v].months).filter(function(){var i=this.slice(0,q[x].length),s=q[x].slice(0,i.length);return i===s});B=d.inArray(k[0],e[v].months)+1;break;case"M":k=d(e[v].monthsShort).filter(function(){var i=this.slice(0,q[x].length),s=q[x].slice(0,i.length);return i.toLowerCase()===s.toLowerCase()});B=d.inArray(k[0],e[v].monthsShort)+1;break;case"p":case"P":B=d.inArray(q[x].toLowerCase(),e[v].meridiem);break;case"z":case"Z":r;break}}m[t]=B}for(var x=0,n;x<z.length;x++){n=z[x];if(n in m&&!isNaN(m[n])){o[n](A,m[n])}}}return A},formatDate:function(l,q,m,p,o){if(l===null){return""}var k;if(p==="standard"){k={t:l.getTime(),yy:l.getUTCFullYear().toString().substring(2),yyyy:l.getUTCFullYear(),m:l.getUTCMonth()+1,M:e[m].monthsShort[l.getUTCMonth()],MM:e[m].months[l.getUTCMonth()],d:l.getUTCDate(),D:e[m].daysShort[l.getUTCDay()],DD:e[m].days[l.getUTCDay()],p:(e[m].meridiem.length===2?e[m].meridiem[l.getUTCHours()<12?0:1]:""),h:l.getUTCHours(),i:l.getUTCMinutes(),s:l.getUTCSeconds(),z:o};if(e[m].meridiem.length===2){k.H=(k.h%12===0?12:k.h%12)}else{k.H=k.h}k.HH=(k.H<10?"0":"")+k.H;k.P=k.p.toUpperCase();k.Z=k.z;k.hh=(k.h<10?"0":"")+k.h;k.ii=(k.i<10?"0":"")+k.i;k.ss=(k.s<10?"0":"")+k.s;k.dd=(k.d<10?"0":"")+k.d;k.mm=(k.m<10?"0":"")+k.m}else{if(p==="php"){k={y:l.getUTCFullYear().toString().substring(2),Y:l.getUTCFullYear(),F:e[m].months[l.getUTCMonth()],M:e[m].monthsShort[l.getUTCMonth()],n:l.getUTCMonth()+1,t:c.getDaysInMonth(l.getUTCFullYear(),l.getUTCMonth()),j:l.getUTCDate(),l:e[m].days[l.getUTCDay()],D:e[m].daysShort[l.getUTCDay()],w:l.getUTCDay(),N:(l.getUTCDay()===0?7:l.getUTCDay()),S:(l.getUTCDate()%10<=e[m].suffix.length?e[m].suffix[l.getUTCDate()%10-1]:""),a:(e[m].meridiem.length===2?e[m].meridiem[l.getUTCHours()<12?0:1]:""),g:(l.getUTCHours()%12===0?12:l.getUTCHours()%12),G:l.getUTCHours(),i:l.getUTCMinutes(),s:l.getUTCSeconds()};k.m=(k.n<10?"0":"")+k.n;k.d=(k.j<10?"0":"")+k.j;k.A=k.a.toString().toUpperCase();k.h=(k.g<10?"0":"")+k.g;k.H=(k.G<10?"0":"")+k.G;k.i=(k.i<10?"0":"")+k.i;k.s=(k.s<10?"0":"")+k.s}else{throw new Error("Invalid format type.")}}var l=[],r=d.extend([],q.separators);for(var n=0,j=q.parts.length;n<j;n++){if(r.length){l.push(r.shift())}l.push(k[q.parts[n]])}if(r.length){l.push(r.shift())}return l.join("")},convertViewMode:function(i){switch(i){case 4:case"decade":i=4;break;case 3:case"year":i=3;break;case 2:case"month":i=2;break;case 1:case"day":i=1;break;case 0:case"hour":i=0;break}return i},headTemplate:'<thead><tr><th class="prev"><i class="{iconType} {leftArrow}"/></th><th colspan="5" class="switch"></th><th class="next"><i class="{iconType} {rightArrow}"/></th></tr></thead>',headTemplateV3:'<thead><tr><th class="prev"><span class="{iconType} {leftArrow}"></span> </th><th colspan="5" class="switch"></th><th class="next"><span class="{iconType} {rightArrow}"></span> </th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>',footTemplate:'<tfoot><tr><th colspan="7" class="today"></th></tr><tr><th colspan="7" class="clear"></th></tr></tfoot>'};c.template='<div class="datetimepicker"><div class="datetimepicker-minutes"><table class=" table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-hours"><table class=" table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-days"><table class=" table-condensed">'+c.headTemplate+"<tbody></tbody>"+c.footTemplate+'</table></div><div class="datetimepicker-months"><table class="table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-years"><table class="table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+"</table></div></div>";c.templateV3='<div class="datetimepicker"><div class="datetimepicker-minutes"><table class=" table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-hours"><table class=" table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-days"><table class=" table-condensed">'+c.headTemplateV3+"<tbody></tbody>"+c.footTemplate+'</table></div><div class="datetimepicker-months"><table class="table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-years"><table class="table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+"</table></div></div>";d.fn.datetimepicker.DPGlobal=c;d.fn.datetimepicker.noConflict=function(){d.fn.datetimepicker=b;return this};d(document).on("focus.datetimepicker.data-api click.datetimepicker.data-api",'[data-provide="datetimepicker"]',function(j){var i=d(this);if(i.data("datetimepicker")){return}j.preventDefault();i.datetimepicker("show")});d(function(){d('[data-provide="datetimepicker-inline"]').datetimepicker()})}));
		
		
		//there are errors, when you try to load the highlight-within-textarea.js library the normal way ('<script ...')
		//with this is a workaround it however works:
		$.getScript( "{% static 'js/jquery.highlight-within-textarea.js' %}", function( data, textStatus, jqxhr ) {});
		//$.getScript( "http://www.treeofknowledge.ai/static/js/jquery.highlight-within-textarea.js", function( data, textStatus, jqxhr ) {});

		drawLeftPanel__scenario();
		
		//load execution order
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				execution_order = JSON.parse(this.responseText);
			}
		};
		xhttp.open('GET', '/tool/get_execution_order?execution_order_id=' + execution_order_id , true);
		xhttp.send();
		

		
		//add objects to Paper
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			var object_number = object_numbers[i];
			
			var x_coordinate = objects_dict[object_number]['position']['x'];
			var y_coordinate = objects_dict[object_number]['position']['y'];
			var object_icon = objects_dict[object_number]['object_icon'];
			var object_type_id = objects_dict[object_number]['object_type_id'];
			var object_type_name = objects_dict[object_number]['object_type_name'];
			var object_name = objects_dict[object_number]['object_name'];
			addObjectToPaper(x_coordinate, y_coordinate, object_icon, object_type_id, object_type_name, object_number, object_name);
			
			
			//get the Object Rules (in case any new ones have been defined)
			getObjectRules(object_number, object_type_id)
		
		}
		

		//draw links
		for (var i = 0; i < object_numbers.length; i++) {
			var object_number = object_numbers[i];
			
			var object_relations = objects_dict[object_number]['object_relations'];
			for (var j = 0; j < object_relations.length; j++) {
					var target_object_number = object_relations[j]['target_object_number'];
					attribute_id = object_relations[j]['attribute_id'];
					active_relation_button = attribute_id;
					drawLink(object_number, target_object_number, attribute_id);
					active_relation_button = null;
			}
		}
		
		
	
	};
	

	
	
	
</script>



{% include "tool/includes/edit_object_behaviour_modal.html" %} 
{% include "tool/includes/edit_object_type_behaviour_modal.html" %} 
{% include "tool/includes/select_execution_order_modal.html" %} 



	<script src="{% static 'js/jquery.js' %}"></script>
{% endblock %}








