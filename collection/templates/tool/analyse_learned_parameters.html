{% extends 'layouts/base_tool.html' %}'
{% load staticfiles %}

<!-- 
####################################################################
# This file is part of the Tree of Knowledge project.
#
# Copyright (c) Benedikt Kleppmann - All Rights Reserved
#
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Benedikt Kleppmann <benedikt@kleppmann.de>, November 2024
#####################################################################
-->

{% block title %}
	Analyse Learned Parameters
{% endblock %}


{% block additionalcss %}

  <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
  <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="{% static 'css/bootstrap-3.4.0.min.css' %}" />
  

  <link rel="stylesheet" href="{% static 'css/bootstrap-slider.css' %}" />
	
	

<style>
	.content {
		padding: 0px;
	}
					
	/* --------------------------------------------------------------------------*/
	/* Left Panel ---------------------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#outer-left-panel {
		float: left;
		display: inline-block;
		margin-top: 2px;
		width: 256px;
		height: calc(100vh - 59px);
		background: rgb(226, 226, 226);
		border-right: 1px solid silver;
		box-shadow: 5px 0px 10px 0px rgba(0,0,0,0.30);
		position: relative;
	}
	
	.card-header {
		border-top: 1px solid rgb(180, 180, 180);
		border-bottom: 1px solid rgb(180, 180, 180);
	}
	
	.left-panel-header {
		font-size: 15.5px;
		background: rgb(226, 226, 226);
		width: 100%;
		padding-left: 20px;
		text-align: left;
		overflow: hidden;
	}
	
	.card-body {
		padding: 14px;
		background-color: rgb(244, 244, 244);
	}

	/* Info ------------------------------------------------------------------------ */
	
	#bottom-from-group {
		margin-bottom: 0px;
	}
	
	#open-execution-modal-button {
		border: 1px solid #ccc;
		background: white;
		width: 100%;
		text-align: left;
	}
	

	/* Parameter Distributions ------------------------------------------------------- */
	
	/* Inspect Simulations --------------------------------------------------------- */
	
	.parameter-selection-area {
		width: 217px;
	}
	
	#learned-parameter-selection-buttons {
		max-height: calc(100vh - 236px);
		overflow-y: auto;
	}

	#learned-parameter-selection-buttons .selection-button, #new-parameter-selection-buttons .selection-button {
		width: 100%;
		background: rgb(248, 248, 248);
		border: 1px solid rgb(210, 210, 210);
	}
	
	
	#parameter-distributions-box .selection-button {
		background: rgb(248, 248, 248);
		border: 1px solid rgb(210, 210, 210);
		text-align: left;
		margin-left: 20px;
	}
	
	#left-new-simulation-button {
		margin-top: 11px;
		margin-left: 33px;
	}
	
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Dual Ring  -------------------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
		#results-dont-exist-message {
		    text-align: center;
			margin-top: 100px;
			font-size: 16px;
		}
		
		.lds-dual-ring {
		  margin: auto;
		  margin-top: 125px;
		  width: 50px;
		  height: 50px;
		  padding-top: 12px;
		}
		
		.lds-dual-ring:after {
		  content: " ";
		  display: block;
		  width: 50px;
		  height: 50px;
		  margin: 1px;
		  border-radius: 50%;
		  border: 4px solid #fed;
		  border-color: rgb(80,80,80) transparent rgb(80,80,80) transparent;
		  animation: lds-dual-ring 3.2s linear infinite;
		}
		
		@keyframes lds-dual-ring {
		  0% {
			transform: rotate(0deg);
		  }
		  100% {
			transform: rotate(360deg);
		  }
		}
	
	
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Parameter Distributions  -----------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#graph-panel {
		height: 320px;
		width: 75%;
		margin-left: auto;
		margin-right: auto;
		margin-top: 15px;
		margin-bottom: 47px;
	}
	
	#tested_params-bottom-panel {
		margin-left: auto;
		margin-right: auto;
		width: 410px;
	}                 
	
	#slider-box {
		margin-left: 75px;
		margin-bottom: 18px;
	}
	
	#show-the-top-text {
		margin-left: 5px;
	}
	
	#top-x-value {
		display: inline-block;
		width: 38px;
		text-align: right;
		border-width: 1px;
	}
	
	#compare-and-save-buttons {
		display: inline-block;
		margin-top: 6px;
	}
	
	
	#compare-to-posteriors-button {
		margin-right: 11px;
	}
	
	#save-as-posterior-button {}
	
	#saving-response {
		padding-left: 250px;
		padding-top: 3px;
	}
										
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Inspect Simulations  ---------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	
	#right-main-panel {
		display: inline-block;
		height: calc(100vh - 59px);
		width: calc(100vw - 282px);
	}
	
	#analyse-simulation-box {
		height: calc(100vh - 59px);
		width: calc(100vw - 273px);
		border-width: 1px;
	}
	
	
	/* Run Monte-Carlo Simulation View - Upper ---------------------------------*/
	#right-main-upper-box {
		margin-left: 23px;
		margin-top: 12px;
	}
	
	#parameter-values-title {
		width: 350px;
		padding: 7px 13px 7px 21px;
		border: 1px solid rgb(180, 180, 180);
	}
	
	#simulation-parameter-box {
		padding: 14px;
		background-color: rgb(244, 244, 244);
		width: 350px;
	}
	
	.rule-heading {
		font-weight: 600;
		margin-bottom: 1px;
		padding-top: 6px;
	}
	
	.parameter-value {
		padding-left: 16px;
	}
	
	/* Run Monte-Carlo Simulation View - Lower ---------------------------------*/
	#right-main-lower-box {
		display: block;
		margin-top: 36px;
		margin-left: auto;
		margin-right: auto;
		width: 438px;
		padding-right: 130px;
	}
	
	#number-of-entities-to-simulate-box {
		margin-left: 55px;
	}
	
	#number-of-entities-to-simulate-box label {
		padding-top: 7px;
		padding-right: 0px;
	}
	
	#number-of-entities-to-simulate-box .col-sm-4 {
		padding-left: 4px;
	}
	
	#progress-bar-frame {
		margin-top: 60px;
		width: 90%;
		margin-left: 63px;
		margin-right: auto;
	}
	
	/* --------------------------------------------------------------------------*/
	/* Right Panel - Test New Parameters  ---------------------------------------*/
	/* --------------------------------------------------------------------------*/
	
	#test-new-parameters #simulation-parameter-box , #test-new-parameters #parameter-values-title {
		width: 400px;
	}
	
	#test-new-parameters .form-group {
		    margin-bottom: 8px;
	}
	
	#test-new-parameters .parameter-label{
		font-weight: 500;
		margin-top: 8px;
	}
	
	#test-new-parameters #right-main-lower-box {
		width: 517px;
	}
	
	#test-new-parameters #number-of-entities-to-simulate-box {
		display: inline-block;
		width: 236px;
		margin-left: 0px;
	}
	
	#test-new-parameters #run-monte-carlo-sim-button {
		display: inline-block;
		float: right;
	}
	
	
</style>	



{% endblock %}	

{% block content %}
<div id="outer-left-panel">
	<div class="accordion md-accordion" id="accordion-left" role="tablist" aria-multiselectable="true">	
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-1">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-1" aria-expanded="false" aria-controls="accordion-left-content-1">Info</button>
			</div>
			<div id="accordion-left-content-1" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-1" data-parent="#accordion-left">
				<div class="card-body">
					<div class="form left-panel-body">
						<div class="form-group row">
							<label for="simulation-name" class="col-sm-4">Simulation Name</label>
							<div class="col-sm-8">
								<input id="simulation-name" class="form-control" value="{{ simulation_model.simulation_name }}">
							</div>
						</div>
						<div class="form-group row">
							<label for="max" class="col-sm-4">Model</label>
							<div class="col-sm-8">
								<button id="open-execution-modal-button" class="btn btn-secondary" type="button" onclick="openSelectExecutionOrderModal()"></button>
							</div>
						</div>
						<div class="form-group row" style="margin-bottom: 0px;">
							<label for="max" class="col-sm-4">Run Number</label>
							<div class="col-sm-8">
								<select class="form-control form-control-lg" id="run_number" name="run_number" onchange="updateThePageAfterChangingExecutionOrder()">
								{% for result in results_from_all_runs %}
									<option value="{{ result.run_number }}" selected>{{ result.run_number }}</option>
								{% endfor %}
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-2">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-2" aria-expanded="false" aria-controls="accordion-left-content-2" onclick="drawParameterDistributions()">Parameter Distributions</button>
			</div>
			<div id="accordion-left-content-2" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-2" data-parent="#accordion-left">
				<div class="card-body">
					<div id="parameter-distributions-box"></div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-3">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-3" aria-expanded="false" aria-controls="accordion-left-content-3">Inspect Simulations</button>
			</div>
			<div id="accordion-left-content-3" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-3" data-parent="#accordion-left">
				<div class="card-body">
					<div class="parameter-selection-area">
						<div id="learned-parameter-selection-buttons"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="card">
			<div class="card-header" role="tab" id="accordion-left-header-4">
				<button class="btn left-panel-header collapsed accordion-toggle" data-parent="#accordion-left" href="#accordion-left-content-4" aria-expanded="false" aria-controls="accordion-left-content-4">Test New Parameters</button>
			</div>
			<div id="accordion-left-content-4" class="collapse" role="tabpanel" aria-labelledby="accordion-left-header-4" data-parent="#accordion-left">
				<div class="card-body">
					<div class="parameter-selection-area">
						<div id="new-parameter-selection-buttons"></div>
					</div>
					<button id="left-new-simulation-button" class="btn btn-success" type="button" onclick="showNewSimulationButton()">+ New Simulation</button>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="right-main-panel">
	<div class="lds-dual-ring"></div>
</div>




	

		
<script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-gantt.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
 

<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript" src="https://rawgit.com/RickStrahl/jquery-resizable/master/src/jquery-resizable.js"></script>


<script src="https://seiyria.com/bootstrap-slider/dependencies/js/jquery.min.js"></script>
<script src="https://seiyria.com/bootstrap-slider/dependencies/js/popper.min.js"></script>
<script src="https://seiyria.com/bootstrap-slider/dependencies/js/bootstrap.min.js"></script>
<script src="https://seiyria.com/bootstrap-slider/js/bootstrap-slider.js"></script>

 
<script type="text/javascript">
	// GLOBAL VARIABLES:
	var simulation_id = {{ simulation_model.id|safe }};
	var objects_dict = {{ simulation_model.objects_dict|safe }};
	var y_value_attributes = {{ simulation_model.y_value_attributes|safe }};
	var not_used_rules = {{ simulation_model.not_used_rules|safe }};
	
	var run_number = {{ learn_parameters_result.run_number|safe }};
	var all_priors_df = {{ learn_parameters_result.all_priors_df|safe }};
	var learned_rules = {{ learn_parameters_result.learned_rules|safe }};
	var available_execution_orders = {{ available_execution_orders|safe }};
	
	var X = 10;
	

	
	var is_timeseries_analysis = {{ simulation_model.is_timeseries_analysis|yesno:"true,false" }};
	var simulation_start_time = {{ simulation_model.simulation_start_time }};
    var simulation_end_time = {{ simulation_model.simulation_end_time }};
    var timestep_size = {{ simulation_model.timestep_size }};
	var simulation_name = '{{ simulation_model.simulation_name }}';
	var execution_order_id = {{ execution_order.id }};
	var execution_order = {{ execution_order.execution_order|safe }};
	var parameter_info = {};
	var currently_running_monte_carlo_simulations = new Set([]);
	





	//========================================================================
	//========================================================================
	//=========================   LEFT PANEL      ============================
	//========================================================================
	//========================================================================


	//== Fill in  'Parameter Distributions' ================================================================================================
	function drawParameterDistributions() {
	
		//new
		var parameter_distribution_buttons_str = '';
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = [];
			used_attributes = execution_order["attribute_execution_order"][objects_dict[object_numbers[i]]["object_type_id"]]["used_attributes"];
			for (var j = 0; j < used_attributes.length; j++) {
				attribute_ids.push(used_attributes[j]['id']);
			}
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'];
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (learned_rules[object_numbers[i]][attribute_ids[j]][rule_ids[k]]) {
						if (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]]))) {
							parameter_distribution_buttons_str += '<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
							if (!rule['has_probability_1']) {
								parameter_distribution_buttons_str += '<button class="btn btn-light selection-button" type="button" onclick="showParameterDistribution(' +  object_numbers[i] + ', ' +  attribute_ids[j] + ',' +  rule_ids[k] + ', null)">Rule probaility</button>';
							}
							var used_parameter_ids = rule['used_parameter_ids'];
							for (var l = 0; l < used_parameter_ids.length; l++) {
								parameter_distribution_buttons_str += '<button class="btn btn-light selection-button" type="button" onclick="showParameterDistribution(' +  object_numbers[i] + ', ' +  attribute_ids[j] + ',' +  rule_ids[k] + ',' +  used_parameter_ids[l] + ')">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + '</button>';
							}
						}
					}
					
				}
			}
		}
		
		//old
		/*var parameter_distribution_buttons_str = '';
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
						if (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]]))) {
							console.log(execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids']); // these two print statements are needed to avoid a heisenbug
							console.log(parseInt(rule_ids[k]));
							if (execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'].includes(parseInt(rule_ids[k]))) {
								parameter_distribution_buttons_str += '<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
								if (!rule['has_probability_1']) {
									parameter_distribution_buttons_str += '<button class="btn btn-light selection-button" type="button" onclick="showParameterDistribution(' +  object_numbers[i] + ', ' +  attribute_ids[j] + ',' +  rule_ids[k] + ', null)">Rule probaility</button>';
								}
								var used_parameter_ids = rule['used_parameter_ids'];
								for (var l = 0; l < used_parameter_ids.length; l++) {
									parameter_distribution_buttons_str += '<button class="btn btn-light selection-button" type="button" onclick="showParameterDistribution(' +  object_numbers[i] + ', ' +  attribute_ids[j] + ',' +  rule_ids[k] + ',' +  used_parameter_ids[l] + ')">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + '</button>';
								}
							}
						}
					}
					
				}
			}
		}*/
		
		$('#parameter-distributions-box').html(parameter_distribution_buttons_str);
	}
	
	
	
	//== Fill in  'Inspect Simulations' ================================================================================================
	function drawInspectSimulations() {
		var parameter_numbers = Object.keys(all_priors_df);
		var parameter_selection_buttons_str = '';
		for (var i = 0; i < parameter_numbers.length; i++) {
			var parameter_number = parameter_numbers[i];
			parameter_selection_buttons_str += '<button id="param-selection-button-' +  parameter_number + '" class="btn btn-light selection-button run-toggle" type="button" onclick="showParameterSimulations(' +  parameter_number + ')">Param ' +  parameter_number + ' - Score: ' + String(Math.round((1 - all_priors_df[parameter_number]["error"])*100)) + '% </button>';
		}
		$('#learned-parameter-selection-buttons').html(parameter_selection_buttons_str);
		$('#right-main-panel').html('');
	} 
	


	function activateSimulatedParameters() {
	
		//deactivate all
		var parameter_numbers = Object.keys(all_priors_df);
		for (var i = 0; i < parameter_numbers.length; i++) {
			$('#param-selection-button-' + String(parameter_numbers[i])).attr("onclick",'showRunMonteCarloSimulationButton(' + String(parameter_numbers[i]) + ')');
			$('#param-selection-button-' + String(parameter_numbers[i])).css("background",'rgb(200,200,200)');
			$('#param-selection-button-' + String(parameter_numbers[i])).css("color",'rgb(130,130,130)');
		}
	
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				parameter_numbers = JSON.parse(this.responseText);
				
				//activate Inspect Simulation buttons
				learned_parameter_numbers = parameter_numbers['learned_parameter_numbers']
				for (var i = 0; i < learned_parameter_numbers.length; i++) {
					$('#param-selection-button-' + String(learned_parameter_numbers[i])).attr("onclick",'showParameterSimulations(' + String(learned_parameter_numbers[i]) + ')');
					$('#param-selection-button-' + String(learned_parameter_numbers[i])).css("background",'rgb(248, 248, 248)');
					$('#param-selection-button-' + String(learned_parameter_numbers[i])).css("color",'#333');
				}
				
				//create Test New Parameters buttons
				new_parameter_numbers = parameter_numbers['new_parameter_numbers']
				parameter_selection_buttons_str = '';
				for (var i = 0; i < new_parameter_numbers.length; i++) {
					var parameter_number = new_parameter_numbers[i];
					parameter_selection_buttons_str += '<button  class="btn btn-light selection-button run-toggle" type="button" onclick="showNewParameterSimulations(' +  parameter_number + ')">Param ' +  parameter_number + '</button>';
				}
				$('#new-parameter-selection-buttons').html(parameter_selection_buttons_str);
				
			}
		};
		xhttp.open('GET', '/tool/get_simulated_parameter_numbers?simulation_id=' + String(simulation_id) + '&execution_order_id=' + String(execution_order_id) + '&run_number=' + String(run_number), true);
		xhttp.send();
	}


	function updateThePageAfterChangingExecutionOrder(){
		$('#right-main-panel').html('<div class="lds-dual-ring"></div>');
		$('#parameter-distributions-box').html('');
		$('#learned-parameter-selection-buttons').html('');
		$('#new-parameter-selection-buttons').html('');
		
		run_number = parseInt($('#run_number').val());
		
		

		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var response = this.responseText;
				if (response == "doesn't exist") {
					$('#right-main-panel').html('<div id="results-dont-exist-message">The simulation wasn\'t yet run for this model.</div>');
				} else {
					response_dict = JSON.parse(response);
					all_priors_df = response_dict['all_priors_df'];
					learned_rules = response_dict['learned_rules'];
					drawParameterDistributions();
					drawInspectSimulations();
					activateSimulatedParameters();
				}
			}
		};
		xhttp.open('GET', '/tool/get_all_priors_df_and_learned_rules?simulation_id=' + String(simulation_id) + '&execution_order_id=' + String(execution_order_id) + '&run_number=' + String(run_number), true);
		xhttp.send();
		
	
	
	}

	//========================================================================
	//========================================================================
	//========   RIGHT PANEL  - Parameter Distributions    ===================
	//========================================================================
	//========================================================================

	function showParameterDistribution(object_number, attribute_id, rule_id, parameter_id) {
		$('#right-main-panel').html('<div id="graph-panel"></div>' +
									'<div id="tested_params-bottom-panel">' + 
										'<div id="slider-box">' + 
											'<div id="show-the-top-text">' +
												'Use the ' +
												'<input id="top-x-value" type="text" name="top-x-value" value="10"/>' +
												' best parameters' +
											'</div>' +
											'<input id="top-x-slider-input" data-slider-id="top-x-slider" type="text" data-slider-min="0" data-slider-max="' + Object.keys(all_priors_df).length + '" data-slider-step="1" data-slider-value="' + String(X) + '"/>' +
										'</div>' +
										'<div id="compare-and-save-buttons">' + 
											'<button id="compare-to-posteriors-button" class="btn btn-secondary" type="button" onclick="showComparePosteriorsModal(' + object_number + ',' + attribute_id + ',' + rule_id + ',' + parameter_id + ')">Compare to other Posteriors</button>' +
											'<button id="save-as-posterior-button" class="btn btn-success" type="button" onclick="saveAsPosterior(' + object_number + ',' + rule_id + ',' + parameter_id + ')">Save as Posterior</button>' +
											'<div id="saving-response"></div>' +
										'</div>' +
									'</div>');
		
		
		$('#top-x-slider-input').slider();
		$('#top-x-slider-input').on("slide", function(sliderValue) {
			document.getElementById("top-x-value").value = sliderValue.value;
			showDistributionOfTopX(sliderValue.value, object_number, attribute_id, rule_id, parameter_id); 
		});
		
		
		$("#top-x-value").change(function(){
			X = parseInt($("#top-x-value").val());
			X = X > Object.keys(all_priors_df).length ? Object.keys(all_priors_df).length : X;  // X should be no bigger than Object.keys(all_priors_df).length
			X = X < 0  ? 0 : X;  																// X should be no smaller than 0
			$('#top-x-slider-input').slider('setValue', X);
			showDistributionOfTopX(X, object_number, attribute_id, rule_id, parameter_id); 
		});
			
		$('#top-x-value').val(X);
		$('#top-x-slider-input').slider('setValue', X);
		showDistributionOfTopX(X, object_number, attribute_id, rule_id, parameter_id);
	}
	


	
	function showDistributionOfTopX(X, object_number, attribute_id, rule_id, parameter_id) {
	
		$('#graph-panel').html('');
		
		//prepare the histogram
		var lower_bound = parameter_info[parameter_id]['min_value'];
		var upper_bound = parameter_info[parameter_id]['max_value'];
		
		//bin_lower_bounds
		var bin_interval = (upper_bound - lower_bound)/40;
		var bin_lower_bounds = []
		for (var i = 0; i < 40; i++) {
			bin_lower_bounds.push(Math.round((lower_bound + i*bin_interval) * 1000000) /1000000)
		}
		
		// bin_occurences
		bin_occurences = Array(40).fill(0);
		for (var i = 0; i < Math.min(X,Object.keys(all_priors_df).length); i++) {
			var value = all_priors_df[i]['param' + String(parameter_id)];
			var bin_number = 0;
			for (var j = 0; j < bin_lower_bounds.length; j++) {
				if (value > bin_lower_bounds[j]) { bin_number = j;	}
			}
			bin_occurences[bin_number] += 1;
		}
		
		// histogram_data
		var histogram_data = []
		for (var i = 0; i < bin_lower_bounds.length; i++) {
			if (bin_occurences[i] > 0){
				histogram_data.push([String(bin_lower_bounds[i]), String(bin_occurences[i])]);
			} else {
				histogram_data.push([String(bin_lower_bounds[i]), null]);
			}
		}
		
		//plot the histogram
		anychart.onDocumentReady(function () {

			var chart = anychart.column();
			chart.title(objects_dict[object_number]['object_name'] + '.[' + objects_dict[object_number]['object_attributes'][attribute_id]['attribute_name'] + '], Rule ' + String(rule_id) + ', ' + parameter_info[parameter_id]["parameter_name"] );
			chart.yScale().ticks().allowFractional(false);
			//chart.animation(true);

			var series = chart.column(histogram_data);

			series.tooltip().titleFormat('{%X}');

			series.tooltip()
					.position('center-top')
					.anchor('center-bottom')
					.offsetX(0)
					.offsetY(5);
					
			var tooltip = series.tooltip();


			chart.barGroupsPadding(0);
			chart.yScale().minimum(0);
			chart.yAxis().labels().format('{%Value}{groupsSeparator: }');
			chart.tooltip().positionMode('point');
			chart.interactivity().hoverMode('by-x');

			chart.xAxis().title(parameter_info[parameter_id]["parameter_name"] );
			chart.yAxis().title('Count');

			// set container id for the chart
			chart.container('graph-panel');
			chart.draw();
		});
	}



	function saveAsPosterior(object_number, rule_id, parameter_id) {
		X = parseInt($("#top-x-value").val());
		X = Math.min(X,Object.keys(all_priors_df).length);
		
		// ------- list_of_probabilities --------------------
		var lower_bound = parameter_info[parameter_id]['min_value'];
		var upper_bound = parameter_info[parameter_id]['max_value'];
		
		//list_of_probabilities: bin_lower_bounds
		var bin_interval = (upper_bound - lower_bound)/30;
		var bin_lower_bounds = []
		for (var i = 0; i < 30; i++) {
			bin_lower_bounds.push(Math.round((lower_bound + i*bin_interval) * 1000000) /1000000)
		}
		
		//list_of_probabilities: list_of_probabilities
		list_of_probabilities = Array(30).fill(0);
		for (var i = 0; i < Math.min(X,Object.keys(all_priors_df).length); i++) {
			var value = all_priors_df[i]['param' + String(parameter_id)];
			var bin_number = 0;
			for (var j = 0; j < bin_lower_bounds.length; j++) {
				if (value > bin_lower_bounds[j]) { bin_number = j;	}
			}
			list_of_probabilities[bin_number] += 1;
		}
		
		//list_of_probabilities: normalize
		var sum = list_of_probabilities.reduce(function(a, b){ return a + b; }, 0);
		for (var i = 0; i < list_of_probabilities.length; i++) {
			list_of_probabilities[i] = list_of_probabilities[i]*30/sum
		}
		
		// nb_of_sim_in_which_rule_was_used
		nb_of_sim_in_which_rule_was_used = 0
		for (var i = 0; i < Object.keys(all_priors_df).length; i++) {
			nb_of_sim_for_this_prior = all_priors_df[i]['nb_of_sim_in_which_rule_' + rule_id + '_was_used']
			if (!isNaN(nb_of_sim_for_this_prior)) {
				nb_of_sim_in_which_rule_was_used += nb_of_sim_for_this_prior
			}
		}
		
		
		
		// ------- send POST request --------------------
		request_body =  {'simulation_id': simulation_id, 
						'execution_order_id': execution_order_id,
						'object_number': object_number, 
						'parameter_id': parameter_id, 
						'list_of_probabilities': list_of_probabilities,
						'nb_of_simulations': all_priors_df[0]['nb_of_simulations'] * Object.keys(all_priors_df).length,
						'nb_of_sim_in_which_rule_was_used': nb_of_sim_in_which_rule_was_used,
						'nb_of_tested_parameters': Object.keys(all_priors_df).length, 
						'nb_of_tested_parameters_in_posterior': X};
		
		
		run_simulation_post_request = new XMLHttpRequest();   
		run_simulation_post_request.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				
				if (!isNaN(this.responseText)) {
					$('#saving-response').html('Saved!');
				} else {
					$('#saving-response').html(this.responseText);
				}
			}
		};
		run_simulation_post_request.open("POST", "/tool/save_likelihood_function/", true);
		run_simulation_post_request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		run_simulation_post_request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		run_simulation_post_request.send(JSON.stringify(request_body));
		
	}
	
	
	//========================================================================
	//========================================================================
	//========   RIGHT PANEL  - Inspect Simulations    =======================
	//========================================================================
	//========================================================================


	function showRunMonteCarloSimulationButton(parameter_number) {
		var right_main_panel_string = 	'<div id="right-main-upper-box">' +
											'<div id="parameter-values-title" class="left-panel-header">Parameter Values</div>' +
											'<div id="simulation-parameter-box">';
						
		//new
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = [];
			used_attributes = execution_order["attribute_execution_order"][objects_dict[object_numbers[i]]["object_type_id"]]["used_attributes"];
			for (var j = 0; j < used_attributes.length; j++) {
				attribute_ids.push(used_attributes[j]['id']);
			}
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'];
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]];
					if (learned_rules[object_numbers[i]][attribute_ids[j]][rule_ids[k]]) {
						if (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]]))) {
							right_main_panel_string += '<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
							if (!rule['has_probability_1'] && 'triggerThresholdForRule' + String(rule_ids[k]) in all_priors_df[parameter_number]) {
								right_main_panel_string += '<div class="parameter-value">Rule probaility = ' + all_priors_df[parameter_number]['triggerThresholdForRule' + String(rule_ids[k])].toFixed(3) + '</div>';
							}
							var used_parameter_ids = rule['used_parameter_ids'];
							for (var l = 0; l < used_parameter_ids.length; l++) {
								if ('param' + String(used_parameter_ids[l]) in all_priors_df[parameter_number]) {
									right_main_panel_string += '<div class="parameter-value">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + ' = ' + all_priors_df[parameter_number]['param' + String(used_parameter_ids[l])].toFixed(3) + '</div>';
								}
							}
						}	
					}
					
				}
			}
		}
		

		//old
		/*
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
						if (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]]))) {
							console.log(execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids']); // these two print statements are needed to avoid a heisenbug
							console.log(parseInt(rule_ids[k]));
							if (execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'].includes(parseInt(rule_ids[k]))) {
								right_main_panel_string += '<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
								if (!rule['has_probability_1'] && 'triggerThresholdForRule' + String(rule_ids[k]) in all_priors_df[parameter_number]) {
									right_main_panel_string += '<div class="parameter-value">Rule probaility = ' + all_priors_df[parameter_number]['triggerThresholdForRule' + String(rule_ids[k])].toFixed(3) + '</div>';
								}
								var used_parameter_ids = rule['used_parameter_ids'];
								for (var l = 0; l < used_parameter_ids.length; l++) {
									if ('param' + String(used_parameter_ids[l]) in all_priors_df[parameter_number]) {
										right_main_panel_string += '<div class="parameter-value">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + ' = ' + all_priors_df[parameter_number]['param' + String(used_parameter_ids[l])].toFixed(3) + '</div>';
									}
								}
							}
						}	
					}
					
				}
			}
		}*/
		
		right_main_panel_string +=			'</div>' +
										'</div>' +
										'<div id="right-main-lower-box">' +
											'<div id="number-of-entities-to-simulate-box" class="form">' +
												'<div class="form-group row">' +
													'<label for="number_of_entities_to_simulate" class="col-sm-8">Number of Entities to run</label>' +
													'<div class="col-sm-4">' +
														'<input id="number_of_entities_to_simulate" class="form-control" value="300">' +
													'</div>' +
												'</div>' +
											'</div>' +
											'<button id="run-monte-carlo-sim-button" class="btn btn-success" type="button" onclick="runMonteCarloSimulation(' + parameter_number + ')">Get Simulation Results for this Parameter Combination</button>' +
										'</div>' +
										'<div id="progress-bar-frame" style="display:none;">' +
											'<div id="progress-box" class="progress">' +
												'<div id="progress-bar" class="progress-bar" style="width:0%"></div>' +
											'</div>' +
											'<div id="progress-bar-description" class="progress-description"></div>' +
										'</div>';
										
		$('#right-main-panel').html(right_main_panel_string);
		
		if (currently_running_monte_carlo_simulations.has(parameter_number)) {
			$('#progress-bar-frame').css('display','block');
		}
	}
	
	
	function runMonteCarloSimulation(parameter_number) {
		
		$('#run-monte-carlo-sim-button').prop('disabled',true)
		$('#progress-bar-frame').css('display', 'block');
		$('#progress-bar').attr('style','width:0%');
		$('#progress-bar-description').html('');
		
		currently_running_monte_carlo_simulations.add(parameter_number);
		
		
		setTimeout('sendSimulationRequest(' + String(parameter_number) + ');', 10);
		setTimeout('update_the_progress_bar();', 2000);
	}
	
	
	
	async function sendSimulationRequest(parameter_number) {
	
		request_body = {'simulation_id': simulation_id, 'parameter_number': parameter_number}
		
		//add number_of_entities_to_simulate
		request_body['number_of_entities_to_simulate'] =  parseInt($('#number_of_entities_to_simulate').val());
		
		
		//add posted_prior_dict
		posted_prior_dict = {}
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = [];
			used_attributes = execution_order["attribute_execution_order"][objects_dict[object_numbers[i]]["object_type_id"]]["used_attributes"];
			for (var j = 0; j < used_attributes.length; j++) {
				attribute_ids.push(used_attributes[j]['id'])
			}
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'];
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]];
					if (learned_rules[object_numbers[i]][attribute_ids[j]][rule_ids[k]]) {
						posted_prior_dict[rule_ids[k]] = {}
					
						if (!rule['has_probability_1']) {
							posted_prior_dict[rule_ids[k]]['probability'] = all_priors_df[parameter_number]['triggerThresholdForRule' + String(rule_ids[k])]
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							posted_prior_dict[rule_ids[k]][used_parameter_ids[l]] = all_priors_df[parameter_number]['param' + String(used_parameter_ids[l])]
						}
					}
				}
			}
		}
		
		//old
		//add posted_prior_dict
		/*posted_prior_dict = {}
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
						posted_prior_dict[rule_ids[k]] = {}
					
						if (!rule['has_probability_1']) {
							posted_prior_dict[rule_ids[k]]['probability'] = all_priors_df[parameter_number]['triggerThresholdForRule' + String(rule_ids[k])]
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							posted_prior_dict[rule_ids[k]][used_parameter_ids[l]] = all_priors_df[parameter_number]['param' + String(used_parameter_ids[l])]
						}
					}
				}
			}
		}*/
		request_body['prior_dict'] =  posted_prior_dict;
		
		
		run_simulation_post_request = new XMLHttpRequest();   // new HttpRequest instance
		run_simulation_post_request.onreadystatechange = function() {
		
			if (this.readyState == 4 && this.status == 200) {
				
				parameter_number = JSON.parse(this.responseText);
				showParameterSimulations(parameter_number);
				currently_running_monte_carlo_simulations.delete(parameter_number);
				activateSimulatedParameters();
				
			}
		};
		run_simulation_post_request.open("POST", "/tool/run_single_monte_carlo/", true);
		run_simulation_post_request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		run_simulation_post_request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		run_simulation_post_request.send(JSON.stringify(request_body));
	}



	
	async function update_the_progress_bar() {
		var progress = '0';

		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				
				var progress_dict = JSON.parse(this.responseText);
				//progess-bar
				if ('current_number' in progress_dict){
					$('#progress-bar').attr('style','width:' + String(100 * progress_dict['current_number']/progress_dict['total_number']) + '%')
					$('#progress-bar-description').html(progress_dict['text'] +  String(progress_dict['current_number']) + '/' + String(progress_dict['total_number']));				
				}
				
				if (run_simulation_post_request.readyState < 4) {
					window.setTimeout(() => { update_the_progress_bar();}, 1000);
				}

			}
		};
		xhttp.open("GET", "/tool/get_simulation_progress?simulation_id=" + simulation_id , true);
		xhttp.send();
		
	}
	
	function showParameterSimulations(parameter_number) {
		$('#right-main-panel').html('<iframe id="analyse-simulation-box" src="' + String(parameter_number) + '" title="analyse_simulations_with_this_parameter_combination"></iframe>');
	}
	
	
	//========================================================================
	//========================================================================
	//========   RIGHT PANEL  - Test New Parameters    =======================
	//========================================================================
	//========================================================================
	
	
	function showNewSimulationButton() {
		var right_main_panel_string = 	'<div id="right-main-upper-box">' +
											'<div id="test-new-parameters">' +
												'<div id="parameter-values-title" class="left-panel-header">Parameter Values</div>' +
												'<div id="simulation-parameter-box">';
				




		//new
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = [];
			used_attributes = execution_order["attribute_execution_order"][objects_dict[object_numbers[i]]["object_type_id"]]["used_attributes"];
			for (var j = 0; j < used_attributes.length; j++) {
				attribute_ids.push(used_attributes[j]['id']);
			}
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'];
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (learned_rules[object_numbers[i]][attribute_ids[j]][rule_ids[k]]) {
						if (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]]))) {
							right_main_panel_string += 		'<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
							if (!rule['has_probability_1']) {
								right_main_panel_string += 	'<div class="form-group row">' +
																'<label class="col-sm-8 parameter-label" for="probability-of-rule-' + String(rule_ids[k]) + '">Rule Probability = </label>' +
																'<div class="col-sm-4">' +
																	'<input type="text" id="probability-of-rule-' + String(rule_ids[k]) + '" class="form-control" value="">' +
																'</div>' +
															'</div>';
							}
							var used_parameter_ids = rule['used_parameter_ids'];
							for (var l = 0; l < used_parameter_ids.length; l++) {
								right_main_panel_string += '<div class="form-group row">' +
																'<label class="col-sm-8 parameter-label" for="value-of-parameter-' + String(used_parameter_ids[l]) + '">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + ' = </label>' +
																'<div class="col-sm-4">' +
																	'<input type="text" id="value-of-parameter-' + String(used_parameter_ids[l]) + '" class="form-control" value="">' +
																'</div>' +
															'</div>';
							}																
						}
					}
					
				}
			}
		}
		
		//old 
		/*
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior'] && (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]])))) {
					
						if (!(object_numbers[i] in not_used_rules) || (object_numbers[i] in not_used_rules && !(rule_ids[k] in not_used_rules[object_numbers[i]]))) {
							console.log(execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids']); // these two print statements are needed to avoid a heisenbug
							console.log(parseInt(rule_ids[k]));
							if (execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'].includes(parseInt(rule_ids[k]))) {
							
								right_main_panel_string += 		'<div class="rule-heading">' + objects_dict[object_numbers[i]]['object_name'] + ', Rule ' + String(rule_ids[k]) + ':</div>';
								if (!rule['has_probability_1']) {
									right_main_panel_string += 	'<div class="form-group row">' +
																	'<label class="col-sm-8 parameter-label" for="probability-of-rule-' + String(rule_ids[k]) + '">Rule Probability = </label>' +
																	'<div class="col-sm-4">' +
																		'<input type="text" id="probability-of-rule-' + String(rule_ids[k]) + '" class="form-control" value="">' +
																	'</div>' +
																'</div>';
								}
								var used_parameter_ids = rule['used_parameter_ids'];
								for (var l = 0; l < used_parameter_ids.length; l++) {
									right_main_panel_string += '<div class="form-group row">' +
																	'<label class="col-sm-8 parameter-label" for="value-of-parameter-' + String(used_parameter_ids[l]) + '">' + parameter_info[used_parameter_ids[l]]["parameter_name"] + ' = </label>' +
																	'<div class="col-sm-4">' +
																		'<input type="text" id="value-of-parameter-' + String(used_parameter_ids[l]) + '" class="form-control" value="">' +
																	'</div>' +
																'</div>';
								}								
							}									
						}
					}
					
				}
			}
		}*/
		
		right_main_panel_string +=				'</div>' +
												'<div id="right-main-lower-box">' +
													'<div id="number-of-entities-to-simulate-box" class="form">' +
														'<div class="form-group row">' +
															'<label for="number_of_entities_to_simulate" class="col-sm-8">Number of Entities to run</label>' +
															'<div class="col-sm-4">' +
																'<input id="number_of_entities_to_simulate" class="form-control" value="300">' +
															'</div>' +
														'</div>' +
													'</div>' +
													'<button id="run-monte-carlo-sim-button" class="btn btn-success" type="button" onclick="runNewSimulation()">Run</button>' +
												'</div>' +
												'<div id="progress-bar-frame" style="display:none;">' +
													'<div id="progress-box" class="progress">' +
														'<div id="progress-bar" class="progress-bar" style="width:0%"></div>' +
													'</div>' +
													'<div id="progress-bar-description" class="progress-description"></div>' +
												'</div>' +
											'</div>' +
										'</div>';
										
		$('#right-main-panel').html(right_main_panel_string);
	
	}



	function runNewSimulation() {
		
		$('#run-monte-carlo-sim-button').prop('disabled',true)
		$('#progress-bar-frame').css('display', 'block');
		$('#progress-bar').attr('style','width:0%');
		$('#progress-bar-description').html('');
		
		setTimeout('sendNewSimulationRequest();', 10);
		setTimeout('update_the_progress_bar();', 2000);
	}
	
	
	
	async function sendNewSimulationRequest() {
	
		request_body = {'simulation_id': simulation_id, 'parameter_number': null}

		//add number_of_entities_to_simulate
		request_body['number_of_entities_to_simulate'] =  parseInt($('#number_of_entities_to_simulate').val());
		
		
		//new
		//add posted_prior_dict
		posted_prior_dict = {}
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = [];
			used_attributes = execution_order["attribute_execution_order"][objects_dict[object_numbers[i]]["object_type_id"]]["used_attributes"];
			for (var j = 0; j < used_attributes.length; j++) {
				attribute_ids.push(used_attributes[j]['id']);
			}
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = execution_order['rule_execution_order'][attribute_ids[j]]['used_rule_ids'];
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]];
					if (learned_rules[object_numbers[i]][attribute_ids[j]][rule_ids[k]]) {
						posted_prior_dict[rule_ids[k]] = {}
					
						if (!rule['has_probability_1']) {
							posted_prior_dict[rule_ids[k]]['probability'] = parseFloat($('#probability-of-rule-' + String(rule_ids[k])).val());
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							posted_prior_dict[rule_ids[k]][used_parameter_ids[l]] = parseFloat($('#value-of-parameter-' + String(used_parameter_ids[l])).val());
						}
					}
				}
			}
		}
		
		
		//old
		//add posted_prior_dict
		/*
		posted_prior_dict = {}
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
						posted_prior_dict[rule_ids[k]] = {}
					
						if (!rule['has_probability_1']) {
							posted_prior_dict[rule_ids[k]]['probability'] = parseFloat($('#probability-of-rule-' + String(rule_ids[k])).val());
						}
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							posted_prior_dict[rule_ids[k]][used_parameter_ids[l]] = parseFloat($('#value-of-parameter-' + String(used_parameter_ids[l])).val());
						}
					}
				}
			}
		}*/
		request_body['prior_dict'] =  posted_prior_dict;
		
		
		run_simulation_post_request = new XMLHttpRequest();   // new HttpRequest instance
		run_simulation_post_request.onreadystatechange = function() {
		
			if (this.readyState == 4 && this.status == 200) {
				
				parameter_number = JSON.parse(this.responseText);
				$('#param-selection-button-' + String(parameter_number)).attr("onclick",'showParameterSimulations(' + String(parameter_number) + ')');
				$('#param-selection-button-' + String(parameter_number)).css("background",'rgb(248, 248, 248)');
				$('#param-selection-button-' + String(parameter_number)).css("color",'#333');
				showNewParameterSimulations(parameter_number);
				
			}
		};
		run_simulation_post_request.open("POST", "/tool/run_single_monte_carlo/", true);
		run_simulation_post_request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		run_simulation_post_request.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		run_simulation_post_request.send(JSON.stringify(request_body));
	}
	
	
	

	function showNewParameterSimulations(parameter_number) {
		$('#right-main-panel').html('<iframe id="analyse-simulation-box" src="new-' + String(parameter_number) + '" title="analyse_simulations_with_this_parameter_combination"></iframe>');
	}
	
	
	
	
	//========================================================================
	//========================================================================
	//========================    MAIN      ==================================
	//========================================================================
	//========================================================================	

	window.onload = function() {	

		$('#open-execution-modal-button').html(available_execution_orders[execution_order_id]['name']);
		
		
		// make the accordion in the left sidebar collapseable
		$('.accordion-toggle').click(function() {
			content_element = $($(this).attr('href'));
			if (content_element.hasClass('in')) {
				content_element.hide();
				content_element.removeClass('in')
			} else {
				content_element.show();
				content_element.addClass('in')
			}
		});
		//$('#accordion-left-content-3').show();
		//$('#accordion-left-content-3').addClass('in');
		
		
		
		//load execution order
		/*
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				execution_order = JSON.parse(this.responseText);
			}
		};
		xhttp.open('GET', '/tool/get_execution_order?execution_order_id=' + String(execution_order_id) , true);
		xhttp.send(); */
		
		
		$('#run_number').val(run_number);

		// load parameter_info
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				parameter_info = JSON.parse(this.responseText);
			}
		};
		xhttp.open('GET', '/tool/get_parameter_info', true);
		xhttp.send();

		/*				
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			
			var attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules']);
			for (var j = 0; j < attribute_ids.length; j++) {
			
				var rule_ids = Object.keys(objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]]);
				for (var k = 0; k < rule_ids.length; k++) {
				
					var rule = objects_dict[object_numbers[i]]['object_rules'][attribute_ids[j]][rule_ids[k]]
					if (rule['learn_posterior']) {
					
						var used_parameter_ids = rule['used_parameter_ids'];
						for (var l = 0; l < used_parameter_ids.length; l++) {
							//get the Parameter Info
							var xhttp = new XMLHttpRequest();       
							xhttp.onreadystatechange = function() {
								if (this.readyState == 4 && this.status == 200) {
									response_dict = JSON.parse(this.responseText);
									parameter_info[response_dict['id']] = response_dict;
								}
							};
							xhttp.open('GET', '/tool/get_parameter_info?parameter_id=' + String(used_parameter_ids[l]) + '&is_last_parameter=' + String(l == (used_parameter_ids.length-1)), true);
							xhttp.send();
						}
					}
					
				}
			}
		}*/
		
		
		drawInspectSimulations();
		activateSimulatedParameters();
		
		
	}
	
</script>


<!-- **********************************-->
<!-- *                                *-->
<!-- *    Compare Posteriors Modal    *-->
<!-- *                                *-->
<!-- **********************************-->
	
<style type='text/css'>
	#comparePosteriorsModal .modal-dialog{
		position: absolute;
		left: 16%;
	}

	#comparePosteriorsModal .modal-content{
		width: 1200px;
	}
	
	#comparePosteriorsModal .modal-header{
		height: 68px;
		width: 100%;
		margin-left: 0px;
	}
	
	#comparePosteriorsModal #modal-title {
		display: inline-block;
		font-size: 22px;
		margin-top: 8px;
		margin-left: 17px;
	}
	
	#x-button {
		font-size: 31px;
		margin-right: 6px;
	}
	
	
	#comparePosteriorsModal #modal-body {
		padding: 0px;
		padding-top: 15px;
	}
	
	#comparePosteriorsModal .container-fluid {
		padding: 0px 5px;
	}
	
	/* Drop Down -----------------------------------------------*/
	#execution-order-selection {
		width: 298px;
		margin-left: 16px;
		margin-top: 2px;
		margin-bottom: 21px;
	}
	
	
	
	/* ----------------------------------------------------------*/
	/* PDFS -----------------------------------------------------*/
	/* ----------------------------------------------------------*/
		
	/*.individual-pdf-row {
		float: left;
	}*/
	
	/* PDF Row - Left --------------------------------------------*/
	.simulation-name {
		display: inline-block;
		float: left;
		width: 286px;
		padding-top: 50px;
		text-align: center;
		font-size: 20px;
	}
	/* PDF Row - Middle ------------------------------------------*/
	
	.pdf-box {
		display: inline-block;
		margin-top: 3px;
		margin-right: 20px;
	}
	
	.outer-pdf-graph-container{
		height: 108px;
		width: 280px;
		border: 1px solid rgb(240,240,240);
		overflow: hidden;
	}
	
	.inner-pdf-graph-container {
		height: 166px;
		width: 362px;
		margin-left: -48px;
		margin-top: 5px;
	}
	

	#pdf-graph-all-simulations {
		height: 178px;
		width: 288px;
		margin-left: -48px;
		margin-top: -2px;
	}
	
	.pdf-title {
	    width: 100%;
		text-align: center;
		margin-top: -9px;
	}
	
	.pdf-x-axis {
		margin-top: -2px;
		margin-left: -2px;
		margin-right: -2px;
		font-size: 12px;
		width: 281px;
	}
	
	.pdf-x-axis .left {
		display: inline-block;
	}
	
	.pdf-x-axis .right {
	    display: inline-block;
		float: right;
	}
	
	/* PDF Row - Right ------------------------------------------*/
	.values-in-posterior-box {
		display: inline-block;
		margin-left: 67px;
		padding-top: 33px;
	}
	
	.values-in-posterior {
		display: inline-block;
		float: right;
		font-size: 21px;
		margin-top: 12px;
	}
	
	.slash {
		display: inline-block;
		float: right;
		font-size: 36px;
		padding-bottom: 15px;
		margin: 1px;
	}
	
	#separation-line {
	    margin-top: 4px;
		margin-bottom: 1px;
		margin-left: 5%;
		width: 91%;
		border: 2px solid rgb(83, 152, 193);
		margin-top: 25px;
	}
	
	#total-text {
		margin-left: 64px;
		font-size: 19px;
		color: rgb(57, 121, 159);
	}
</style>

<!-- Compare Posteriors Modal -->
<div class="modal fade" id="comparePosteriorsModal" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
	<div class="modal-content">
	  <div class="modal-header row">
		<div class="modal-title object-type-name" id="modal-title">Posteriors for ...</div>
		<button id="x-button" type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close"  onclick="closeComparePosteriorsModal()">
		  <span aria-hidden="true" >&times;</span>
		</button>
	  </div>
	  <div class="modal-body">
		<div class="container-fluid">
			<div id="execution-order-dropdown-box"></div>
			<div id="posterior-information"></div>
		</div>
	  </div>
	</div>
  </div>
</div>

<script type="text/javascript" src="{% static 'js/bootstrap-3.4.0.min.js' %}"></script>

	
	
<script type="text/javascript">

	//========================================================================
	//========================================================================
	//=================    comparePosteriorsModal      =======================
	//========================================================================
	//========================================================================	

	// GLOBAL VARIABLES:	
	var posterior_information_dict = {}
	
	function showComparePosteriorsModal(object_number, attribute_id, rule_id, parameter_id) {
		$('#comparePosteriorsModal #posterior-information').html('');
		$("#comparePosteriorsModal").modal('show');
		
		$('#modal-title').html('Posteriors for [' + parameter_info[parameter_id]['parameter_name'] + ']');
		
		var is_rule = 'true';
		if (parameter_id) {
			is_rule = 'false';
		} 
		
		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {	
				posterior_information_dict = JSON.parse(this.responseText);
				drawComparePosteriorsContent()					;
			}
		};
		xhttp.open("GET", "/tool/get_all_pdfs?execution_order_id=" + String(execution_order_id) + "&rule_or_parameter_id=" + String(parameter_id) + '&is_rule=' + is_rule, true);
		xhttp.send();


	}
	
	
	/*function drawExecutionOrderDropDown() {
		var dropdown_html_string =  '<select id="execution-order-selection" name="execution-order-selection" class="form-control" onchange="drawComparePosteriorsContent(this.value)">';
		var execution_order_ids = Object.keys(posterior_information_dict);
		for (var i = 0; i < execution_order_ids.length; i++) {
			dropdown_html_string += '<option value="' + execution_order_ids[i] + '">' + posterior_information_dict[execution_order_ids[i]]['execution_order_name'] + '</option>';
		}
		dropdown_html_string += '</select>';
		
		$('#execution-order-dropdown-box').html(dropdown_html_string);
	}*/
	
	
	function drawComparePosteriorsContent() {

		var parameter_id = posterior_information_dict['rule_or_parameter_id'];
		var pdfs_html_string = '<div id="pdf-rows">';
		for (var i = 0; i < posterior_information_dict['individual_pdfs'].length; i++) {
			var individual_pdf = posterior_information_dict['individual_pdfs'][i];
			pdfs_html_string += 	'<div class="individual-pdf-row">' +
										'<div class="simulation-name"><a href="/edit_simulation/' + String(individual_pdf['simulation_id']) + '">' + individual_pdf['simulation_name'] + '</a></div>' +
										'<div class="pdf-box">' +
											'<div class="outer-pdf-graph-container">' +
												'<div id="parameter-pdf-graph-this-simulation-' + String(i) + '" class="inner-pdf-graph-container"></div>' +
											'</div>' +
											'<div class="pdf-x-axis"><div class="left">' + parameter_info[parameter_id]['min_value'] + '</div><div class="right">' + parameter_info[parameter_id]['max_value'] + '</div></div>' +
										'</div>' +
										'<div class="pdf-box">' +
											'<div class="outer-pdf-graph-container">' +
												'<div id="parameter-pdf-graph-this-simulation-' + String(i) + '-smooth" class="inner-pdf-graph-container"></div>' +
											'</div>' +
											'<div class="pdf-x-axis"><div class="left">' + parameter_info[parameter_id]['min_value'] + '</div><div class="right">' + parameter_info[parameter_id]['max_value'] + '</div></div>' +
										'</div>' +
										'<div class="values-in-posterior-box">' +
											'<div class="values-in-posterior">' + String(individual_pdf['nb_of_tested_parameters']) + '</div><div class="slash">/</div><div class="values-in-posterior">' + String(individual_pdf['nb_of_tested_parameters_in_posterior']) + '</div>' +
										'</div>' +
									'</div>';
		}
		pdfs_html_string += 	'</div>' +
								'<div id="separation-line"></div>' +
								'<div id="total-text">Total</div>' +
								'<div class="individual-pdf-row">' +
									'<div class="simulation-name"></div>' +
									'<div class="pdf-box">' +
										'<div class="outer-pdf-graph-container" style="border: none;"></div>' +
									'</div>' +
									'<div class="pdf-box">' +
										'<div class="outer-pdf-graph-container">' +
											'<div id="parameter-pdf-graph-combined-simulations-smooth" class="inner-pdf-graph-container"></div>' +
										'</div>' +
										'<div class="pdf-x-axis"><div class="left">' + parameter_info[parameter_id]['min_value'] + '</div><div class="right">' + parameter_info[parameter_id]['max_value'] + '</div></div>' +
									'</div>' +
									'<div class="values-in-posterior-box">' +
										'<div class="values-in-posterior">' + String(posterior_information_dict['combined_pdf']['nb_of_tested_parameters']) + '</div><div class="slash">/</div><div class="values-in-posterior">' + String(posterior_information_dict['combined_pdf']['nb_of_tested_parameters_in_posterior']) + '</div>' +
									'</div>' +
								'</div>';
								
		$('#comparePosteriorsModal #posterior-information').html(pdfs_html_string);
		
		
		for (var i = 0; i < posterior_information_dict['individual_pdfs'].length; i++) {
		
			// simulation pdf - normal
			anychart.onDocumentReady(function () {
				var dataSet = anychart.data.set(posterior_information_dict['individual_pdfs'][i]['pdf']);
				var seriesData = dataSet.mapAs({'x': 0, 'value': 1});
				var chart = anychart.area();
				var series = chart.area(seriesData);
				series.tooltip().enabled(false);

				chart.yAxis();
				var xAxis = chart.xAxis();
				xAxis.title('Probability');
				xAxis.labels().format("{%Value}%");

				chart.container('parameter-pdf-graph-this-simulation-' + String(i));
				chart.draw();
			});
			
			// simulation pdf - smooth
			anychart.onDocumentReady(function () {
				var dataSet = anychart.data.set(posterior_information_dict['individual_pdfs'][i]['smooth_pdf']);
				var seriesData = dataSet.mapAs({'x': 0, 'value': 1});
				var chart = anychart.area();
				var series = chart.area(seriesData);
				series.tooltip().enabled(false);

				chart.yAxis();
				var xAxis = chart.xAxis();
				xAxis.title('Probability');
				xAxis.labels().format("{%Value}%");

				chart.container('parameter-pdf-graph-this-simulation-' + String(i) + '-smooth');
				chart.draw();
			});
		}
		
		// combined pdf - normal
		anychart.onDocumentReady(function () {
			var dataSet = anychart.data.set(posterior_information_dict['combined_pdf']['smooth_pdf']);
			var seriesData = dataSet.mapAs({'x': 0, 'value': 1});
			var chart = anychart.area();
			var series = chart.area(seriesData);
			series.tooltip().enabled(false);

			chart.yAxis();
			var xAxis = chart.xAxis();
			xAxis.title('Probability');
			xAxis.labels().format("{%Value}%");

			chart.container('parameter-pdf-graph-combined-simulations-smooth');
			chart.draw();
		});	
	}

</script>



{% include "tool/includes/select_execution_order_modal.html" %}



{% endblock %}



