<!--                 EDIT  OBJECT BEHAVIOUR MODAL                     -->
<!-- This is used in edit_simulation -->

<!-- 
####################################################################
# This file is part of the Tree of Knowledge project.
# Copyright (C) Benedikt Kleppmann - All Rights Reserved
#
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Benedikt Kleppmann <benedikt@kleppmann.de>, February 2021
#####################################################################
-->
{% load staticfiles %}
	
<link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
<link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css?hcode=be5162d915534272a57d0bb781d27f2b" rel="stylesheet" type="text/css">
<script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-gantt.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js?hcode=be5162d915534272a57d0bb781d27f2b"></script>

<style>	
	#editObjectBehaviourModal .modal-dialog {
		width: 1488px;
		position: initial;
	}

	#editObjectBehaviourModal #modal-title {
		display: inline-block;
		font-size: 22px;
		margin-top: 16px;
		margin-left: 19px;
	}
	
	#editObjectBehaviourModal #x-button {
	    display: inline-block;
		float: right;
		margin-top: 4px;
		margin-right: 24px;
		font-size: 29px;
	}
	
	#editObjectBehaviourModal .modal-header.row {
		margin: 0px;
	}
	/* -----------------------------------------------------*/
	/* RULE PANELS -----------------------------------------*/
	/* -----------------------------------------------------*/
	
	#editObjectBehaviourModal .learn-rule-title {
	    margin-left: 569px;
		margin-bottom: 3px;
		font-weight: 700;
	}
	
	#editObjectBehaviourModal #rule-panel {
		display: inline-block;
	}
	
	.rule-panel-body {
		width: 696px;
		height:calc(100vh - 260px);
		overflow-y: auto;
		padding: 2px;
		-webkit-box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		-moz-box-shadow: inset 1px 1px 59px 5px rgba(0,0,0,0.2);
		box-shadow: inset 1px 1px 9px 5px rgba(0,0,0,0.2);
		background-color: rgb(190, 190, 190);
		border-left: 5px solid rgb( 230, 230, 230);
		border-top: 5px solid rgb( 218, 218, 218);
		border-right: 5px solid rgb(250, 250, 250);
		border-bottom: 5px solid rgb(250, 250, 250);
	}
	
	#editObjectBehaviourModal #rules-list {
		height: 375px;
	}
	
	#editObjectBehaviourModal #not-used-rules-list {
		height: 180px;
	}
	
	#editObjectBehaviourModal #not-used-rules-title {
		font-size: 17px;
		margin-left: 5px;
	}
	
	/* ----------------------------------------------------------*/
	/* RULE PANEL ITEMS -----------------------------------------*/
	/* ----------------------------------------------------------*/
	
	#editObjectBehaviourModal .rule-panel-body > .list-group-item {
		height: 57px;
		border-left: 9px solid rgb(252, 252, 252);
		border-top: 9px solid rgb(255, 255, 255);
		border-right: 9px solid rgb( 242, 242, 242);
		border-bottom: 9px solid rgb( 235, 235, 235);
		margin-bottom: 3px;
		border-radius: 3px;
		padding: 0px;
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.18);
		background-color: rgb(252, 252, 252);
	}
	
	#editObjectBehaviourModal .rule-panel-body  img {
		height: 33px;
		width: 20px;
		float: left;
		margin-top: 2px;
		display: inline-block;
	}
	
	#editObjectBehaviourModal .rule-description {
		width: 470px;
		height: 46px;
		display: inline-block;
		float: left;
	}
	
	#editObjectBehaviourModal .rule-description .btn {
		display: inline-block;
		background-color: rgb(252, 252, 252);
		float: left;
		padding-bottom: 11px;
		width: 476px;
		text-align: left;
	}
	
	#editObjectBehaviourModal .rule-probability {
		display: inline-block;
		margin-top: 7px;
		margin-left: 18px;
	}
	
	#editObjectBehaviourModal .learn-probabililty-checkbox {
		display: inline-block;
		margin-left: 26px;
	}
	
	#editObjectBehaviourModal #is_certain_fact {
	    margin-right: 7px;
	}
	
	
	#editObjectBehaviourModal .remove-rule-button {
		display: inline-block;
		float: right;
		height: 18px;
		width: 18px;
		padding: 0px;
		margin-top: 3px;
		margin-right: 2px;
		border-radius: 3px;
		background-color: rgb(242, 242, 242);
	}

	#editObjectBehaviourModal .remove-rule-button-text {
		margin-left: -1px;
		margin-top: -2px;
	}
	
	
	#plus-button {
		-webkit-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		-moz-box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
		box-shadow: 2px 4px 9px 3px rgba(0,0,0,0.3);
	}
	
	#plus-button-list-group-item {
		background-color: rgba(256, 256, 256, 0);
		padding: 12px;
		padding-left: 21px;
	}
	
	
	/* ----------------------------------------------------------*/
	/* RULE DETAILS ---------------------------------------------*/
	/* ----------------------------------------------------------*/
	
	#editObjectBehaviourModal #rule-info-top {
		height: 435px;
	}
	
	#editObjectBehaviourModal #rule-info {
		display: inline-block;
		float: right;
	}
	
	#editObjectBehaviourModal #rule-details {
		display: inline-block;
		float: left;
		width: 430px;
		margin-right: 22px;
	}
	
	#rule-details label {
	    margin-bottom: 2px;
	}
	
	#rule-details .form-group {
		margin-bottom: 21px;
	}
	
	#editObjectBehaviourModal #has-if-condition-field {
		width: 200px;
		margin-bottom: 15px;
		margin-top: 1px;
	}
	
	#editObjectBehaviourModal #is-certain-fact-field {
		margin-top: 10px
	}
	
	#editObjectBehaviourModal #rule-details .form-control {
		border-radius: 5px;
	}
	
	#editObjectBehaviourModal #chooseRuleSaveButton {
		margin-left: 5px;
	}
	
	/* ----------------------------------------------------------*/
	/* AVAILABLE VARIABLES --------------------------------------*/
	/* ----------------------------------------------------------*/
	

	
	
	#editObjectBehaviourModal #available-variables-outer-block {
		display: inline-block;
	}
	
	#editObjectBehaviourModal #available-variables-error-message {
		color: rgb(145, 20, 13);
		width: 219px;
	}
	
	#editObjectBehaviourModal #available-variables-main-block {
	
	}
	
	#editObjectBehaviourModal #available-variables-block {
		display: inline-block;
		overflow: hidden;
		float: left;
		width: 219px;
	}
	
	#editObjectBehaviourModal .available-variable-frame {
		width: 219px;
		height: 307px;
	}
	
	#editObjectBehaviourModal #available-relation-variables-block {
		display: inline-block;
		overflow: hidden;
		width:0px;
	}

	.available-variables-label {
		margin-top: 19px;
		font-weight: 700;
		font-size: 15px;
		color: rgb(110, 110, 110);
	} 
	
	.relations-variables-label {
		display: inline-block;
		margin-top: 19px;
		font-weight: 700;
		font-size: 15px;
		color: rgb(50, 50, 50);
	} 
	
	#remove-related-attributes-button {
		display: inline-block;
	}
	
	#selectAvailableVariable {
		width: 179px;
		margin-top: 2px;
		margin-bottom: 5px;
	}
	
	#selectRelatedAvailableVariable {
		width: 179px;
		margin-top: 2px;
		margin-bottom: 5px;
	}
	
	.available-variable-frame {
		border: 1px solid rgb(202, 202, 202);
		border-radius: 4px;
		width: 195px;
		height: 300px;
		overflow: auto;
	}
	
	.list-group-item.avail-var-item{
		border-bottom: 1px solid rgb(202, 202, 202);
		margin-bottom: 0px;
		padding:0px;
	}
	
	.list-group-item.related-var-item{
		border-bottom: 1px solid rgb(202, 202, 202);
		margin-bottom: 0px;
		padding:0px;
	}

	.avail-var-button {
		background: white;
		width: 195px;
	}

	/* ----------------------------------------------------------*/
	/* RULE PDF -------------------------------------------------*/
	/* ----------------------------------------------------------*/
	
	/* left pdf ------------*/
	.rule-pdf-panel-title {
	    margin-top: 50px;
		margin-bottom: 5px;
		margin-left: 1px;
		font-weight: 700;
		font-size: 15px;
	}
	
	#pdf-this-simulation {
		display: inline-block;
		margin-left: 2px;
	}
	
	.outer-pdf-graph-container{
		height: 150px;
		width: 275px;
		border: 1px solid rgb(240,240,240);
		overflow: hidden;
	}
	
	#pdf-graph-this-simulation {
		height: 213px;
		width: 346px;
		margin-left: -48px;
		margin-top: 0px;
	}
	
	#this-simulation-warning-message {
	    width: 273px;
		text-align: center;
		color: red;
	}
	
	
	/* right pdf ------------*/
	#pdf-all-simulations {
		display: inline-block;
		margin-right: 62px;
		float: right;
	}
	
	#pdf-graph-all-simulations {
		height: 213px;
		width: 346px;
		margin-left: -48px;
		margin-top: -21px;
	}
	
	.pdf-title {
	    width: 100%;
		text-align: center;
		margin-top: -6px;
	}
	
	.pdf-x-axis {
		margin-left: -2px;
		margin-right: -12px;
		font-size: 12px;
	}
	
	.pdf-x-axis .left {
		display: inline-block;
	}
	
	.pdf-x-axis .right {
	    display: inline-block;
		float: right;
	}
	

</style>


	
	<!-- Edit Object Behaviour Modal -->
	<div class="modal fade" id="editObjectBehaviourModal" tabindex="-1" role="dialog" aria-labelledby="chooseAttributeTitle" aria-hidden="true">
	  <div class="modal-dialog" role="document">
		<div class="modal-content">
		  <div class="modal-header row">
			<div class="modal-title object-type-name" id="modal-title"></div>
			<button id="x-button" type="button col-md-1" class="close" data-dismiss="modal" aria-label="Close">
			  <span aria-hidden="true" >&times;</span>
			</button>
		  </div>
		  <div class="modal-body">
			  <div class="container-fluid">
				<div class="form">

					<div id="rule-panel">
						<div class="learn-rule-title">Learn Probability</div>
						<ul id="rules-list" class="list-group rule-panel-body"></ul>
						<div id="not-used-rules-title">Not Used Rules</div>
						<ul id="not-used-rules-list" class="list-group rule-panel-body"></ul>
					</div>
					<div id="rule-info">
						<div id="rule-info-top">
							<div id="rule-details"></div>
							<div id="available-variables-outer-block">
								<div id="available-variables-error-message"></div>
								<div id="available-variables-main-block">
									<div id="available-variables-block"></div>
									<div id="available-relation-variables-block"></div>
								</div>
							</div>
						</div>
						<div id="save-cancel-rule-buttons"></div>
						<div class="rule-pdf-panel-title"></div>
						<div id="rule-pdf-panel"></div>
					</div>
						
				</div>
			</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-primary" id="editAttributeCloseButton" data-dismiss="modal">Close</button>

		  </div>
		  
		</div>
	  </div>
	</div>
	
	

	
<script>

//GLOBAL VARIABLES
var new_rule_cursor_position = {};
	
	
	/*========================================================================*/
	/*======================    BUILD THE MODAL     ==========================*/
	/*========================================================================*/
	
	
	
	function openEditObjectBehaviourModal(object_number, rules_attribute_id, rules_attribute_name, rule_id){
		$("#rule-details").html('');
		$("#available-variables-block").html('');
		$("#save-cancel-rule-buttons").html('');
		$("#editObjectBehaviourModal").modal('show');

		var object_name = objects_dict[object_number]['object_name'];
		$("#editObjectBehaviourModal #modal-title").html('Rules for [' + rules_attribute_name + '] of ' + object_name);
	
		populateTheRulePanels(object_number, rules_attribute_id, rules_attribute_name);
		
		if (rule_id) {
			inspectRule(object_number, rules_attribute_id, rules_attribute_name, rule_id);
		}
		
	}
	
	
	
	
	
	
	function populateTheRulePanels(object_number, rules_attribute_id, rules_attribute_name) {
		
		
		// populate rules-list -------------------------------------------------------------
		rules_list_html_string = '';
		
		var rule_ids = Object.keys(objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'])
		for (var i = 0; i < rule_ids.length ; i++) {
			var rule_id = rule_ids[i];
			var rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'][rule_id];
			
			if (rule['is_conditionless']) {
				rule_text = "At every timestep: [" + rules_attribute_name + "] = " + rule['effect_text'];
			} else {
				rule_text = "IF " +  rule['condition_text'] + " THEN [" + rules_attribute_name + "] = " + rule['effect_text'];
			}
			
			if (rule_text.length > 75) {
				rule_text = rule_text.substring(0, 72) + '...';
			}
			
			checked_string = '';
			if (objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'][rule_id]['learn_posterior'] == true) {checked_string = 'checked';}
			
			if (rule['has_probability_1']) {
				rule_info =	'<div class="rule-probability"> known fact</div>';
				
			} else if (!rule['has_probability_1'] && rule['probability'] == null) {
			
				rule_info =	'<div class="rule-probability"> unknown</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" ' + checked_string + '>' +
							'</div>';		
			} else {
				rule_info =	'<div class="rule-probability"> ' + Math.round(rule['probability'] * 100) + ' ±' + Math.round(rule['standard_dev'] * 100) + ' %</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" ' + checked_string + '>' +
							'</div>';
			}
			

			
			
			rules_list_html_string +=	'<li class="list-group-item new" id="rule' + rule_id + '" data-object-number=' + object_number + ' data-attribute-id=' + rules_attribute_id + ' data-rule-id=' + rule_id + '>' +
											'<img src="{% static "images/drag-grip1.png" %}">' +
											'<div class="rule-description">' +
												'<button class="btn btn-outline-secondary" onclick="inspectRule(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + rule_id +')" >' + rule_text + '</button>' +
											'</div>' +
											rule_info +
											'<button type="button" class="btn btn-secondary remove-rule-button" onclick="removeBehaviourRule(' + object_number + ', ' + rules_attribute_id + ', ' + rule_id + ')"><div class="remove-rule-button-text">&times;</div></button>' +
										'</li>';
									
		}
		
		rules_list_html_string += 	'<li id="plus-button-list-group-item">' +
										'<button id="plus-button" type="button" class="btn btn-outline-dark" onclick="newBehaviourRule(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\')" >' +
											'<i class="fas fa-plus"></i>' +
										'</button>'
									'</li>'
		
		$('#rules-list').html(rules_list_html_string);
		
		// populate not-used-rules-list -------------------------------------------------------------
		
		not_used_rules_list_html_string = ""
		var not_used_rule_ids = Object.keys(objects_dict[object_number]['object_rules'][rules_attribute_id]['not_used_rules'])
		for (var i = 0; i < not_used_rule_ids.length ; i++) {
			var rule_id = not_used_rule_ids[i];
			var rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['not_used_rules'][rule_id];
			
			if (rule['is_conditionless']) {
				rule_text = "At every timestep: [" + rules_attribute_name + "] = " + rule['effect_text'];
			} else {
				rule_text = "IF " +  rule['condition_text'] + " THEN [" + rules_attribute_name + "] = " + rule['effect_text'];
			}
			
			if (rule_text.length > 75) {
				rule_text = rule_text.substring(0, 72) + '...';
			}
			
			if (rule['has_probability_1']) {
				rule_info =	'<div class="rule-probability"> known fact</div>';
				
			} else if (!rule['has_probability_1'] && rule['probability'] == null) {
			
				rule_info =	'<div class="rule-probability"> unknown</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" checked>' +
							'</div>';

			} else {
				rule_info =	'<div class="rule-probability"> ' + Math.round(rule['probability'] * 100) + ' ±' + Math.round(rule['standard_dev'] * 100) + ' %</div>' + 
							'<div class="learn-probabililty-checkbox">' +
								'<input type="checkbox" id="learn-probabililty--rule' + rule_id + '" name="learn-probabililty--rule' + rule_id + '" onchange="learnProbabilityChange(' + object_number + ',' + rules_attribute_id + ',' + rule_id + ')" checked>' +
							'</div>';
			}
			

			
			
			not_used_rules_list_html_string +=	'<li class="list-group-item new" id="rule' + rule_id + '" data-object-number=' + object_number + ' data-attribute-id=' + rules_attribute_id + ' data-rule-id=' + rule_id + '>' +
											'<img src="{% static "images/drag-grip1.png" %}">' +
											'<div class="rule-description">' +
												'<button class="btn btn-outline-secondary" onclick="inspectRule(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + rule_id +')" >' + rule_text + '</button>' +
											'</div>' +
											rule_info +
											'<button type="button" class="btn btn-secondary remove-rule-button" onclick="removeBehaviourRule(' + object_number + ', ' + rules_attribute_id + ', ' + rule_id + ')"><div class="remove-rule-button-text">&times;</div></button>' +
										'</li>';
									
		}
		

		
		$('#not-used-rules-list').html(not_used_rules_list_html_string);
	
			
	
			
	}
	
	
	

	
	
	
	
	
	/*========================================================================*/
	/*======================       RULE PANEL       ==========================*/
	/*========================================================================*/
	
	
	
	
	
	function inspectRule(object_number, rules_attribute_id, rules_attribute_name, rule_id) {
		$("#editObjectBehaviourModal").modal('show');


		// Rule Details ------------------------------------------------------------
		if (Object.keys(objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules']).includes(String(rule_id))) {
			rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['used_rules'][rule_id];
		} else {
			rule = objects_dict[object_number]['object_rules'][rules_attribute_id]['not_used_rules'][rule_id];
		}
		
		is_certain_fact_checked_string = rule['has_probability_1'] ? 'checked': '';
		
		if (rule['is_conditionless']) {	

			rule_details_html = '<div id="has-if-condition-field">' +
									'<input type="checkbox" class="form-check-input" id="has_if_condition" onchange="changeRuleType(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\')">' +
									'<label class="form-check-label" for="has_if_condition">&nbsp;Has IF Condition</label>' +
								'</div>' +
								'<div id="rule-details-main">' + 
									'<div class="form-group">' + 
										'<label for="rule-effect-text">' + rules_attribute_name + ' = </label>' +
										'<textarea cols="20" rows="5" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')">' + rule['effect_text'] + '</textarea>' +
									'</div>' +
									'<div id="is-certain-fact-field">' +
										'<input type="checkbox" class="form-check-input" id="is_certain_fact" ' + is_certain_fact_checked_string + '>' +
										'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
									'</div>' +
								'</div>';
		} else {

			rule_details_html = '<div id="has-if-condition-field">' +
									'<input type="checkbox" class="form-check-input" id="has_if_condition" onchange="changeRuleType(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\') checked>' +
									'<label class="form-check-label" for="has_if_condition">&nbsp;Has IF Condition</label>' +
								'</div>' +
								'<div id="rule-details-main">' + 
									'<div class="form-group">' + 
										'<label for="rule-condition-text">IF</label>' +
										'<textarea cols="20" rows="3" class="form-control" id="rule-condition-text" onclick="rememberCursorPostion(\'rule-condition-text\')">' + rule['condition_text'] + '</textarea>' +
									'</div>' +
									'<div class="form-group">' + 
										'<label for="rule-effect-text">THEN ' + rules_attribute_name + ' = </label>' +
										'<textarea cols="20" rows="3" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')">' + rule['effect_text'] + '</textarea>' +
									'</div>' +
									'<div id="is-certain-fact-field">' +
										'<input type="checkbox" class="form-check-input" id="is_certain_fact" ' + is_certain_fact_checked_string + '>' +
										'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
									'</div>' +
								'</div>';
		}
							
		
		
		$('#rule-details').html(rule_details_html);
		
		
		
		// Available Variables ------------------------------------------------------------
		var object_name = objects_dict[object_number]['object_name']
		
		available_variables_html = 	'<div class="available-variables-label">Available Variables:</div>' + 
									'<input type="text" class="form-control" id="selectAvailableVariable" onkeyup="filterAvailableVariables();" placeholder=" Search">' + 
									'<div class="available-variable-frame">' + 
										'<ul id="available-variables" class="input-group list-group">';
			
		var object_attributes = objects_dict[object_number]['object_attributes'];
		var attribute_ids = Object.keys(object_attributes);
		for (var i = 0; i < attribute_ids.length ; i++) {
			var attribute_id = attribute_ids[i];
			var attribute_name = object_attributes[attribute_id]['attribute_name']
			var attribute_data_type = object_attributes[attribute_id]['attribute_data_type']
			if (attribute_data_type == 'relation') {
				available_variables_html += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableRelation(' + object_number + ', ' + attribute_id + ', \'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
			} else {
				available_variables_html += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
			}
		}
		for (var i = 0; i < delta_t_list.length ; i++) {
			var delta_t_name = delta_t_list[i];
			available_variables_html += 		'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + delta_t_name + '\')" scope="col">' + delta_t_name + '</button></li>';
		}
		
		
		available_variables_html += 	'</ul>' + 
									'</div>';

		$('#available-variables-block').html(available_variables_html);
		
		
		
		// Cancel/Save Buttons ------------------------------------------------------------
		var save_button_html_string =  	'<button type="button" class="btn btn-secondary" id="cancelNewRuleButton" onclick="cancelRuleCreation()">Cancel</button>' +
										'<button type="button" class="btn btn-primary" id="chooseRuleSaveButton" onclick="saveBehaviourRule(' + rule_id + ', ' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + object_number + ')">Save Rule</button>';
		
		$('#save-cancel-rule-buttons').html(save_button_html_string);		
	

	
		// Rule Probability ------------------------------------------------------------
		if (!rule['has_probability_1']) {
		
			$('#rule-pdf-panel-title').html('Rule Probability');
			var rule_probability_html_string = '<div id="pdf-this-simulation">' +
													'<div class="outer-pdf-graph-container">' +
														'<div id="pdf-graph-this-simulation"></div>' +
													'</div>' +
													'<div class="pdf-x-axis"><div class="left">0%</div><div class="right">100%</div></div>' +
													'<div class="pdf-title">Learned from this simulation</div>' +
													'<div id="this-simulation-warning-message"></div>' +
												'</div>' +
												'<div id="pdf-all-simulations">' +
													'<div class="outer-pdf-graph-container">' +
														'<div id="pdf-graph-all-simulations"></div>' +
													'</div>' +
													'<div class="pdf-x-axis"><div class="left">0%</div><div class="right">100%</div></div>' +
													'<div class="pdf-title">Learned from all simulations</div>' +
												'</div>';
												
			$('#rule-pdf-panel').html(rule_probability_html_string);
			
			var url_components = window.location.href.split("/");
			var simulation_id = url_components[url_components.length - 2];
			//get_single_pdf
			var xhttp = new XMLHttpRequest();       
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var response = JSON.parse(this.responseText);
					
					$('#pdf-graph-this-simulation').html('');
					anychart.onDocumentReady(function () {
						var dataSet = anychart.data.set(response['pdf']);
						var seriesData = dataSet.mapAs({'x': 0, 'value': 1});
						var chart = anychart.area();
						var series = chart.area(seriesData);
						series.tooltip().enabled(false);

						// axes settings
						chart.yAxis();
						var xAxis = chart.xAxis();
						xAxis.title('Probability');
						xAxis.labels().format("{%Value}%");

						chart.container('pdf-graph-this-simulation');
						chart.draw();
					});
					
					if (response['message']) {
						$('#this-simulation-warning-message').html(response['message']);
					}
					
				}
			};
			xhttp.open('GET', '/tool/get_single_pdf?simulation_id=' + simulation_id + '&execution_order_id=' + execution_order_id + 'object_number=' + object_number + '&rule_id=' + rule_id + '&is_rule=true', true);
			xhttp.send();
			
			
			//get_rules_pdf
			var xhttp = new XMLHttpRequest();       
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var histogram_data = JSON.parse(this.responseText);
					
					$('#pdf-graph-all-simulations').html('');
					anychart.onDocumentReady(function () {
						var dataSet = anychart.data.set(histogram_data);
						var seriesData = dataSet.mapAs({'x': 0, 'value': 1});
						var chart = anychart.area();
						var series = chart.area(seriesData);
						series.tooltip().enabled(false);

						// axes settings
						chart.yAxis();
						var xAxis = chart.xAxis();
						xAxis.labels().format("{%Value}%");

						chart.container('pdf-graph-all-simulations');
						chart.draw();
					});
					
				}
			};
			xhttp.open('GET', '/tool/get_rules_pdf?execution_order_id=' + String(execution_order_id) + '&rule_id=' + rule_id  + '&is_rule=true', true);
			xhttp.send();
			
		}	
	}
	
	
	
	
	// the '+'-Button
	function newBehaviourRule(object_number, rules_attribute_id, rules_attribute_name) {

		// Populate the Modal
		rule_details_html = '<div id="has-if-condition-field">' +
								'<input type="checkbox" class="form-check-input" id="has_if_condition" onchange="changeRuleType(' + object_number + ',' + rules_attribute_id + ',\'' + rules_attribute_name + '\')">' +
								'<label class="form-check-label" for="has_if_condition">&nbsp;Has IF Condition</label>' +
							'</div>' +
							'<div id="rule-details-main">' + 
								'<div class="form-group">' + 
									'<label for="rule-effect-text">' + rules_attribute_name + ' = </label>' +
									'<textarea cols="20" rows="5" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')"></textarea>' +
								'</div>' +
								'<div id="is-certain-fact-field">' +
									'<input type="checkbox" class="form-check-input" id="is_certain_fact" >' +
									'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
								'</div>' +
							'</div>';
								

		
		$('#rule-details').html(rule_details_html);
		changeRuleType(object_number, rules_attribute_id, rules_attribute_name);
		

		available_variables_html = 	'<div class="available-variables-label">Available Variables:</div>' + 
									'<input type="text" class="form-control" id="selectAvailableVariable" onkeyup="filterAvailableVariables();" placeholder=" Search">' + 
									'<div class="available-variable-frame">' + 
										'<ul id="available-variables" class="input-group list-group">';
			
		var object_attributes = objects_dict[object_number]['object_attributes'];
		var attribute_ids = Object.keys(object_attributes);
		for (var i = 0; i < attribute_ids.length ; i++) {
			var attribute_id = attribute_ids[i];
			var attribute_name = object_attributes[attribute_id]['attribute_name']
			var attribute_data_type = object_attributes[attribute_id]['attribute_data_type']
			if (attribute_data_type == 'relation') {
				available_variables_html += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableRelation(' + object_number + ', ' + attribute_id + ', \'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
			} else {
				available_variables_html += 	'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
			}
		}
		for (var i = 0; i < delta_t_list.length ; i++) {
			var delta_t_name = delta_t_list[i];
			available_variables_html += 		'<li class="list-group-item avail-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + delta_t_name + '\')" scope="col">' + delta_t_name + '</button></li>';
		}
		
		
		available_variables_html += 	'</ul>' + 
									'</div>';
									
		$('#available-variables-block').html(available_variables_html);
		
		
		
		var save_button_html_string =  	'<button type="button" class="btn btn-secondary" id="cancelNewRuleButton" onclick="cancelRuleCreation()">Cancel</button>' +
										'<button type="button" class="btn btn-primary" id="chooseRuleSaveButton" onclick="saveBehaviourRule(null, ' + rules_attribute_id + ',\'' + rules_attribute_name + '\',' + object_number + ')">Save Rule</button>';
		
		$('#save-cancel-rule-buttons').html(save_button_html_string);
	}
	
	
	
	// X - Button  - when pressed from rules-list
	function removeBehaviourRule(object_number, attribute_id, rule_id) {
		
		// if the Rule Item is in the rules-list, then move it to the not-used-rules-list
		if (Object.keys(objects_dict[object_number]['object_rules'][attribute_id]['used_rules']).includes(String(rule_id))){
			// move it in the data
			objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id] = objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
			delete objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
			execution_order_index = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'].indexOf(rule_id);
			objects_dict[object_number]['object_rules'][attribute_id]['execution_order'].splice(execution_order_index, 1); 

			// move it on the html
			not_used_rules_list = document.getElementById('not-used-rules-list');
			the_deleted_item = document.getElementById('rule' + rule_id);
			not_used_rules_list.appendChild(the_deleted_item);
		}
		
		// if the Rule Item is in the not-used-rules-list, delete it permanently
		else {
			var ok_given = confirm("Permanently delete this rule?");
			if (ok_given == false){return;}
			
			// delete it from the backend
			var xmlhttp = new XMLHttpRequest();  
			xmlhttp.open("POST", "/tool/delete_rule/");
			xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
			xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
			xmlhttp.send(JSON.stringify({'rule_id':rule_id}));
			
			// delete it from the frontend
			delete objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id];
			the_deleted_item = document.getElementById('rule' + rule_id).remove();
		}
	}
	
	
	
	// Learn-Probability Checkbox
	function learnProbabilityChange(object_number,attribute_id, rule_id) {
		var learn_posterior  = document.getElementById("learn-probabililty--rule" + rule_id).checked;
		objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id]['learn_posterior'] = learn_posterior;
	}
	
	
	
	
	
	/*========================================================================*/
	/*======================       RULE DETAILS       ==========================*/
	/*========================================================================*/
	
	
	
	

	
	
	function changeRuleType(object_number, attribute_id, attribute_name) {
		var has_if_condition = $('#has_if_condition').is(':checked');
		
		if (has_if_condition){
		
			var object_filter_facts = objects_dict[object_number]['object_filter_facts'] 
			var rule_initial_condition = '';
			for (var i = 0; i < object_filter_facts.length ; i++) {
				rule_initial_condition += '[' + object_filter_facts[i]['attribute'] + '] ' +  object_filter_facts[i]['operation'] + ' ' + object_filter_facts[i]['value'] + ' and '
			}
			var object_relations = objects_dict[object_number]['object_relations'] 
			for (var i = 0; i < object_relations.length ; i++) {
				var relation_filter_facts = objects_dict[object_relations[i]['target_object_number']]['object_filter_facts'] 
				for (var i = 0; i < relation_filter_facts.length ; i++) {
					rule_initial_condition += '[' + object_relations[i]['relation_name'] + '].[' + relation_filter_facts[i]['attribute'] + '] ' +  relation_filter_facts[i]['operation'] + ' ' + relation_filter_facts[i]['value'] + ' and '
				}
			}
			
			
			rule_details_main_html = '<div class="form-group">' + 
										'<label for="rule-condition-text">IF</label>' +
										'<textarea cols="20" rows="3" class="form-control" id="rule-condition-text" onclick="rememberCursorPostion(\'rule-condition-text\')">' + rule_initial_condition + '</textarea>' +
									'</div>' +
									'<div class="form-group">' + 
										'<label for="rule-effect-text">THEN ' + attribute_name + ' = </label>' +
										'<textarea cols="20" rows="3" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')"></textarea>' +
									'</div>' +
									'<div id="is-certain-fact-field">' +
										'<input type="checkbox" class="form-check-input" id="is_certain_fact" >' +
										'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
									'</div>';
								

			$('#rule-details-main').html(rule_details_main_html);

		} else {
			rule_details_main_html = 	'<div class="form-group">' + 
											'<label for="rule-effect-text">' + attribute_name + ' = </label>' +
											'<textarea cols="20" rows="5" class="form-control" id="rule-effect-text" onclick="rememberCursorPostion(\'rule-effect-text\')"></textarea>' +
										'</div>' +
										'<div id="is-certain-fact-field">' +
											'<input type="checkbox" class="form-check-input" id="is_certain_fact" >' +
											'<label class="form-check-label" for="is_certain_fact">Is Known Fact</label>' +
										'</div>';
										
			$('#rule-details-main').html(rule_details_main_html);
				
			
		}
	}
	
	
	function cancelRuleCreation() {
		$('#rule-details').html('');
		$('#available-variables-block').html('');
		$('#save-cancel-rule-buttons').html('');	
		$('#rule-pdf-panel').html('');
		$('#rule-pdf-panel-title').html('');
	}
	
	
	
	function rememberCursorPostion(text_area_id) {
		var myElement = document.getElementById(text_area_id);
		var startPosition = myElement.selectionStart;
		var endPosition = myElement.selectionEnd;
		
		new_rule_cursor_position = {'text_area_id':text_area_id, 'startPosition':startPosition, 'endPosition':endPosition};	
	}
	
	
	
	function selectAvailableVariable(object_number, attribute_name) {
		$('#available-variables-error-message').html('');
		var rule_text = document.getElementById(new_rule_cursor_position['text_area_id']).value;
		var new_rule_text = rule_text.substring(0, new_rule_cursor_position['startPosition']) + '[' + attribute_name + ']' + rule_text.substring(new_rule_cursor_position['endPosition'], rule_text.length);
		document.getElementById(new_rule_cursor_position['text_area_id']).value = new_rule_text;
		document.getElementById(new_rule_cursor_position['text_area_id']).selectionStart = new_rule_cursor_position['endPosition'] + attribute_name.length + 2;
		document.getElementById(new_rule_cursor_position['text_area_id']).selectionEnd = new_rule_cursor_position['endPosition'] + attribute_name.length + 2;
		new_rule_cursor_position['startPosition'] = new_rule_cursor_position['endPosition'] + attribute_name.length + 2;
		new_rule_cursor_position['endPosition'] =  new_rule_cursor_position['endPosition'] + attribute_name.length + 2;
		
		if 	($('#available-relation-variables-block').css('width') == '219px') {
			$('#available-relation-variables-block').animate({width: '0px'}, 300, 'linear');
			$('#available-variables-block').animate({width: '219px'}, 300, 'linear');
		}
	}
	
	
	
	function selectAvailableRelation(object_number, relation_id, relation_name) {
		objects_relations = objects_dict[object_number]['object_relations']
		var target_object_number = null;
		for (var i = 0; i < objects_relations.length ; i++) {
			if (objects_relations[i]['attribute_id'] == relation_id){
				target_object_number = objects_relations[i]['target_object_number'];
			}
		}
		
		if (target_object_number == null) {
			$('#available-variables-error-message').html('In the Scenario-view, please first link ' + objects_dict[object_number]['object_name'] + ' to another object using the --' + relation_name + '--&gt; relation');
		} else {
		
			var object_name = objects_dict[target_object_number]['object_name']
			var available_relation_variables_html = 	'<button type="button" class="btn btn-secondary" id="remove-related-attributes-button" onclick="removeRelatedAttributes()"><i class="fas fa-angle-left"></i></button>' + 
														'<div class="relations-variables-label">' + object_name + '\'s Variables:</div>' + 
														'<input type="text" class="form-control" id="selectRelatedAvailableVariable" onkeyup="filterRelatedVariables();" placeholder=" Search">' + 
														'<div class="available-variable-frame">' + 
															'<ul id="related-available-variables" class="input-group list-group">';
			
			var object_attributes = objects_dict[target_object_number]['object_attributes'];
			var attribute_ids = Object.keys(object_attributes);
			for (var i = 0; i < attribute_ids.length ; i++) {
				var attribute_id = attribute_ids[i];
				var attribute_name = object_attributes[attribute_id]['attribute_name']
				var attribute_data_type = object_attributes[attribute_id]['attribute_data_type']
				if (attribute_data_type == 'relation') {
					available_relation_variables_html += 		'<li class="list-group-item related-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableRelation(' + object_number + ', ' + attribute_id + ', \'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
				} else {
					available_relation_variables_html += 		'<li class="list-group-item related-var-item"><button class="btn btn-outline-secondary avail-var-button" type="button" onclick="selectAvailableVariable(' + object_number + ',\'' + attribute_name + '\')" scope="col">' + attribute_name + '</button></li>';
				}
			}
			available_relation_variables_html += 			'</ul>' + 
														'</div>';
													
			$('#available-relation-variables-block').html(available_relation_variables_html);
			
			// slide it into view
			$('#available-variables-block').animate({width: '0px'}, 300, 'linear');
			$('#available-relation-variables-block').animate({width: '219px'}, 300, 'linear');
			
			
			// add to the Rule Text
			var rule_text = document.getElementById(new_rule_cursor_position['text_area_id']).value;
			var new_rule_text = rule_text.substring(0, new_rule_cursor_position['startPosition']) + '[' + relation_name + '].' + rule_text.substring(new_rule_cursor_position['endPosition'], rule_text.length);
			document.getElementById(new_rule_cursor_position['text_area_id']).value = new_rule_text;
			document.getElementById(new_rule_cursor_position['text_area_id']).selectionStart = new_rule_cursor_position['endPosition'] + relation_name.length + 3;
			document.getElementById(new_rule_cursor_position['text_area_id']).selectionEnd = new_rule_cursor_position['endPosition'] + relation_name.length + 3;
			new_rule_cursor_position['startPosition'] = new_rule_cursor_position['endPosition'] + relation_name.length + 3;
			new_rule_cursor_position['endPosition'] =  new_rule_cursor_position['endPosition'] + relation_name.length + 3;
		}
	}
	
	
	
	function removeRelatedAttributes(){
		$('#available-relation-variables-block').html('');
		
		$('#available-relation-variables-block').animate({width: '0px'}, 300, 'linear');
		$('#available-variables-block').animate({width: '219px'}, 300, 'linear');
		
	}
	
	
	
	

	
		
		
		
	/*========================================================================*/
	/*=======================    SAVE RULE     ===============================*/
	/*========================================================================*/
	
	
	function make_executable(rule_text, object_number) {
		var has_error = false;
		var error_message = ""
		var used_attribute_ids = []
		
		
		// 0 CHECKS
		// I know it is idiotic to do security checks on the client side - I'll move this to the backend asap
		if (rule_text.length == 0) {
			error_message += 'Rule text missing; ';
			has_error = true;
		} else if (rule_text.length >= 500) {
			error_message += 'The Rule is ' + rule_text.length + ' characters long. Maximally 500 are allowed; ';
			has_error = true;
		}
		
		// Checking the Rule Text - only the commands in permitted_substrings are allowed==================
		//1 - REMOVING/REPLACING DELTA_T
		var executable = rule_text;
		var stripped_rule_text = rule_text;
		for (var i = 0; i < delta_t_list.length; i++) {
			var search_value = '[' + delta_t_list[i] + ']';
			executable = executable.split(search_value).join('(df.delta_t/' + timestep_units[i] +')');
			stripped_rule_text = stripped_rule_text.split(search_value).join(' ');
		}
		
		//2 - REMOVING/REPLACING VARIABLES
		var available_attribute_ids = [];
		var available_attribute_names = [];
		var available_attribute_datatypes = [];
		var object_numbers = Object.keys(objects_dict);
		for (var i = 0; i < object_numbers.length; i++) {
			var objects_attribute_ids = Object.keys(objects_dict[object_numbers[i]]['object_attributes']);
			for (var j = 0; j < objects_attribute_ids.length; j++) {
				available_attribute_ids.push(objects_attribute_ids[j]);
				available_attribute_names.push(objects_dict[object_numbers[i]]['object_attributes'][objects_attribute_ids[j]]['attribute_name']);
				available_attribute_datatypes.push(objects_dict[object_numbers[i]]['object_attributes'][objects_attribute_ids[j]]['attribute_data_type'])
			}
		}
		
		for (var i = 0; i < available_attribute_ids.length; i++) {
			var search_value = '[' + available_attribute_names[i] + ']';
			if (executable.indexOf(search_value)>=0){
				var data_type = available_attribute_datatypes[i];
				if (data_type == 'relation'){
					// first replace the ones with dot before, then set the replacement for the replacing without dot (necessary for multiple relations)
					executable = executable.split('.' + search_value).join('.rel' + String(available_attribute_ids[i]));
					executable = executable.split(search_value).join('df.rel' + String(available_attribute_ids[i]));
				} else if (['string', 'date'].includes(data_type)){
					executable = executable.split('.' + search_value).join('.attr' + String(available_attribute_ids[i]) + '"');
					executable = executable.split(search_value).join('df.attr' + String(available_attribute_ids[i]) + '"');
				} else {
					executable = executable.split('.' + search_value).join('.attr' + String(available_attribute_ids[i]));
					executable = executable.split(search_value).join('df.attr' + String(available_attribute_ids[i]));
				}

				stripped_rule_text = stripped_rule_text.split(search_value).join(' ');
				
				used_attribute_ids.push(available_attribute_ids[i])
			}	
		}
		
		//match unmatched " 
		var regex = /["a-zA-Z0-9\.]*"/g;
		var words_ending_on_quote = executable.match(regex);
		if (words_ending_on_quote){
			for (var i = 0; i < words_ending_on_quote.length; i++) {
			  if (words_ending_on_quote[i].substring(0,1) != '"') { //if they don't start with a quotationmark: add it
				 executable = executable.split(words_ending_on_quote[i]).join('"' + words_ending_on_quote[i]);
			  }
			}
		}
		
		//3 - REMOVING THE REST
		//function-characters
		var permitted_characters = ['\\(','\\)','\\[','\\]','\\{','\\}','\\+','\\*','\\.','-','/','%','.',',',':'] 
		for (var i = 0; i < permitted_characters.length; i++) {
			stripped_rule_text = stripped_rule_text.replace(new RegExp(permitted_characters[i], 'g'), ' ');
		}		
		//removing permitted commands
		var permitted_substrings = ['if','and','or']
		for (var i = 0; i < permitted_substrings.length; i++) {
			stripped_rule_text = stripped_rule_text.replace(new RegExp(permitted_substrings[i], 'g'), '');
		}
		//removing empyt spaces
		stripped_rule__remaining_words = stripped_rule_text.split(" ");
		for (var i =0; i < stripped_rule__remaining_words.length; i++){
			if (stripped_rule__remaining_words[i] == ''){
				stripped_rule__remaining_words.splice(i, );
			}
		}
		//if there's still something remaining: ERROR
		if (stripped_rule__remaining_words.length > 0) {
			error_message += 'The following commands are not permitted in the Rule: ' + stripped_rule__remaining_words.join(',') + '; ';
			has_error = true;
		}
		
		
		
		executable_dict = { 'has_error':has_error,
						'error_message': error_message,
						'executable':executable,
						'used_attribute_ids':used_attribute_ids};
		return executable_dict;
	}
	
	
	
	function saveBehaviourRule(rule_id, attribute_id, attribute_name, object_number) {
		rule_dict = {}
		
		// setting: id, changed_var_attribute_id, has_probability_1, probability, standard_dev
		rule_dict['id'] = rule_id;
		rule_dict['changed_var_attribute_id'] = attribute_id;
		rule_dict['has_probability_1'] = $('#is_certain_fact').is(':checked');
		rule_dict['probability'] = null;
		rule_dict['standard_dev'] = null;
		rule_dict['learn_posterior'] = !rule_dict['has_probability_1'];
		rule_dict['changed_var_data_type'] = objects_dict[object_number]['object_attributes'][attribute_id]['attribute_data_type'];
		
		
		// setting: condition_text, condition_exec, is_conditionless
		var used_attribute_ids = []
		
		var has_if_condition = $('#has_if_condition').is(':checked');
		if (has_if_condition){
			var condition_text = $('#rule-condition-text').val();
			executable_dict = make_executable(condition_text, object_number);
			if (executable_dict['has_error']) {
				alert('Error with IF: ' + executable_dict['error_message']);
				return;
			}
			used_attribute_ids = executable_dict['used_attribute_ids'];
			rule_dict['condition_text'] = condition_text;
			rule_dict['condition_exec'] = executable_dict['executable'];
			rule_dict['is_conditionless'] = false;
	
		} else {	
			rule_dict['condition_text'] = '';
			rule_dict['condition_exec'] = '';
			rule_dict['is_conditionless'] = true;
		}
		
		
		// setting: effect_text, effect_exec
		var effect_text = $('#rule-effect-text').val().trim();
		executable_dict = make_executable(effect_text, object_number);
		if (executable_dict['has_error']) {
			alert('Error with THEN: ' + executable_dict['error_message']);
			return;
		}
		rule_dict['effect_text'] = effect_text;
		rule_dict['effect_exec'] = executable_dict['executable'];
		
		
		// setting: used_attribute_ids
		$.each(executable_dict['used_attribute_ids'], function(i, el){   // append the new used_attribute_ids, if not found already in the list
			if($.inArray(el, used_attribute_ids) === -1) used_attribute_ids.push(el);
		});
		rule_dict['used_attribute_ids'] = used_attribute_ids;
		

		// setting: effect_is_calculation
		if (executable_dict['executable'].indexOf('df.') >=0) {
			rule_dict['effect_is_calculation'] = true;
		} else {
			rule_dict['effect_is_calculation'] = false;
			var effect_exec = rule_dict['effect_exec'];
			if (effect_exec[0] == "'" || effect_exec[0] == '"') {
				effect_exec = effect_exec.substring(1, effect_exec.length - 1);
			} else if (effect_exec.includes('.')){
				effect_exec = parseFloat(effect_exec);
			} else {
				effect_exec = parseInt(effect_exec);
			}
			rule_dict['effect_exec'] = JSON.stringify(effect_exec);
			
		}
		


		var xmlhttp = new XMLHttpRequest();  
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				var new_rule_id = this.responseText;
				if (rule_id == null){
					objects_dict[object_number]['object_rules'][attribute_id]['execution_order'].push(new_rule_id);
				}
				
				rule_dict['id'] = new_rule_id;
				objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][new_rule_id] = rule_dict;
				populateTheRulePanels(object_number, attribute_id, attribute_name);	
			}
		};
		xmlhttp.open("POST", "/tool/save_rule/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(rule_dict));
		
		// empty the right part of the modal
		cancelRuleCreation();
	}
	
	
	
	
	


</script>



<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.0/jquery-ui.js"></script>

<script>
	
	// in array, move element from one position to another
	function move(arr, old_index, new_index) {
		while (old_index < 0) {
			old_index += arr.length;
		}
		while (new_index < 0) {
			new_index += arr.length;
		}
		if (new_index >= arr.length) {
			var k = new_index - arr.length;
			while ((k--) + 1) {
				arr.push(undefined);
			}
		}
		 arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);  
	   return arr;
	}
	

	jQuery(document).ready(function($){
		
		/*---------------------------------------------------------------*\
		 * Drag & Drop  - for Variable selection/sorting in left panel
		\*---------------------------------------------------------------*/
		$(function() {
			$( ".rule-panel-body" ).sortable({
				connectWith: ".list-group",
				update: function(event, ui) {
					if (ui.sender == null && this.id == 'rules-list') {
						// move the + button to the bottom
						document.getElementById('rules-list').appendChild(document.getElementById('plus-button-list-group-item'));
					
						// move within rules-list
						var object_number = parseInt(ui.item[0].getAttribute('data-object-number'));
						var	attribute_id = parseInt(ui.item[0].getAttribute('data-attribute-id'));
						var	rule_id = parseInt(ui.item[0].getAttribute('data-rule-id'));
						
						execution_order = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'];
						old_index = execution_order.indexOf(rule_id);
						new_index = ui.item.index();
						objects_dict[object_number]['object_rules'][attribute_id]['execution_order'] = move(execution_order, old_index, new_index);
					}
				},
				receive: function(event, ui) {					
					var object_number = parseInt(ui.item[0].getAttribute('data-object-number'));
					var	attribute_id = parseInt(ui.item[0].getAttribute('data-attribute-id'));
					var	rule_id = parseInt(ui.item[0].getAttribute('data-rule-id'));
					var sender = ui.sender[0].id;
					var receiver = this.id;
					
					if (receiver == 'not-used-rules-list' && sender == 'rules-list') {
						objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id] = objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
						delete objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id];
						
						// update the execution_order
						var execution_order = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'];
						old_index = execution_order.indexOf(rule_id);
						execution_order.splice(old_index,1);
						objects_dict[object_number]['object_rules'][attribute_id]['execution_order'] = execution_order;
					}
					
					if (receiver == 'rules-list' && sender == 'not-used-rules-list') {
						objects_dict[object_number]['object_rules'][attribute_id]['used_rules'][rule_id] = objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id];
						delete objects_dict[object_number]['object_rules'][attribute_id]['not_used_rules'][rule_id];
						
						// move the + button to the bottom
						document.getElementById('rules-list').appendChild(document.getElementById('plus-button-list-group-item'));
						
						// update the execution_order
						new_index = ui.item.index();
						var execution_order = objects_dict[object_number]['object_rules'][attribute_id]['execution_order'];
						execution_order.splice(new_index, 0, rule_id);
						objects_dict[object_number]['object_rules'][attribute_id]['execution_order'] = execution_order;
						
						
					}
				}         
			}).disableSelection();
		});
		
		
	});
</script>
