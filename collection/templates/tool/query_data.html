{% extends 'layouts/base_tool.html' %}
{% load staticfiles %}

<!-- 
####################################################################
# This file is part of the Tree of Knowledge project.
# Copyright (C) Benedikt Kleppmann - All Rights Reserved
#
# Unauthorized copying of this file, via any medium is strictly prohibited
# Proprietary and confidential
# Written by Benedikt Kleppmann <benedikt@kleppmann.de>, February 2021
#####################################################################
-->

{% block title %}
	Tree of Knowledge - Query Data
{% endblock %}

{% block additionalcss %}
<script type="text/javascript" src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/bootstrap-3.4.0.min.css' %}" />
<link rel="stylesheet" href="{% static 'css/bootstrap-datetimepicker.min.css' %}" />

<style>
	/* ------------------------------------------------------------- */
	/* --- THE LEFT SIDE  ------------------------------------------ */
	/* ------------------------------------------------------------- */

	.input-field {
	    width: 180px;
	}
	
	#run-query-button {
		float: right;
		padding-left: 6px;
		padding-right: 6px;
		padding-top: 5px;
		padding-bottom: 5px;
		margin-top: 10px;
	}
	
	/* --- Choose Object Type Popover ----------------------------------- */
	.popover {
		max-width: 730px;
	}
	
	.choose-object-type-content  {
		width: 700px;
	}
	
	#search-box{
		width: 150px;
		margin-bottom: 10px;
	}
	
	.object-type-spec-box {
		border: solid 1px grey;
		height: calc(100vh - 345px);
		overflow: auto;
	}
	
		/* --- Additional Fact Row -------------------------------------------- */
		
	.new-fact-list-item {
		min-height: 43px;
		display: table;
		min-width: 100%;
	}
		
		.dropdown-menu {
			padding:0;
		}
		
		.search {
			height:40px;
			border-radius:4px;
			border: 1px solid #999;
		}
		
		div.inline { 
			float:left; 
			margin-right: 5px;
		}
		
		
		.broad {
			padding-top: 3px;
			padding-bottom: 1px;
			padding-right: 3px;
			padding-left: 2px;
			height:43px;
		}
		
		.narrow {
			padding-top: 4px;
			padding-bottom: 4px;
		}
		
		
		.form-group {
			margin-bottom: 0px;
		}
		
		div.inline {
			margin-right:3px;
		}
		

		
		.dropdown-item {
			padding: 6px 10px;
			border-radius:2px;
			width:150px
		}
		
		
		/* --- Additional Attribute Drop Down ----------------------------------- */
		
		.list-group.drop-down-display {
			margin-bottom:3px;
			max-height: 250px;
			overflow-y: scroll;
		}

		.dropdown {
			margin-left:2px;
		}
		
		.dropdown-item {
			padding: 6px 10px;
			border-radius:2px;
			width:150px
		}
		
		.dropdown-item-button {
			padding: 6px 10px;
			border-radius:2px;
			width:150px;
			margin-left:17px;
			margin-bottom:3px;
			border-radius:5px;
		}
		
		/* --- DateTime Pickers ----------------------------------- */
		
		.datetimepicker {
			width: 100px;
		}
		
		#from-label {
			padding-left: 16px;
			padding-right: 0px;
			padding-top: 6px;
			width: 56px;
		}
		
		#to-label {
			padding-left:13px;
			padding-right: 0px;
			padding-top: 6px;
			width: 36px;
			
		}
		
		/* --- Spinner on 'Get Data'-Button ----------------------------------- */

		#run-query-button-icon{
			text-align: center
		}
	
		.lds-dual-ring {
		  display: inline-block;
		  width: 16px;
		  height: 16px;
		  //width: 64px;
		  //height: 64px;
		}
		.lds-dual-ring:after {
		  content: " ";
		  display: block;
		  //width: 46px;
		  //height: 46px;
		  width: 14px;
		  height: 14px;
		  margin: 1px;
		  border-radius: 50%;
		  //border: 5px solid #fed;
		  border: 2px solid #fed;
		  border-color: #fed transparent #fed transparent;
		  animation: lds-dual-ring 3.2s linear infinite;
		}
		@keyframes lds-dual-ring {
		  0% {
			transform: rotate(0deg);
		  }
		  100% {
			transform: rotate(360deg);
		  }
		}
	/* ------------------------------------------------------------- */
	/* --- THE RIGHT SIDE  ------------------------------------------ */
	/* ------------------------------------------------------------- */
	
	#entity-count {
		text-align: center;
		margin-bottom: 10px;
	}
	
	/* --- Table box ----------------------------------------------------------- */
	
	
	#box {
		display:inline-block;
		vertical-align: top;
		border: 1px solid rgb(210, 210, 210);
		padding:2px;
		height: calc(100vh - 280px);
	}

	
	.table-box {
		width: max-content;
		width: intrinsic;           /* Safari/WebKit uses a non-standard name */
		width: -moz-max-content;    /* Firefox/Gecko */
		width: -webkit-max-content; /* Chrome */
	}
	
	#uploaded_table {
		margin-left: 6px;
		margin-right: 4px;
		margin-bottom:0px;
		background-color:rgb(240, 240, 240);
	}
	
	/* --- Table format -------------------------------------------------------- */
	.table {
		margin-bottom:0px;
		width: 2705px;
		overflow: auto;
	}
	

	.table thead, .table tbody, .table tr, .table td, .table th { display: block; text-align:left; }

	#uploaded_table td > span {
		visibility: hidden;
	}
		
	.table  tr:after {
		content: ' ';
		display: block;
		visibility: hidden;
		clear: both;
	}

	
	.table thead th {
		height: max-content;
		height: intrinsic;           /* Safari/WebKit uses a non-standard name */
		height: -moz-max-content;    /* Firefox/Gecko */
		height: -webkit-max-content; /* Chrome */
	}
	
	
	.table thead {
		margin-left:20px;
	}
	
	.table thead > tr > th {border-bottom: 0;}

	.table-body {
		height: calc(100vh - 340px);
		overflow-y: auto;
		direction: rtl;
	}

	.table tbody td, .table thead th {
		width: 140px;
		float: left;
	}
	
	uploaded_table th, uploaded_table tr {
		border-left:1px solid black;
	}
	
	.table thead > tr > ts:hover {
		background-color: rgb(225, 225, 225);
	}
		
	/* --- Table-attribute selection (the dropdowns at the top) -------------------------------------------------------- */
	
	#table-attribute-selection {
	    margin-left: 143px;
		margin-bottom: 9px
	}
	
	
	.table-attribute-dropdown {
		width: 121px;
		margin-left: 15px;
		display: inline-block;
	}
	
	.related-attribute-dropdown {
		margin-left: 15px;
	}
	
	/*  --- Sort table triangles ---------------------------------------------------------------------------------------------------*/
	
	.sort-triangle-div {
		padding-left: 5px;
		padding-right: 0px;
		padding-top: 0px;
		padding-bottom: 0px;
		margin-bottom: -32px;
	}
	
	
	.sort-triangle {
		color: rgb(145, 145, 145);
		font-size: 9px;
	}									
	
	.glyphicon-triangle-top  {
		margin-bottom: -31px;
	}
	
	/*  --- Download Buttons ---------------------------------------------------------------------------------------------------*/
	#download-buttons {
		float: right;
		margin-top: 10px;
		
	}
	.download-button {
		margin-left: 5px;
	}
	
	
</style>
{% endblock %}

{% block content %}
	
	<h1>Query Data</h1> 
	<div class="row">
		<!-- THE LEFT SIDE-->
		<div class="col-sm-6 col-md-5 col-lg-3 form">
		
		
			<div class="form-group">
				<label for="object_type">Object Type</label>
				<input type="text" id="object_type" class="form-control input-field" placeholder="Object Type" autocomplete="off">
				<input type="hidden" id="object_type_id">
			</div>
			<br>
			<div class="form-group">
				<label for="object_type">Filters</label>
				<ul class="list-group" id="new_object_facts_list"> 
					<li class="list-group-item broad new-fact-list-item" > <!-- Object Attribute 1 -->
						<div>
							<div class="dropdown inline">
								<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name1">Attribute<span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>
								<div class="dropdown-menu" aria-labelledby="attributeMenu1">
									<div id="attributeList1">
										<input type="text" class="search" id="dropDonwSearch1" onkeyup="filterAttributeDropDown(1)" placeholder=" Search">
										<ul id="drop-down-display1" class="list-group drop-down-display"></ul>									
										<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(1);">Reset</button>
									</div>
								</div>
							</div>
							<input type="hidden" id="attribute1" name="attribute1" value="">
							<div class="form-group inline operator">
								<select class="form-control form-control-lg" id="operator1" name="operator1">
									<option value="=" selected>=</option>
									<option value=">">></option>
									<option value="<"><</option>
									<option value="in">in</option>
								</select>
							</div> 
							<div class="form-group inline value">
								<input type="text" class="form-control" id="value1" name="value1" value="" size="15">
							</div>
							<button type="button" id="format_violation1" class="btn btn-danger pull-right" data-container="body" data-toggle="popover" data-placement="right" data-html="true" title="Invalid fact" style="display:none;" data-content="">!</button>
						</div>
					</li>
					<li class="list-group-item broad new-fact-list-item" > <!-- Object Attribute 2 -->
						<div>
							<div class="dropdown inline" >
								<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name2">Attribute<span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>
								<div class="dropdown-menu" aria-labelledby="attributeMenu2">
									<div id="attributeList2">
										<input type="text" class="search" id="dropDonwSearch2" onkeyup="filterAttributeDropDown(2)" placeholder=" Search">
										<ul id="drop-down-display2" class="list-group drop-down-display"></ul>									
										<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(2);">Reset</button>
									</div>
								</div>
							</div>
							<input type="hidden" id="attribute2" name="attribute2" value="">
							<div class="form-group inline operator">
								<select class="form-control form-control-lg" id="operator2" name="operator2">
									<option value="=" selected>=</option>
									<option value=">">></option>
									<option value="<"><</option>
									<option value="in">in</option>
								</select>
							</div> 
							<div class="form-group inline value">
								<input type="text" class="form-control" id="value2" name="value2" value="" size="15">
							</div>
							<button type="button" id="format_violation2" class="btn btn-danger pull-left" data-container="body" data-toggle="popover" data-placement="right" data-html="true" title="Invalid fact" style="display:none;" data-content="">!</button>
						</div>
					</li>
					<li class="list-group-item narrow" id="create-new-object-fact-button">  	<button id="make-new-additional-fact-button" type="button" class="btn btn-outline-dark" onclick="newAdditionalFactInput('all');" ><i class="fas fa-plus"></i></button> </li>
				</ul>  
			</div>
			
			<div class="form-group row">  
				<label for="desired_time" class="col-sm-4 col-form-label">Time</label>
			</div>
			<div class="form-group row"> 
					<div class="col-sm-2">From:</div>
					<input name="specified_start_time" id="specified_start_time" class="datetimepicker form-control col-sm-4" value="2000-01-01">
					<div id="to-label" class="col-sm-2">To:</div>
					<input name="specified_end_time" id="specified_end_time" class="datetimepicker form-control col-sm-4" value="2020-01-01">
			</div> 
			<button type="button" id="run-query-button" class="btn btn-success" onclick="runQuery()">Get Data<div id="run-query-button-icon"><span class="glyphicon glyphicon-chevron-right"></span><div></button>
		</div>
		
		<!-- THE RIGHT SIDE-->
		<div class="col-sm-6 col-md-7 col-lg-9">
			<div id="entity-count"></div>
			
			<div class="form" id="table-attribute-selection">
				<span id="end-of-attribute-selection"><span>
			</div>
			
			<div id="box" style="display:none;">		
				<div class="table-box">
					<div id="uploaded_table"></div>
				</div>
			</div>
			<div id="download-buttons" style="display:none;">
				<button type="button" class="btn btn-primary download-button" onclick="downloadData('csv')">Download as csv</button>
				<button type="button" class="btn btn-primary download-button" onclick="downloadData('xls')">Download as excel</button>
			</div>
		</div>
		
		
	</div>                                




	
	
	
<script>
	// GLOBAL VARIABLES:
	var object_hierachy_tree = {{ object_hierachy_tree|safe }};
	var largest_dropdown_number = 0;
	var last_queried_object_id = null;	
	var table_attributes = [];
	var table_body = {};
	var selected_table_attributes = [{'attribute_id': 'time', 'attribute_name': 'Time'}];
	
	var related_table_attributes = [];
	var related_table_body = {};
	
	
	
	
	/*========================================================================*/
	/*=================    OBJECT TYPE      ==================================*/
	/*========================================================================*/



	// Set up the Object Hierachy Tree =============================================================	
	function loadObjectHierachyTree() {
			
		// search 
		var to = false;
		$('#object_type').keyup(function () {
			if(to) { clearTimeout(to); }
			to = setTimeout(function () {
				var v = $('#object_type').val();
				$('#container-for-object-tree').jstree(true).search(v);
			}, 250);
		});
		
		// display object hierachy tree
		$('#container-for-object-tree').jstree({
			'core' : {
				"animation" : 0,
				"check_callback" : true,
				'force_text' : true,
				"themes" : { "stripes" : false,
							 "icons": false},	
				'data' : object_hierachy_tree
			},
			"types" : {
				"root" : { "icon" : "/static/3.3.7/assets/images/tree_icon.png", "valid_children" : ["default"] },
				"default" : { "valid_children" : ["default","file"] },
				"file" : { "icon" : "glyphicon glyphicon-file", "valid_children" : [] }
			},
			"themes":{"icons":false},
			"plugins" : [ "contextmenu", "dnd", "search", "state", "types" ]
		});	

		// Select node in object hierachy tree =======================================
		$('#container-for-object-tree')
			.on('select_node.jstree', function (e, data) {
			  
			var node_id = data.selected[0];
			var object_type_name = data.instance.get_node(node_id).text;
			$("#object_type").val(object_type_name);
			$("#object_type_id").val(node_id);
			
			//for the "+"-button change it so that the new attribute-drop-downs will list the object-types attributes
			$("#make-new-additional-fact-button").attr("onclick", "newAdditionalFactInput('" + node_id + "');")
			
			//For all Attribute-dropdowns: remove the old selection and load a list of possible_attributes 
			for (var i = 1; i <= number_of_additional_object_facts; i++) {
				resetAttribute(i);
				makeObjectsAdditionalAttributesDropdown(node_id , i);
			}
			largest_dropdown_number = 0;   //reset largest_dropdown_number
			
		});
		
		  
	}
	
	
	/*========================================================================*/
	/*=====================    FILTERS      ==================================*/
	/*========================================================================*/
	
	/*=============  MAKE NEW ADDITIONAL FACT LIST ITEM  ================================================================ */
	var number_of_additional_object_facts = 2;

	function newAdditionalFactInput(object_type_id) { 


		number_of_additional_object_facts += 1;
		fact_number = number_of_additional_object_facts;
		var insert_before = '#create-new-object-fact-button';

		
		var additionalFactHTMLString = 	'<li class="list-group-item broad new-fact-list-item" >' +
											'<div">' + 
												'<div class="dropdown inline" >' + 
													'<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu' + fact_number + '" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name' + fact_number + '">Attribute<span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>' + 
													'<div class="dropdown-menu" aria-labelledby="attributeMenu' + fact_number + '">' + 
														'<div id="attributeList' + fact_number + '">' + 
															'<input type="text" class="search" id="dropDonwSearch' + fact_number + '" onkeyup="filterAttributeDropDown(' + fact_number + ')" placeholder=" Search">' +
															'<ul id="drop-down-display' + fact_number + '" class="list list-group drop-down-display"></ul>' +															
															'<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(' + fact_number + ');">Reset</button>' +
														'</div>' + 
													'</div>' + 
												'</div>' + 
												'<input type="hidden" id="attribute' + fact_number + '" name="attribute' + fact_number + '" value="">' + 
												'<div class="form-group inline operator">' + 
													'<select class="form-control form-control-lg" id="operator' + fact_number + '" name="operator' + fact_number + '">' + 
														'<option value="=" selected>=</option>' + 
														'<option value=">">></option>' + 
														'<option value="<"><</option>' + 
														'<option value="in">in</option>' +
													'</select>' + 
												'</div> ' + 
												'<div class="form-group inline value">' + 
													'<input type="text" class="form-control" id="value' + fact_number + '" name="value' + fact_number + '" size="15">' + 
												'</div>' + 
											'</div>' +
											'<button type="button" id="format_violation' + fact_number + '" class="btn btn-danger pull-right" data-container="body" data-toggle="popover" data-placement="right" data-html="true" title="Invalid fact" style="display:none;" data-content="">!</button>' +
										'</li>';
										
		$(additionalFactHTMLString).insertBefore(insert_before);
		
		makeObjectsAdditionalAttributesDropdown(object_type_id, fact_number);
		
	}
	
	
	
	/*===========================================================================================*/
	/*==========  FILTER - ATTRIBUTE DROP DOWNS (in "Create Object Type" Modal)  ================*/
	/*===========================================================================================*/								
								
										
	/*=============  POPULATE AdditionalAttribute-DROPDOWNS  ================================================================ */

	function makeObjectsAdditionalAttributesDropdown(object_type_id, attribute_number){

		var xhttp = new XMLHttpRequest();       
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				list_group_html_string = ""
				
				var possible_attributes = JSON.parse(this.responseText);
				
				for (var i = 0; i < possible_attributes.length; i++) {
					list_group_html_string += '<li class="list-group-item narrow"><button class="name dropdown-item btn btn-secondary" type="button" onclick="selectAdditionalAttribute(' + attribute_number + ', this.innerHTML, ' + possible_attributes[i]['attribute_id'] + ', \'' + possible_attributes[i]['attribute_data_type'] + '\', \'' + possible_attributes[i]['attribute_first_relation_object_type'] + '\')" data-attribute-id=' + possible_attributes[i]['attribute_id'] + '>' + possible_attributes[i]['attribute_name'] + '</button></li>'
					
				}
				
				$("#drop-down-display" + attribute_number).html(list_group_html_string);
				
			}
		};

		xhttp.open("GET", "/tool/get_possible_attributes?object_type_id=" + object_type_id , true);
		xhttp.send();
	}


	function filterAttributeDropDown(attribute_number){	
		var current_query = $('#dropDonwSearch' + attribute_number).val().toLowerCase();
		if (current_query !== "") {
			$("#drop-down-display" + attribute_number + " li").hide();
			$("#drop-down-display" + attribute_number + " li").each(function(){
				var current_keyword = $(this).text().toLowerCase();
				if (current_keyword.indexOf(current_query) >=0) {
					$(this).show();    	 	
				};
			});    	
		} else {
			$("#drop-down-display" + attribute_number + " li").show();
		};
	}


	/*=============  SELECT DROPDOWN OPTION  ================================================================ */
	//function selectAdditionalAttribute(attribute_number , attribute_name, attribute_id) {
	//	$('#attribute-name' + attribute_number).html(attribute_name);
	//	$('#attribute' + attribute_number).attr('value', attribute_id);									
	//}
	
	function selectAdditionalAttribute(attribute_number , attribute_name, attribute_id, attribute_data_type, attribute_first_relation_object_type) {
		$('#attribute-name' + attribute_number).html(attribute_name);
		$('#attribute' + attribute_number).attr('value', attribute_id);	

		// IF A RELATION WAS CHOSEN...
		if (attribute_data_type == 'relation') {
			
			// draw relation button
			var relation_number = 'Relation' + attribute_number;
			attribute_selection_dropdown =		'<div id="relation-dropdown' + attribute_number + '" class="dropdown inline" style="float:left;">' + 
													'<button class="btn btn-secondary dropdown-toggle" type="button" id="attributeMenu' + relation_number + '" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="attribute-name' + relation_number + '">Attribute</span> &nbsp;<i class="fas fa-caret-down fa-sm"></i></button>' + 
													'<div class="dropdown-menu" aria-labelledby="attributeMenu' + relation_number + '">' + 
														'<div id="attributeList' + relation_number + '">' + 
															'<input type="text" class="search" id="dropDonwSearch' + relation_number + '" onkeyup="filterAttributeDropDown(\'' + relation_number + '\')" placeholder=" Search">' + 
															'<ul id="drop-down-display' + relation_number + '" class="list-group drop-down-display"></ul>' + 
															'<button class="btn btn-warning dropdown-item-button" type="button" onclick="resetAttribute(' + relation_number + ');">Reset</button>' +
														'</div>' + 
													'</div>' + 
													'<input type="hidden" id="attribute' + relation_number + '" name="attribute' + relation_number + '" value>' +
												'</div>';
			$(attribute_selection_dropdown).insertAfter($('#attribute' + attribute_number)); 
			
			//populate the relation-dropdown
			var xhttp = new XMLHttpRequest();       
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					list_group_html_string = ""
					var possible_attributes = JSON.parse(this.responseText);
					for (var i = 0; i < possible_attributes.length; i++) {
						list_group_html_string += '<li class="list-group-item narrow"><button class="name dropdown-item btn btn-secondary" type="button" onclick="selectAdditionalAttribute(\'' + relation_number + '\', this.innerHTML, ' + possible_attributes[i]['attribute_id'] + ', \'' + possible_attributes[i]['attribute_data_type'] + '\', \'' + possible_attributes[i]['attribute_first_relation_object_type'] + '\')" data-attribute-id=' + possible_attributes[i]['attribute_id'] + '>' + possible_attributes[i]['attribute_name'] + '</button></li>'
					}
					$("#drop-down-display" + relation_number).html(list_group_html_string);
					
				}
			};
			xhttp.open("GET", "/tool/get_possible_attributes?object_type_id=" + attribute_first_relation_object_type , true);
			xhttp.send();
		} else {
			$('#relation-dropdown' + attribute_number).remove();
		}
	}


	/*=============  CHECK ADDITIONAL FACTS FORMATS  ================================================================ */
		function checkAdditionalFactFormats() {
		for (var fact_number = 1; fact_number <= number_of_additional_object_facts; fact_number++) {
			var attribute_id = $('#attribute' + fact_number).val();
			var operator = $('#operator' + fact_number).val();
			var value = $('#value' + fact_number).val();
			
			if (attribute_id != '' && value != ''){
			
				// non-relation
				if ($('#attributeRelation' + fact_number).length == 0) {
					var xhttp = new XMLHttpRequest();       
					xhttp.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {

							var response_dict = JSON.parse(this.responseText);
							var format_violation_text = response_dict['format_violation_text']
							var returned_fact_number = response_dict['fact_number']
							
							if (format_violation_text == "") {
								$("#format_violation" + returned_fact_number).attr("style", "display:none;");
								$("#format_violation"  + returned_fact_number).popover('hide');
								document.getElementById("attribute" + returned_fact_number).disabled = false; // this attribute won't be sent in the POST when pressing 'Next' - the backend thus knows that the fact is invalid
							} else {
								$("#format_violation" + returned_fact_number).attr("style", "display:block;");
								document.getElementById("attribute" + returned_fact_number).disabled = true;
								
							}
							
							$("#format_violation" + returned_fact_number).attr("data-content", format_violation_text);
						}
					};
					
					xhttp.open("GET", "/tool/check_single_fact_format?fact_number=" + String(fact_number) + "&attribute_id=" + attribute_id + '&operator=' + operator + '&value=' + value, true);
					xhttp.send();
					
					
				} else { //relation
					
					if (operator != '=') {
						$("#format_violation" + fact_number).attr("data-content", "In order to find the correct entity the operator must be set to '='");
					} else {

						relation_id = $('#attribute' + fact_number).val();
						attribute_id = $('#attributeRelation' + fact_number).val();
						
						var xhttp = new XMLHttpRequest();       
						xhttp.onreadystatechange = function() {
							if (this.readyState == 4 && this.status == 200) {

								var response_dict = JSON.parse(this.responseText);
								var matching_object_id = response_dict['matching_object_id']
								var returned_fact_number = response_dict['fact_number']
								
								if (matching_object_id === parseInt(matching_object_id, 10)) {  //if matching_object_id is Integer...
									$('#value' + returned_fact_number).val(matching_object_id);
									$("#format_violation" + returned_fact_number).attr("style", "display:none;");
									$("#format_violation"  + returned_fact_number).popover('hide');
									document.getElementById("attribute" + returned_fact_number).disabled = false; // this attribute won't be sent in the POST when pressing 'Next' - the backend thus knows that the fact is invalid
								} else {
									$("#format_violation" + returned_fact_number).attr("style", "display:block;");
									document.getElementById("attribute" + returned_fact_number).disabled = true;
									$("#format_violation" + returned_fact_number).attr("data-content", 'No exact match could be found. Please <a href="{% url 'query_data' %}" target="_blank">look in the data</a> for the correct matching-value to use');
									
								}
								
								
							}
						};
						
						// this function should be extended to also find fuzzy matches and suggest them in the format_violation_text
						xhttp.open("GET", "/tool/find_single_entity?fact_number=" + String(fact_number) + "&relation_id=" + String(relation_id) + "&attribute_id=" + attribute_id + '&value=' + value, true);
						xhttp.send();
					
					}		
				}
			}
		}									
	}
	
	/*
	function checkAdditionalFactFormats() {
		for (var fact_number = 1; fact_number <= number_of_additional_object_facts; fact_number++) {
			var attribute_id = $('#attribute' + fact_number).val();
			var operator = $('#operator' + fact_number).val();
			var value = $('#value' + fact_number).val();
			
			var xhttp = new XMLHttpRequest();       
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {

					var response_dict = JSON.parse(this.responseText);
					var format_violation_text = response_dict['format_violation_text']
					var returned_fact_number = response_dict['fact_number']
					
					if (format_violation_text == "") {
						$("#format_violation" + returned_fact_number).attr("style", "display:none;");
						$("#format_violation"  + returned_fact_number).popover('hide');
						document.getElementById("attribute" + returned_fact_number).disabled = false; // this attribute won't be sent in the POST when pressing 'Next' - the backend thus knows that the fact is invalid
					} else {
						$("#format_violation" + returned_fact_number).attr("style", "display:block;");
						document.getElementById("attribute" + returned_fact_number).disabled = true;
						
					}
					
					$("#format_violation" + returned_fact_number).attr("data-content", format_violation_text);
					console.log("-------------------------");
					console.log(response_dict[format_violation_text]);
				}
			};
			
			xhttp.open("GET", "/tool/check_single_fact_format?fact_number=" + String(fact_number) + "&attribute_id=" + attribute_id + '&operator=' + operator + '&value=' + value, true);
			xhttp.send();
		}									
	}*/


	/*=============  RESET DROPDOWN SELECTION  ================================================================ */
	function resetAttribute(attribute_number){
		$('#attribute-name' + attribute_number).html('Attribute');
		document.getElementById('attribute' + attribute_number).value = '';	
		document.getElementById('operator' + attribute_number).selectedIndex = 0;
		document.getElementById('value' + attribute_number).value = '';	
		checkAdditionalFactFormats();
	}


	/*========================================================================*/
	/*========================================================================*/
	/*========================================================================*/
	/*====================    THE RIGHT SIDE      ============================*/
	/*========================================================================*/
	/*========================================================================*/
	/*========================================================================*/
	
	
	function runQuery(){
		
		$("#run-query-button-icon").html('<div class="lds-dual-ring"></div>');
		
		object_type_id = $("#object_type_id").val();
		var reset_attribute_selection = ((last_queried_object_id == object_type_id) ? false : true);
		last_queried_object_id = object_type_id; // for next time...
	
		//for every attribute-specification, get the attribute, operator and value and save to the object_dict
		filter_facts = [];
		for (var fact_number = 1; fact_number <= number_of_additional_object_facts; fact_number++) {
			new_fact = {}
			new_fact['attribute'] = $("#attribute-name" + fact_number).html();
			new_fact['attribute_id'] = $("#attribute" + fact_number).val();
			new_fact['operation'] = $("#operator" + fact_number).val();
			if (new_fact['operation'] == 'in') {
				new_fact['value'] = JSON.parse($("#value" + fact_number).val());
			} else {
				new_fact['value'] = $("#value" + fact_number).val();
			}
			var has_no_format_error = ($("#format_violation" + fact_number).attr("style") == "display:none;");
			
			if (new_fact['attribute'] != "" && new_fact['value'] != "" && has_no_format_error) {
				filter_facts.push(new_fact);
			}
		}
		
		specified_start_time = $("#specified_start_time").val();
		specified_end_time = $("#specified_end_time").val();
		specified_start_time = new Date(specified_start_time).getTime() / 1000
		specified_end_time = new Date(specified_end_time).getTime() / 1000
		
		
		request_body = {};
		request_body['object_type_id'] = object_type_id;
		request_body['filter_facts'] = filter_facts;
		request_body['specified_start_time'] = specified_start_time;
		request_body['specified_end_time'] = specified_end_time;
		
		var xmlhttp = new XMLHttpRequest();       
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {

				$("#run-query-button-icon").html('<span class="glyphicon glyphicon-chevron-right"></span>');
				$("#run-query-button-icon").removeClass('btn-warning');
				$("#run-query-button-icon").addClass('btn-success');
				var response = JSON.parse(this.responseText);
				table_body = response['table_body']
				table_attributes = response['table_attributes']
				
				//reset everything
				$("#entity-count").html(response['number_of_entities_found'] + " entities found");
				$("#uploaded_table").html("");
				
				if (reset_attribute_selection) {
					$("#table-attribute-selection").html('<span id="end-of-attribute-selection"><span>');
					$("#download-buttons").attr("style","display:none;");
					$("#box").attr("style","display:none;");
					selected_table_attributes = [{'attribute_id': 'time', 'attribute_name': 'Time'}]
					if (response['number_of_entities_found'] > 0){
						drawTheFirstDropDown();
					}
				} else {
					drawTheTable();
				}
			}
			
			if (this.readyState == 4 && this.status == 500) {
				$("#run-query-button-icon").html('<span class="glyphicon glyphicon-chevron-right"></span>');
				$("#run-query-button-icon").removeClass('btn-success');
				$("#run-query-button-icon").addClass('btn-warning');
			}
		};

		xmlhttp.open("POST", "/tool/get_data_points/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(request_body));
	
	}
	
	
	//===  Draw the table  ================================================================================================================================	
    function drawTheTable() {
	
		$("#download-buttons").attr("style","display:block;");
		$("#box").attr("style","display:block;");
		
		number_of_rows = table_body[Object.keys(table_body)[0]].length;
		
		//When you change the filters, then a new query is run, but the selected_table_attributes remain.
		//The table returned by the new query may not have one of the selected attributes.
		//Here we check for this and add a column of nulls to table_body for any missing column.
		for (var i = 0; i < selected_table_attributes.length; i++) {
			var selected_attribute_id = selected_table_attributes[i]['attribute_id'];
			if (! Object.keys(table_body).includes( selected_attribute_id )) {
				var new_column = []
				for (var j = 0; j < number_of_rows; j++) { 
					new_column.push(null);
				}
				table_body[selected_attribute_id] = new_column;
			}
		}
		
		
		// Draw the Table
		var table_html_string = '<table id="data-table" class="table table-sm" style="width:' + (141*selected_table_attributes.length + 20) + 'px;">' +
									'<thead>' +
										'<tr>';

		for (var i = 0; i < selected_table_attributes.length; i++) {
			table_html_string +=  			'<th scope="col">' + 
												selected_table_attributes[i]['attribute_name'] + 
												'<div style="display:inline-block;">' +
													'<div class="sort-triangle-div"><span class="glyphicon glyphicon-triangle-top sort-triangle" onclick="sortColumnDescending(' + i + ');"></span></div>' + 
													'<br>' +
													'<div class="sort-triangle-div"><span class="glyphicon glyphicon-triangle-bottom sort-triangle" onclick="sortColumnAscending(' + i + ');"></span></div>' + 
												'</div>' +
											'</th>';
											
		/*	table_html_string +=  			'<th scope="col">' + 
												selected_table_attributes[i]['attribute_name'] + 
												'<div style="display:inline-block;">' +
													'<button id="sort-table-button' + i + '" class="btn sort-table-button top-triangle" type="button" onclick="sortColumnDescending(' + i + ');">' +
														'<span class="glyphicon glyphicon-triangle-top"></span>' + 
													'</button><br>' +
													'<button id="sort-table-button' + i + '" class="btn sort-table-button" type="button" onclick="sortColumnAscending(' + i + ');">' +
														'<span class="glyphicon glyphicon-triangle-bottom"></span>' + 
													'</button>' +
												'</div>' +
											'</th>';  */
		}
		
		table_html_string +=  			'</tr>' +
									'</thead>' +
									'<tbody class="table-body">';
		
		for (var i = 0; i < number_of_rows; i++) {
			table_html_string +=  		'<tr>';
			for (var j = 0; j < selected_table_attributes.length; j++) {
				var attribute_id = selected_table_attributes[j]['attribute_id'];
				if (selected_table_attributes[j]['attribute_is_relation']) {
					var object_id = table_body[attribute_id][i];
					var related_attribute_id = selected_table_attributes[j]['related_attribute_id']
					table_html_string +=  			'<td><span>f</span>' + related_table_body[related_attribute_id][object_id] + '</td>';
				} else {
					table_html_string +=  			'<td><span>f</span>' + table_body[attribute_id][i] + '</td>';
				}
			}
			table_html_string +=  		'</tr>';
		}
		
		table_html_string +=  		'</tbody>' +
								'</table>';
									
		$("#uploaded_table").html(table_html_string);
	}


	
	//====================================================================================================
	//====  Table-Attribute-Selection DROPDOWNS:   =======================================================
	//====================================================================================================
	
	//===  Draw the first Table Attribute Dropdown  =======================================================================================================================	
	function drawTheFirstDropDown() {
	
		dropdown_html_string = 	'<div class="table-attribute-dropdown">' +
									'<div>' +
										'<select class="form-control" id="table_attribute0" name="table_attribute0" onchange="tableAttributeChange(0)">' +
											'<option value="" selected></option>';
		for (var i = 0; i < table_attributes.length; i++) {
			if (table_attributes[i]['attribute_population'] > 0) {
				dropdown_html_string +=		'<option value="' + table_attributes[i]['attribute_id'] + '">' + table_attributes[i]['attribute_name'] + '</option>';
			}
		}
			dropdown_html_string +=			'<option value="object_id">&lt;Object Id&gt;</option>';					
		dropdown_html_string +=			'</select>' +
									'</div>' +
									'<div id="related-attribute-0"></div>' +
								'</div>';
		
		console.log('without this print statement, this is sometimes left out')
		$(dropdown_html_string).insertBefore('#end-of-attribute-selection');
	}
	
	
	//===  Table Attribute Dropdown was changed  =======================================================================================================================	
	function tableAttributeChange(dropdown_number) {

		var dropdown = document.getElementById("table_attribute" + dropdown_number);
		var new_attribute_id = dropdown[dropdown.selectedIndex].value;
		var new_attribute_name = "";
		var new_attribute_is_relation = false;
		var table_column_number = 0;
		for (var i = 0; i < table_attributes.length; i++) {
			if (table_attributes[i]['attribute_id'] == new_attribute_id) {
				new_attribute_name = table_attributes[i]['attribute_name'];
				if (table_attributes[i]['attribute_data_type']=='relation') {new_attribute_is_relation = true;}
				table_column_number = i;
			}
		}
		//var new_attribute_name = $('[value="' + new_attribute_id + '"]').html();
		
		
		if (new_attribute_id == ""){
			if (dropdown_number < largest_dropdown_number) {
				
				
				
				//move all values one to the left to fill the gap
				for (var i = dropdown_number; i < largest_dropdown_number; i++) {
					var dropdown_right = document.getElementById("table_attribute" + (i+1));
					var right_value = dropdown_right[dropdown_right.selectedIndex].value;
					document.getElementById("table_attribute" + i).value = right_value;
					selected_table_attributes[i+1] = selected_table_attributes[i+2];
				}
				
				//remove the dropdown on the far right
				document.getElementById("table_attribute" + largest_dropdown_number).remove();
				selected_table_attributes.pop();
				largest_dropdown_number--;
			}
			
		} else {
			if (dropdown_number == largest_dropdown_number) {

				largest_dropdown_number++;
				dropdown_html_string = 	'<div class="table-attribute-dropdown">' +
											'<div>' +
												'<select class="form-control table-attribute-dropdown" id="table_attribute' + largest_dropdown_number + '" name="table_attribute' + largest_dropdown_number + '" onchange="tableAttributeChange(' + largest_dropdown_number + ')">' +
													'<option value="" selected></option>';
				for (var i = 0; i < table_attributes.length; i++) {
					if (table_attributes[i]['attribute_population'] > 0) {
						dropdown_html_string +=		'<option value="' + table_attributes[i]['attribute_id'] + '">' + table_attributes[i]['attribute_name'] + '</option>';
					}
				}
				dropdown_html_string +=			'</select>' +
											'</div>' +
											'<div id="related-attribute-' + largest_dropdown_number + '"></div>' +
										'</div>';
				
				selected_table_attributes.push({'attribute_id': new_attribute_id, 'attribute_name': new_attribute_name});
				
			
				$(dropdown_html_string).insertBefore('#end-of-attribute-selection');
			}
			
			
			if (new_attribute_is_relation) {
			
				var object_type_id = $("#object_type_id").val();
				var specified_start_time = $("#specified_start_time").val();
				var specified_end_time = $("#specified_end_time").val();
				specified_start_time = new Date(specified_start_time).getTime() / 1000
				specified_end_time = new Date(specified_end_time).getTime() / 1000
		
				request_body = {'object_type_id': object_type_id,
								'object_ids': table_body[parseInt(new_attribute_id)],
								'specified_start_time': specified_start_time,
								'specified_end_time': specified_end_time}
								
				var xmlhttp = new XMLHttpRequest();       
				xmlhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
					
						var response = JSON.parse(this.responseText);
						
						related_table_body = response['related_table_body'];
						related_table_attributes = response['related_table_attributes'];
						related_attribute_class = (dropdown_number==0) ? '' : 'related-attribute-dropdown';
						
						related_attr_dropdown_string = 	'<select class="form-control ' + related_attribute_class + '" id="related_attribute' + dropdown_number + '" name="related_attribute' + dropdown_number + '" onchange="relatedAttributeChange(' + dropdown_number + ')">' +
															'<option value="" selected></option>';
						for (var i = 0; i < related_table_attributes.length; i++) {
							related_attr_dropdown_string +=	'<option value="' + related_table_attributes[i]['attribute_id'] + '">' + related_table_attributes[i]['attribute_name'] + '</option>';
						}
						related_attr_dropdown_string +=	'</select>';
						
						$('#related-attribute-' + dropdown_number).html(related_attr_dropdown_string);
					}
					
					
				};
				xmlhttp.open("POST", "/tool/get_data_from_objects_behind_the_relation/");
				xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
				xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
				xmlhttp.send(JSON.stringify(request_body));	
				
		

				
			}
			
			selected_table_attributes[dropdown_number + 1] = {'attribute_id': new_attribute_id, 'attribute_name': new_attribute_name};	
		}
		
		drawTheTable();

	}
	
	
	
	function relatedAttributeChange(dropdown_number) {
		var dropdown = document.getElementById("table_attribute" + dropdown_number);
		var attribute_id = dropdown[dropdown.selectedIndex].value;
		var attribute_name = dropdown.options[dropdown.selectedIndex].innerHTML;
	
		var rel_dropdown = document.getElementById("related_attribute" + dropdown_number);
		var related_attribute_id = rel_dropdown[rel_dropdown.selectedIndex].value;
		var related_attribute_name = rel_dropdown.options[rel_dropdown.selectedIndex].innerHTML;
		
		selected_table_attributes[dropdown_number + 1] = {  'attribute_id': attribute_id, 
															'attribute_name': attribute_name + '.' + related_attribute_name, 
															'attribute_is_relation':true, 
															'related_attribute_id':related_attribute_id, 
															'related_attribute_name':related_attribute_name};	
		drawTheTable();
		       
	
	}

	
	/*========================================================================*/
	/*===============    SORT TABLE COLUMNS     ==============================*/
	/*========================================================================*/
	
	function sortColumnAscending(column_number) {
		//1) combine the arrays:
		number_of_rows = table_body[Object.keys(table_body)[0]].length;
		var list_of_rows = [];
		for (var i = 0; i < number_of_rows; i++) {
			var row_object = {};
			for (var j = 0; j < selected_table_attributes.length; j++) {
				var attribute_id = selected_table_attributes[j]['attribute_id'];
				row_object[j] = table_body[attribute_id][i]
			}
			list_of_rows.push(row_object);
		}

		//2) sort:
		list_of_rows.sort(function(a, b) {
			return ((a[column_number] < b[column_number]) ? -1 : ((a[column_number] == b[column_number]) ? 0 : 1));
			//Sort could be modified to, for example, sort on the age 
			// if the name is the same.
		});

		//3) separate them back out:
		for (var row = 0; row < list_of_rows.length; row++) {
			for (var col = 0; col < selected_table_attributes.length; col++) {
				var attribute_id = selected_table_attributes[col]['attribute_id'];
				table_body[attribute_id][row] = list_of_rows[row][col]
			}
		}
		
		drawTheTable();
	}

	
	function sortColumnDescending(column_number) {
		//1) combine the arrays:
		number_of_rows = table_body[Object.keys(table_body)[0]].length;
		var list_of_rows = [];
		for (var i = 0; i < number_of_rows; i++) {
			var row_object = {};
			for (var j = 0; j < selected_table_attributes.length; j++) {
				var attribute_id = selected_table_attributes[j]['attribute_id'];
				row_object[j] = table_body[attribute_id][i]
			}
			list_of_rows.push(row_object);
		}

		//2) sort:
		list_of_rows.sort(function(a, b) {
			return ((a[column_number] > b[column_number]) ? -1 : ((a[column_number] == b[column_number]) ? 0 : 1));
			//Sort could be modified to, for example, sort on the age 
			// if the name is the same.
		});

		//3) separate them back out:
		for (var row = 0; row < list_of_rows.length; row++) {
			for (var col = 0; col < selected_table_attributes.length; col++) {
				var attribute_id = selected_table_attributes[col]['attribute_id'];
				table_body[attribute_id][row] = list_of_rows[row][col]
			}
		}
		
		drawTheTable();
	}
	
	
	
	function downloadData(file_type) {
	
		displayed_table = {}
		for (var i = 0; i < selected_table_attributes.length; i++) {
			var attribute_id = selected_table_attributes[i]['attribute_id'];
			if (selected_table_attributes[i]['attribute_is_relation']){
			
				var related_object_ids = table_body[attribute_id]; 
				var related_attribute_id = selected_table_attributes[i]['related_attribute_id'];	
				var displayed_table_column = []
				for (var j = 0; j < related_object_ids.length ; j++) {
					displayed_table_column.push(related_table_body[related_attribute_id][related_object_ids[j]]);
				}	
				displayed_table[selected_table_attributes[i]['attribute_name']]	= displayed_table_column;
					
			} else {
				displayed_table[selected_table_attributes[i]['attribute_name']] = table_body[attribute_id];
			}
		}
		
		var xmlhttp = new XMLHttpRequest();       
		xmlhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
			
				var filename = this.responseText;
				window.location.href = filename + "-" + file_type;
			}
		};

		xmlhttp.open("POST", "/tool/download_file1/");
		xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
		xmlhttp.send(JSON.stringify(displayed_table));	
	}
	
	
	/*========================================================================*/
	/*===============    MAIN      ===========================================*/
	/*========================================================================*/
	
	
	
	
	window.onload = function() {
		// PART 1: Set up the Object Hierachy Popover ================================================================
		// initialize popover
		$('#object_type').popover({
			container: 'body',
			placement: 'bottom',
			html: true,
			content:"<div id='object_hierachy_popover_content' class='choose-object-type-content form'> " +
						"<div class='object-type-spec-box'>" + 
							"<div id='container-for-object-tree'></div>" + 
						"</div>" + 
					"</div>"
		});
		
		// When the popover is opened, load the object hierachy tree
		$('#object_type').on('shown.bs.popover', function () {
			loadObjectHierachyTree();
		});
		
		// when you click outside the popover, close it
		$('body').on('mousedown', function (e) {
			var popover_content_element = document.getElementById('object_hierachy_popover_content');
			if (!$('#object_type').is(e.target) && popover_content_element && !popover_content_element.contains(e.target) ) {  
				$('#object_type').popover('hide');
			}
		}); 
		
		
		// PART 2: Initialize the DateTimePickers
		// load js/datepicker/bootstrap-datetimepicker.min.js, because it doesn't load correctly if the document is not ready (no idea why!!!)
		(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{if(typeof exports==="object"){a(require("jquery"))}else{a(jQuery)}}}(function(d,f){if(!("indexOf" in Array.prototype)){Array.prototype.indexOf=function(k,j){if(j===f){j=0}if(j<0){j+=this.length}if(j<0){j=0}for(var l=this.length;j<l;j++){if(j in this&&this[j]===k){return j}}return -1}}function a(){var q,k,p,l,j,n,m,o;k=(new Date()).toString();p=((m=k.split("(")[1])!=null?m.slice(0,-1):0)||k.split(" ");if(p instanceof Array){n=[];for(var l=0,j=p.length;l<j;l++){o=p[l];if((q=(m=o.match(/\b[A-Z]+\b/))!==null)?m[0]:0){n.push(q)}}p=n.pop()}return p}function h(){return new Date(Date.UTC.apply(Date,arguments))}var g=function(k,j){var m=this;this.element=d(k);this.container=j.container||"body";this.language=j.language||this.element.data("date-language")||"en";this.language=this.language in e?this.language:this.language.split("-")[0];this.language=this.language in e?this.language:"en";this.isRTL=e[this.language].rtl||false;this.formatType=j.formatType||this.element.data("format-type")||"standard";this.format=c.parseFormat(j.format||this.element.data("date-format")||e[this.language].format||c.getDefaultFormat(this.formatType,"input"),this.formatType);this.isInline=false;this.isVisible=false;this.isInput=this.element.is("input");this.fontAwesome=j.fontAwesome||this.element.data("font-awesome")||false;this.bootcssVer=j.bootcssVer||(this.isInput?(this.element.is(".form-control")?3:2):(this.bootcssVer=this.element.is(".input-group")?3:2));this.component=this.element.is(".date")?(this.bootcssVer===3?this.element.find(".input-group-addon .glyphicon-th, .input-group-addon .glyphicon-time, .input-group-addon .glyphicon-remove, .input-group-addon .glyphicon-calendar, .input-group-addon .fa-calendar, .input-group-addon .fa-clock-o").parent():this.element.find(".add-on .icon-th, .add-on .icon-time, .add-on .icon-calendar, .add-on .fa-calendar, .add-on .fa-clock-o").parent()):false;this.componentReset=this.element.is(".date")?(this.bootcssVer===3?this.element.find(".input-group-addon .glyphicon-remove, .input-group-addon .fa-times").parent():this.element.find(".add-on .icon-remove, .add-on .fa-times").parent()):false;this.hasInput=this.component&&this.element.find("input").length;if(this.component&&this.component.length===0){this.component=false}this.linkField=j.linkField||this.element.data("link-field")||false;this.linkFormat=c.parseFormat(j.linkFormat||this.element.data("link-format")||c.getDefaultFormat(this.formatType,"link"),this.formatType);this.minuteStep=j.minuteStep||this.element.data("minute-step")||5;this.pickerPosition=j.pickerPosition||this.element.data("picker-position")||"bottom-right";this.showMeridian=j.showMeridian||this.element.data("show-meridian")||false;this.initialDate=j.initialDate||new Date();this.zIndex=j.zIndex||this.element.data("z-index")||f;this.title=typeof j.title==="undefined"?false:j.title;this.timezone=j.timezone||a();this.icons={leftArrow:this.fontAwesome?"fa-arrow-left":(this.bootcssVer===3?"glyphicon-arrow-left":"icon-arrow-left"),rightArrow:this.fontAwesome?"fa-arrow-right":(this.bootcssVer===3?"glyphicon-arrow-right":"icon-arrow-right")};this.icontype=this.fontAwesome?"fa":"glyphicon";this._attachEvents();this.clickedOutside=function(n){if(d(n.target).closest(".datetimepicker").length===0){m.hide()}};this.formatViewType="datetime";if("formatViewType" in j){this.formatViewType=j.formatViewType}else{if("formatViewType" in this.element.data()){this.formatViewType=this.element.data("formatViewType")}}this.minView=0;if("minView" in j){this.minView=j.minView}else{if("minView" in this.element.data()){this.minView=this.element.data("min-view")}}this.minView=c.convertViewMode(this.minView);this.maxView=c.modes.length-1;if("maxView" in j){this.maxView=j.maxView}else{if("maxView" in this.element.data()){this.maxView=this.element.data("max-view")}}this.maxView=c.convertViewMode(this.maxView);this.wheelViewModeNavigation=false;if("wheelViewModeNavigation" in j){this.wheelViewModeNavigation=j.wheelViewModeNavigation}else{if("wheelViewModeNavigation" in this.element.data()){this.wheelViewModeNavigation=this.element.data("view-mode-wheel-navigation")}}this.wheelViewModeNavigationInverseDirection=false;if("wheelViewModeNavigationInverseDirection" in j){this.wheelViewModeNavigationInverseDirection=j.wheelViewModeNavigationInverseDirection}else{if("wheelViewModeNavigationInverseDirection" in this.element.data()){this.wheelViewModeNavigationInverseDirection=this.element.data("view-mode-wheel-navigation-inverse-dir")}}this.wheelViewModeNavigationDelay=100;if("wheelViewModeNavigationDelay" in j){this.wheelViewModeNavigationDelay=j.wheelViewModeNavigationDelay}else{if("wheelViewModeNavigationDelay" in this.element.data()){this.wheelViewModeNavigationDelay=this.element.data("view-mode-wheel-navigation-delay")}}this.startViewMode=2;if("startView" in j){this.startViewMode=j.startView}else{if("startView" in this.element.data()){this.startViewMode=this.element.data("start-view")}}this.startViewMode=c.convertViewMode(this.startViewMode);this.viewMode=this.startViewMode;this.viewSelect=this.minView;if("viewSelect" in j){this.viewSelect=j.viewSelect}else{if("viewSelect" in this.element.data()){this.viewSelect=this.element.data("view-select")}}this.viewSelect=c.convertViewMode(this.viewSelect);this.forceParse=true;if("forceParse" in j){this.forceParse=j.forceParse}else{if("dateForceParse" in this.element.data()){this.forceParse=this.element.data("date-force-parse")}}var l=this.bootcssVer===3?c.templateV3:c.template;while(l.indexOf("{iconType}")!==-1){l=l.replace("{iconType}",this.icontype)}while(l.indexOf("{leftArrow}")!==-1){l=l.replace("{leftArrow}",this.icons.leftArrow)}while(l.indexOf("{rightArrow}")!==-1){l=l.replace("{rightArrow}",this.icons.rightArrow)}this.picker=d(l).appendTo(this.isInline?this.element:this.container).on({click:d.proxy(this.click,this),mousedown:d.proxy(this.mousedown,this)});if(this.wheelViewModeNavigation){if(d.fn.mousewheel){this.picker.on({mousewheel:d.proxy(this.mousewheel,this)})}else{console.log("Mouse Wheel event is not supported. Please include the jQuery Mouse Wheel plugin before enabling this option")}}if(this.isInline){this.picker.addClass("datetimepicker-inline")}else{this.picker.addClass("datetimepicker-dropdown-"+this.pickerPosition+" dropdown-menu")}if(this.isRTL){this.picker.addClass("datetimepicker-rtl");var i=this.bootcssVer===3?".prev span, .next span":".prev i, .next i";this.picker.find(i).toggleClass(this.icons.leftArrow+" "+this.icons.rightArrow)}d(document).on("mousedown touchend",this.clickedOutside);this.autoclose=false;if("autoclose" in j){this.autoclose=j.autoclose}else{if("dateAutoclose" in this.element.data()){this.autoclose=this.element.data("date-autoclose")}}this.keyboardNavigation=true;if("keyboardNavigation" in j){this.keyboardNavigation=j.keyboardNavigation}else{if("dateKeyboardNavigation" in this.element.data()){this.keyboardNavigation=this.element.data("date-keyboard-navigation")}}this.todayBtn=(j.todayBtn||this.element.data("date-today-btn")||false);this.clearBtn=(j.clearBtn||this.element.data("date-clear-btn")||false);this.todayHighlight=(j.todayHighlight||this.element.data("date-today-highlight")||false);this.weekStart=0;if(typeof j.weekStart!=="undefined"){this.weekStart=j.weekStart}else{if(typeof this.element.data("date-weekstart")!=="undefined"){this.weekStart=this.element.data("date-weekstart")}else{if(typeof e[this.language].weekStart!=="undefined"){this.weekStart=e[this.language].weekStart}}}this.weekStart=this.weekStart%7;this.weekEnd=((this.weekStart+6)%7);this.onRenderDay=function(n){var p=(j.onRenderDay||function(){return[]})(n);if(typeof p==="string"){p=[p]}var o=["day"];return o.concat((p?p:[]))};this.onRenderHour=function(n){var p=(j.onRenderHour||function(){return[]})(n);var o=["hour"];if(typeof p==="string"){p=[p]}return o.concat((p?p:[]))};this.onRenderMinute=function(n){var p=(j.onRenderMinute||function(){return[]})(n);var o=["minute"];if(typeof p==="string"){p=[p]}if(n<this.startDate||n>this.endDate){o.push("disabled")}else{if(Math.floor(this.date.getUTCMinutes()/this.minuteStep)===Math.floor(n.getUTCMinutes()/this.minuteStep)){o.push("active")}}return o.concat((p?p:[]))};this.onRenderYear=function(o){var q=(j.onRenderYear||function(){return[]})(o);var p=["year"];if(typeof q==="string"){q=[q]}if(this.date.getUTCFullYear()===o.getUTCFullYear()){p.push("active")}var n=o.getUTCFullYear();var r=this.endDate.getUTCFullYear();if(o<this.startDate||n>r){p.push("disabled")}return p.concat((q?q:[]))};this.onRenderMonth=function(n){var p=(j.onRenderMonth||function(){return[]})(n);var o=["month"];if(typeof p==="string"){p=[p]}return o.concat((p?p:[]))};this.startDate=new Date(-8639968443048000);this.endDate=new Date(8639968443048000);this.datesDisabled=[];this.daysOfWeekDisabled=[];this.setStartDate(j.startDate||this.element.data("date-startdate"));this.setEndDate(j.endDate||this.element.data("date-enddate"));this.setDatesDisabled(j.datesDisabled||this.element.data("date-dates-disabled"));this.setDaysOfWeekDisabled(j.daysOfWeekDisabled||this.element.data("date-days-of-week-disabled"));this.setMinutesDisabled(j.minutesDisabled||this.element.data("date-minute-disabled"));this.setHoursDisabled(j.hoursDisabled||this.element.data("date-hour-disabled"));this.fillDow();this.fillMonths();this.update();this.showMode();if(this.isInline){this.show()}};g.prototype={constructor:g,_events:[],_attachEvents:function(){this._detachEvents();if(this.isInput){this._events=[[this.element,{focus:d.proxy(this.show,this),keyup:d.proxy(this.update,this),keydown:d.proxy(this.keydown,this)}]]}else{if(this.component&&this.hasInput){this._events=[[this.element.find("input"),{focus:d.proxy(this.show,this),keyup:d.proxy(this.update,this),keydown:d.proxy(this.keydown,this)}],[this.component,{click:d.proxy(this.show,this)}]];if(this.componentReset){this._events.push([this.componentReset,{click:d.proxy(this.reset,this)}])}}else{if(this.element.is("div")){this.isInline=true}else{this._events=[[this.element,{click:d.proxy(this.show,this)}]]}}}for(var j=0,k,l;j<this._events.length;j++){k=this._events[j][0];l=this._events[j][1];k.on(l)}},_detachEvents:function(){for(var j=0,k,l;j<this._events.length;j++){k=this._events[j][0];l=this._events[j][1];k.off(l)}this._events=[]},show:function(i){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();if(this.forceParse){this.update()}this.place();d(window).on("resize",d.proxy(this.place,this));if(i){i.stopPropagation();i.preventDefault()}this.isVisible=true;this.element.trigger({type:"show",date:this.date})},hide:function(){if(!this.isVisible){return}if(this.isInline){return}this.picker.hide();d(window).off("resize",this.place);this.viewMode=this.startViewMode;this.showMode();if(!this.isInput){d(document).off("mousedown",this.hide)}if(this.forceParse&&(this.isInput&&this.element.val()||this.hasInput&&this.element.find("input").val())){this.setValue()}this.isVisible=false;this.element.trigger({type:"hide",date:this.date})},remove:function(){this._detachEvents();d(document).off("mousedown",this.clickedOutside);this.picker.remove();delete this.picker;delete this.element.data().datetimepicker},getDate:function(){var i=this.getUTCDate();if(i===null){return null}return new Date(i.getTime()+(i.getTimezoneOffset()*60000))},getUTCDate:function(){return this.date},getInitialDate:function(){return this.initialDate},setInitialDate:function(i){this.initialDate=i},setDate:function(i){this.setUTCDate(new Date(i.getTime()-(i.getTimezoneOffset()*60000)))},setUTCDate:function(i){if(i>=this.startDate&&i<=this.endDate){this.date=i;this.setValue();this.viewDate=this.date;this.fill()}else{this.element.trigger({type:"outOfRange",date:i,startDate:this.startDate,endDate:this.endDate})}},setFormat:function(j){this.format=c.parseFormat(j,this.formatType);var i;if(this.isInput){i=this.element}else{if(this.component){i=this.element.find("input")}}if(i&&i.val()){this.setValue()}},setValue:function(){var i=this.getFormattedDate();if(!this.isInput){if(this.component){this.element.find("input").val(i)}this.element.data("date",i)}else{this.element.val(i)}if(this.linkField){d("#"+this.linkField).val(this.getFormattedDate(this.linkFormat))}},getFormattedDate:function(i){i=i||this.format;return c.formatDate(this.date,i,this.language,this.formatType,this.timezone)},setStartDate:function(i){this.startDate=i||this.startDate;if(this.startDate.valueOf()!==8639968443048000){this.startDate=c.parseDate(this.startDate,this.format,this.language,this.formatType,this.timezone)}this.update();this.updateNavArrows()},setEndDate:function(i){this.endDate=i||this.endDate;if(this.endDate.valueOf()!==8639968443048000){this.endDate=c.parseDate(this.endDate,this.format,this.language,this.formatType,this.timezone)}this.update();this.updateNavArrows()},setDatesDisabled:function(j){this.datesDisabled=j||[];if(!d.isArray(this.datesDisabled)){this.datesDisabled=this.datesDisabled.split(/,\s*/)}var i=this;this.datesDisabled=d.map(this.datesDisabled,function(k){return c.parseDate(k,i.format,i.language,i.formatType,i.timezone).toDateString()});this.update();this.updateNavArrows()},setTitle:function(i,j){return this.picker.find(i).find("th:eq(1)").text(this.title===false?j:this.title)},setDaysOfWeekDisabled:function(i){this.daysOfWeekDisabled=i||[];if(!d.isArray(this.daysOfWeekDisabled)){this.daysOfWeekDisabled=this.daysOfWeekDisabled.split(/,\s*/)}this.daysOfWeekDisabled=d.map(this.daysOfWeekDisabled,function(j){return parseInt(j,10)});this.update();this.updateNavArrows()},setMinutesDisabled:function(i){this.minutesDisabled=i||[];if(!d.isArray(this.minutesDisabled)){this.minutesDisabled=this.minutesDisabled.split(/,\s*/)}this.minutesDisabled=d.map(this.minutesDisabled,function(j){return parseInt(j,10)});this.update();this.updateNavArrows()},setHoursDisabled:function(i){this.hoursDisabled=i||[];if(!d.isArray(this.hoursDisabled)){this.hoursDisabled=this.hoursDisabled.split(/,\s*/)}this.hoursDisabled=d.map(this.hoursDisabled,function(j){return parseInt(j,10)});this.update();this.updateNavArrows()},place:function(){if(this.isInline){return}if(!this.zIndex){var j=0;d("div").each(function(){var o=parseInt(d(this).css("zIndex"),10);if(o>j){j=o}});this.zIndex=j+10}var n,m,l,k;if(this.container instanceof d){k=this.container.offset()}else{k=d(this.container).offset()}if(this.component){n=this.component.offset();l=n.left;if(this.pickerPosition==="bottom-left"||this.pickerPosition==="top-left"){l+=this.component.outerWidth()-this.picker.outerWidth()}}else{n=this.element.offset();l=n.left;if(this.pickerPosition==="bottom-left"||this.pickerPosition==="top-left"){l+=this.element.outerWidth()-this.picker.outerWidth()}}var i=document.body.clientWidth||window.innerWidth;if(l+220>i){l=i-220}if(this.pickerPosition==="top-left"||this.pickerPosition==="top-right"){m=n.top-this.picker.outerHeight()}else{m=n.top+this.height}m=m-k.top;l=l-k.left;this.picker.css({top:m,left:l,zIndex:this.zIndex})},hour_minute:"^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]",update:function(){var i,j=false;if(arguments&&arguments.length&&(typeof arguments[0]==="string"||arguments[0] instanceof Date)){i=arguments[0];j=true}else{i=(this.isInput?this.element.val():this.element.find("input").val())||this.element.data("date")||this.initialDate;if(typeof i==="string"){i=i.replace(/^\s+|\s+$/g,"")}}if(!i){i=new Date();j=false}if(typeof i==="string"){if(new RegExp(this.hour_minute).test(i)||new RegExp(this.hour_minute+":[0-5][0-9]").test(i)){i=this.getDate()}}this.date=c.parseDate(i,this.format,this.language,this.formatType,this.timezone);if(j){this.setValue()}if(this.date<this.startDate){this.viewDate=new Date(this.startDate)}else{if(this.date>this.endDate){this.viewDate=new Date(this.endDate)}else{this.viewDate=new Date(this.date)}}this.fill()},fillDow:function(){var i=this.weekStart,j="<tr>";while(i<this.weekStart+7){j+='<th class="dow">'+e[this.language].daysMin[(i++)%7]+"</th>"}j+="</tr>";this.picker.find(".datetimepicker-days thead").append(j)},fillMonths:function(){var l="";var m=new Date(this.viewDate);for(var k=0;k<12;k++){m.setUTCMonth(k);var j=this.onRenderMonth(m);l+='<span class="'+j.join(" ")+'">'+e[this.language].monthsShort[k]+"</span>"}this.picker.find(".datetimepicker-months td").html(l)},fill:function(){if(!this.date||!this.viewDate){return}var E=new Date(this.viewDate),t=E.getUTCFullYear(),G=E.getUTCMonth(),n=E.getUTCDate(),A=E.getUTCHours(),w=this.startDate.getUTCFullYear(),B=this.startDate.getUTCMonth(),p=this.endDate.getUTCFullYear(),x=this.endDate.getUTCMonth()+1,q=(new h(this.date.getUTCFullYear(),this.date.getUTCMonth(),this.date.getUTCDate())).valueOf(),D=new Date();this.setTitle(".datetimepicker-days",e[this.language].months[G]+" "+t);if(this.formatViewType==="time"){var k=this.getFormattedDate();this.setTitle(".datetimepicker-hours",k);this.setTitle(".datetimepicker-minutes",k)}else{this.setTitle(".datetimepicker-hours",n+" "+e[this.language].months[G]+" "+t);this.setTitle(".datetimepicker-minutes",n+" "+e[this.language].months[G]+" "+t)}this.picker.find("tfoot th.today").text(e[this.language].today||e.en.today).toggle(this.todayBtn!==false);this.picker.find("tfoot th.clear").text(e[this.language].clear||e.en.clear).toggle(this.clearBtn!==false);this.updateNavArrows();this.fillMonths();var I=h(t,G-1,28,0,0,0,0),z=c.getDaysInMonth(I.getUTCFullYear(),I.getUTCMonth());I.setUTCDate(z);I.setUTCDate(z-(I.getUTCDay()-this.weekStart+7)%7);var j=new Date(I);j.setUTCDate(j.getUTCDate()+42);j=j.valueOf();var r=[];var F;while(I.valueOf()<j){if(I.getUTCDay()===this.weekStart){r.push("<tr>")}F=this.onRenderDay(I);if(I.getUTCFullYear()<t||(I.getUTCFullYear()===t&&I.getUTCMonth()<G)){F.push("old")}else{if(I.getUTCFullYear()>t||(I.getUTCFullYear()===t&&I.getUTCMonth()>G)){F.push("new")}}if(this.todayHighlight&&I.getUTCFullYear()===D.getFullYear()&&I.getUTCMonth()===D.getMonth()&&I.getUTCDate()===D.getDate()){F.push("today")}if(I.valueOf()===q){F.push("active")}if((I.valueOf()+86400000)<=this.startDate||I.valueOf()>this.endDate||d.inArray(I.getUTCDay(),this.daysOfWeekDisabled)!==-1||d.inArray(I.toDateString(),this.datesDisabled)!==-1){F.push("disabled")}r.push('<td class="'+F.join(" ")+'">'+I.getUTCDate()+"</td>");if(I.getUTCDay()===this.weekEnd){r.push("</tr>")}I.setUTCDate(I.getUTCDate()+1)}this.picker.find(".datetimepicker-days tbody").empty().append(r.join(""));r=[];var u="",C="",s="";var l=this.hoursDisabled||[];E=new Date(this.viewDate);for(var y=0;y<24;y++){E.setUTCHours(y);F=this.onRenderHour(E);if(l.indexOf(y)!==-1){F.push("disabled")}var v=h(t,G,n,y);if((v.valueOf()+3600000)<=this.startDate||v.valueOf()>this.endDate){F.push("disabled")}else{if(A===y){F.push("active")}}if(this.showMeridian&&e[this.language].meridiem.length===2){C=(y<12?e[this.language].meridiem[0]:e[this.language].meridiem[1]);if(C!==s){if(s!==""){r.push("</fieldset>")}r.push('<fieldset class="hour"><legend>'+C.toUpperCase()+"</legend>")}s=C;u=(y%12?y%12:12);if(y<12){F.push("hour_am")}else{F.push("hour_pm")}r.push('<span class="'+F.join(" ")+'">'+u+"</span>");if(y===23){r.push("</fieldset>")}}else{u=y+":00";r.push('<span class="'+F.join(" ")+'">'+u+"</span>")}}this.picker.find(".datetimepicker-hours td").html(r.join(""));r=[];u="";C="";s="";var m=this.minutesDisabled||[];E=new Date(this.viewDate);for(var y=0;y<60;y+=this.minuteStep){if(m.indexOf(y)!==-1){continue}E.setUTCMinutes(y);E.setUTCSeconds(0);F=this.onRenderMinute(E);if(this.showMeridian&&e[this.language].meridiem.length===2){C=(A<12?e[this.language].meridiem[0]:e[this.language].meridiem[1]);if(C!==s){if(s!==""){r.push("</fieldset>")}r.push('<fieldset class="minute"><legend>'+C.toUpperCase()+"</legend>")}s=C;u=(A%12?A%12:12);r.push('<span class="'+F.join(" ")+'">'+u+":"+(y<10?"0"+y:y)+"</span>");if(y===59){r.push("</fieldset>")}}else{u=y+":00";r.push('<span class="'+F.join(" ")+'">'+A+":"+(y<10?"0"+y:y)+"</span>")}}this.picker.find(".datetimepicker-minutes td").html(r.join(""));var J=this.date.getUTCFullYear();var o=this.setTitle(".datetimepicker-months",t).end().find(".month").removeClass("active");if(J===t){o.eq(this.date.getUTCMonth()).addClass("active")}if(t<w||t>p){o.addClass("disabled")}if(t===w){o.slice(0,B).addClass("disabled")}if(t===p){o.slice(x).addClass("disabled")}r="";t=parseInt(t/10,10)*10;var H=this.setTitle(".datetimepicker-years",t+"-"+(t+9)).end().find("td");t-=1;E=new Date(this.viewDate);for(var y=-1;y<11;y++){E.setUTCFullYear(t);F=this.onRenderYear(E);if(y===-1||y===10){F.push(b)}r+='<span class="'+F.join(" ")+'">'+t+"</span>";t+=1}H.html(r);this.place()},updateNavArrows:function(){var m=new Date(this.viewDate),k=m.getUTCFullYear(),l=m.getUTCMonth(),j=m.getUTCDate(),i=m.getUTCHours();switch(this.viewMode){case 0:if(k<=this.startDate.getUTCFullYear()&&l<=this.startDate.getUTCMonth()&&j<=this.startDate.getUTCDate()&&i<=this.startDate.getUTCHours()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()&&l>=this.endDate.getUTCMonth()&&j>=this.endDate.getUTCDate()&&i>=this.endDate.getUTCHours()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break;case 1:if(k<=this.startDate.getUTCFullYear()&&l<=this.startDate.getUTCMonth()&&j<=this.startDate.getUTCDate()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()&&l>=this.endDate.getUTCMonth()&&j>=this.endDate.getUTCDate()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break;case 2:if(k<=this.startDate.getUTCFullYear()&&l<=this.startDate.getUTCMonth()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()&&l>=this.endDate.getUTCMonth()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break;case 3:case 4:if(k<=this.startDate.getUTCFullYear()){this.picker.find(".prev").css({visibility:"hidden"})}else{this.picker.find(".prev").css({visibility:"visible"})}if(k>=this.endDate.getUTCFullYear()){this.picker.find(".next").css({visibility:"hidden"})}else{this.picker.find(".next").css({visibility:"visible"})}break}},mousewheel:function(j){j.preventDefault();j.stopPropagation();if(this.wheelPause){return}this.wheelPause=true;var i=j.originalEvent;var l=i.wheelDelta;var k=l>0?1:(l===0)?0:-1;if(this.wheelViewModeNavigationInverseDirection){k=-k}this.showMode(k);setTimeout(d.proxy(function(){this.wheelPause=false},this),this.wheelViewModeNavigationDelay)},click:function(m){m.stopPropagation();m.preventDefault();var n=d(m.target).closest("span, td, th, legend");if(n.is("."+this.icontype)){n=d(n).parent().closest("span, td, th, legend")}if(n.length===1){if(n.is(".disabled")){this.element.trigger({type:"outOfRange",date:this.viewDate,startDate:this.startDate,endDate:this.endDate});return}switch(n[0].nodeName.toLowerCase()){case"th":switch(n[0].className){case"switch":this.showMode(1);break;case"prev":case"next":var i=c.modes[this.viewMode].navStep*(n[0].className==="prev"?-1:1);switch(this.viewMode){case 0:this.viewDate=this.moveHour(this.viewDate,i);break;case 1:this.viewDate=this.moveDate(this.viewDate,i);break;case 2:this.viewDate=this.moveMonth(this.viewDate,i);break;case 3:case 4:this.viewDate=this.moveYear(this.viewDate,i);break}this.fill();this.element.trigger({type:n[0].className+":"+this.convertViewModeText(this.viewMode),date:this.viewDate,startDate:this.startDate,endDate:this.endDate});break;case"clear":this.reset();if(this.autoclose){this.hide()}break;case"today":var j=new Date();j=h(j.getFullYear(),j.getMonth(),j.getDate(),j.getHours(),j.getMinutes(),j.getSeconds(),0);if(j<this.startDate){j=this.startDate}else{if(j>this.endDate){j=this.endDate}}this.viewMode=this.startViewMode;this.showMode(0);this._setDate(j);this.fill();if(this.autoclose){this.hide()}break}break;case"span":if(!n.is(".disabled")){var p=this.viewDate.getUTCFullYear(),o=this.viewDate.getUTCMonth(),q=this.viewDate.getUTCDate(),r=this.viewDate.getUTCHours(),k=this.viewDate.getUTCMinutes(),s=this.viewDate.getUTCSeconds();if(n.is(".month")){this.viewDate.setUTCDate(1);o=n.parent().find("span").index(n);q=this.viewDate.getUTCDate();this.viewDate.setUTCMonth(o);this.element.trigger({type:"changeMonth",date:this.viewDate});if(this.viewSelect>=3){this._setDate(h(p,o,q,r,k,s,0))}}else{if(n.is(".year")){this.viewDate.setUTCDate(1);p=parseInt(n.text(),10)||0;this.viewDate.setUTCFullYear(p);this.element.trigger({type:"changeYear",date:this.viewDate});if(this.viewSelect>=4){this._setDate(h(p,o,q,r,k,s,0))}}else{if(n.is(".hour")){r=parseInt(n.text(),10)||0;if(n.hasClass("hour_am")||n.hasClass("hour_pm")){if(r===12&&n.hasClass("hour_am")){r=0}else{if(r!==12&&n.hasClass("hour_pm")){r+=12}}}this.viewDate.setUTCHours(r);this.element.trigger({type:"changeHour",date:this.viewDate});if(this.viewSelect>=1){this._setDate(h(p,o,q,r,k,s,0))}}else{if(n.is(".minute")){k=parseInt(n.text().substr(n.text().indexOf(":")+1),10)||0;this.viewDate.setUTCMinutes(k);this.element.trigger({type:"changeMinute",date:this.viewDate});if(this.viewSelect>=0){this._setDate(h(p,o,q,r,k,s,0))}}}}}if(this.viewMode!==0){var l=this.viewMode;this.showMode(-1);this.fill();if(l===this.viewMode&&this.autoclose){this.hide()}}else{this.fill();if(this.autoclose){this.hide()}}}break;case"td":if(n.is(".day")&&!n.is(".disabled")){var q=parseInt(n.text(),10)||1;var p=this.viewDate.getUTCFullYear(),o=this.viewDate.getUTCMonth(),r=this.viewDate.getUTCHours(),k=this.viewDate.getUTCMinutes(),s=this.viewDate.getUTCSeconds();if(n.is(".old")){if(o===0){o=11;p-=1}else{o-=1}}else{if(n.is(".new")){if(o===11){o=0;p+=1}else{o+=1}}}this.viewDate.setUTCFullYear(p);this.viewDate.setUTCMonth(o,q);this.element.trigger({type:"changeDay",date:this.viewDate});if(this.viewSelect>=2){this._setDate(h(p,o,q,r,k,s,0))}}var l=this.viewMode;this.showMode(-1);this.fill();if(l===this.viewMode&&this.autoclose){this.hide()}break}}},_setDate:function(i,k){if(!k||k==="date"){this.date=i}if(!k||k==="view"){this.viewDate=i}this.fill();this.setValue();var j;if(this.isInput){j=this.element}else{if(this.component){j=this.element.find("input")}}if(j){j.change()}this.element.trigger({type:"changeDate",date:this.getDate()});if(i===null){this.date=this.viewDate}},moveMinute:function(j,i){if(!i){return j}var k=new Date(j.valueOf());k.setUTCMinutes(k.getUTCMinutes()+(i*this.minuteStep));return k},moveHour:function(j,i){if(!i){return j}var k=new Date(j.valueOf());k.setUTCHours(k.getUTCHours()+i);return k},moveDate:function(j,i){if(!i){return j}var k=new Date(j.valueOf());k.setUTCDate(k.getUTCDate()+i);return k},moveMonth:function(j,k){if(!k){return j}var n=new Date(j.valueOf()),r=n.getUTCDate(),o=n.getUTCMonth(),m=Math.abs(k),q,p;k=k>0?1:-1;if(m===1){p=k===-1?function(){return n.getUTCMonth()===o}:function(){return n.getUTCMonth()!==q};q=o+k;n.setUTCMonth(q);if(q<0||q>11){q=(q+12)%12}}else{for(var l=0;l<m;l++){n=this.moveMonth(n,k)}q=n.getUTCMonth();n.setUTCDate(r);p=function(){return q!==n.getUTCMonth()}}while(p()){n.setUTCDate(--r);n.setUTCMonth(q)}return n},moveYear:function(j,i){return this.moveMonth(j,i*12)},dateWithinRange:function(i){return i>=this.startDate&&i<=this.endDate},keydown:function(o){if(this.picker.is(":not(:visible)")){if(o.keyCode===27){this.show()}return}var k=false,j,i,n;switch(o.keyCode){case 27:this.hide();o.preventDefault();break;case 37:case 39:if(!this.keyboardNavigation){break}j=o.keyCode===37?-1:1;var m=this.viewMode;if(o.ctrlKey){m+=2}else{if(o.shiftKey){m+=1}}if(m===4){i=this.moveYear(this.date,j);n=this.moveYear(this.viewDate,j)}else{if(m===3){i=this.moveMonth(this.date,j);n=this.moveMonth(this.viewDate,j)}else{if(m===2){i=this.moveDate(this.date,j);n=this.moveDate(this.viewDate,j)}else{if(m===1){i=this.moveHour(this.date,j);n=this.moveHour(this.viewDate,j)}else{if(m===0){i=this.moveMinute(this.date,j);n=this.moveMinute(this.viewDate,j)}}}}}if(this.dateWithinRange(i)){this.date=i;this.viewDate=n;this.setValue();this.update();o.preventDefault();k=true}break;case 38:case 40:if(!this.keyboardNavigation){break}j=o.keyCode===38?-1:1;m=this.viewMode;if(o.ctrlKey){m+=2}else{if(o.shiftKey){m+=1}}if(m===4){i=this.moveYear(this.date,j);n=this.moveYear(this.viewDate,j)}else{if(m===3){i=this.moveMonth(this.date,j);n=this.moveMonth(this.viewDate,j)}else{if(m===2){i=this.moveDate(this.date,j*7);n=this.moveDate(this.viewDate,j*7)}else{if(m===1){if(this.showMeridian){i=this.moveHour(this.date,j*6);n=this.moveHour(this.viewDate,j*6)}else{i=this.moveHour(this.date,j*4);n=this.moveHour(this.viewDate,j*4)}}else{if(m===0){i=this.moveMinute(this.date,j*4);n=this.moveMinute(this.viewDate,j*4)}}}}}if(this.dateWithinRange(i)){this.date=i;this.viewDate=n;this.setValue();this.update();o.preventDefault();k=true}break;case 13:if(this.viewMode!==0){var p=this.viewMode;this.showMode(-1);this.fill();if(p===this.viewMode&&this.autoclose){this.hide()}}else{this.fill();if(this.autoclose){this.hide()}}o.preventDefault();break;case 9:this.hide();break}if(k){var l;if(this.isInput){l=this.element}else{if(this.component){l=this.element.find("input")}}if(l){l.change()}this.element.trigger({type:"changeDate",date:this.getDate()})}},showMode:function(i){if(i){var j=Math.max(0,Math.min(c.modes.length-1,this.viewMode+i));if(j>=this.minView&&j<=this.maxView){this.element.trigger({type:"changeMode",date:this.viewDate,oldViewMode:this.viewMode,newViewMode:j});this.viewMode=j}}this.picker.find(">div").hide().filter(".datetimepicker-"+c.modes[this.viewMode].clsName).css("display","block");this.updateNavArrows()},reset:function(){this._setDate(null,"date")},convertViewModeText:function(i){switch(i){case 4:return"decade";case 3:return"year";case 2:return"month";case 1:return"day";case 0:return"hour"}}};var b=d.fn.datetimepicker;d.fn.datetimepicker=function(k){var i=Array.apply(null,arguments);i.shift();var j;this.each(function(){var n=d(this),m=n.data("datetimepicker"),l=typeof k==="object"&&k;if(!m){n.data("datetimepicker",(m=new g(this,d.extend({},d.fn.datetimepicker.defaults,l))))}if(typeof k==="string"&&typeof m[k]==="function"){j=m[k].apply(m,i);if(j!==f){return false}}});if(j!==f){return j}else{return this}};d.fn.datetimepicker.defaults={};d.fn.datetimepicker.Constructor=g;var e=d.fn.datetimepicker.dates={en:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],meridiem:["am","pm"],suffix:["st","nd","rd","th"],today:"Today",clear:"Clear"}};var c={modes:[{clsName:"minutes",navFnc:"Hours",navStep:1},{clsName:"hours",navFnc:"Date",navStep:1},{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],isLeapYear:function(i){return(((i%4===0)&&(i%100!==0))||(i%400===0))},getDaysInMonth:function(i,j){return[31,(c.isLeapYear(i)?29:28),31,30,31,30,31,31,30,31,30,31][j]},getDefaultFormat:function(i,j){if(i==="standard"){if(j==="input"){return"yyyy-mm-dd hh:ii"}else{return"yyyy-mm-dd hh:ii:ss"}}else{if(i==="php"){if(j==="input"){return"Y-m-d H:i"}else{return"Y-m-d H:i:s"}}else{throw new Error("Invalid format type.")}}},validParts:function(i){if(i==="standard"){return/t|hh?|HH?|p|P|z|Z|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g}else{if(i==="php"){return/[dDjlNwzFmMnStyYaABgGhHis]/g}else{throw new Error("Invalid format type.")}}},nonpunctuation:/[^ -\/:-@\[-`{-~\t\n\rTZ]+/g,parseFormat:function(l,j){var i=l.replace(this.validParts(j),"\0").split("\0"),k=l.match(this.validParts(j));if(!i||!i.length||!k||k.length===0){throw new Error("Invalid date format.")}return{separators:i,parts:k}},parseDate:function(A,y,v,j,r){if(A instanceof Date){var u=new Date(A.valueOf()-A.getTimezoneOffset()*60000);u.setMilliseconds(0);return u}if(/^\d{4}\-\d{1,2}\-\d{1,2}$/.test(A)){y=this.parseFormat("yyyy-mm-dd",j)}if(/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}$/.test(A)){y=this.parseFormat("yyyy-mm-dd hh:ii",j)}if(/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}\:\d{1,2}[Z]{0,1}$/.test(A)){y=this.parseFormat("yyyy-mm-dd hh:ii:ss",j)}if(/^[-+]\d+[dmwy]([\s,]+[-+]\d+[dmwy])*$/.test(A)){var l=/([-+]\d+)([dmwy])/,q=A.match(/([-+]\d+)([dmwy])/g),t,p;A=new Date();for(var x=0;x<q.length;x++){t=l.exec(q[x]);p=parseInt(t[1]);switch(t[2]){case"d":A.setUTCDate(A.getUTCDate()+p);break;case"m":A=g.prototype.moveMonth.call(g.prototype,A,p);break;case"w":A.setUTCDate(A.getUTCDate()+p*7);break;case"y":A=g.prototype.moveYear.call(g.prototype,A,p);break}}return h(A.getUTCFullYear(),A.getUTCMonth(),A.getUTCDate(),A.getUTCHours(),A.getUTCMinutes(),A.getUTCSeconds(),0)}var q=A&&A.toString().match(this.nonpunctuation)||[],A=new Date(0,0,0,0,0,0,0),m={},z=["hh","h","ii","i","ss","s","yyyy","yy","M","MM","m","mm","D","DD","d","dd","H","HH","p","P","z","Z"],o={hh:function(s,i){return s.setUTCHours(i)},h:function(s,i){return s.setUTCHours(i)},HH:function(s,i){return s.setUTCHours(i===12?0:i)},H:function(s,i){return s.setUTCHours(i===12?0:i)},ii:function(s,i){return s.setUTCMinutes(i)},i:function(s,i){return s.setUTCMinutes(i)},ss:function(s,i){return s.setUTCSeconds(i)},s:function(s,i){return s.setUTCSeconds(i)},yyyy:function(s,i){return s.setUTCFullYear(i)},yy:function(s,i){return s.setUTCFullYear(2000+i)},m:function(s,i){i-=1;while(i<0){i+=12}i%=12;s.setUTCMonth(i);while(s.getUTCMonth()!==i){if(isNaN(s.getUTCMonth())){return s}else{s.setUTCDate(s.getUTCDate()-1)}}return s},d:function(s,i){return s.setUTCDate(i)},p:function(s,i){return s.setUTCHours(i===1?s.getUTCHours()+12:s.getUTCHours())},z:function(){return r}},B,k,t;o.M=o.MM=o.mm=o.m;o.dd=o.d;o.P=o.p;o.Z=o.z;A=h(A.getFullYear(),A.getMonth(),A.getDate(),A.getHours(),A.getMinutes(),A.getSeconds());if(q.length===y.parts.length){for(var x=0,w=y.parts.length;x<w;x++){B=parseInt(q[x],10);t=y.parts[x];if(isNaN(B)){switch(t){case"MM":k=d(e[v].months).filter(function(){var i=this.slice(0,q[x].length),s=q[x].slice(0,i.length);return i===s});B=d.inArray(k[0],e[v].months)+1;break;case"M":k=d(e[v].monthsShort).filter(function(){var i=this.slice(0,q[x].length),s=q[x].slice(0,i.length);return i.toLowerCase()===s.toLowerCase()});B=d.inArray(k[0],e[v].monthsShort)+1;break;case"p":case"P":B=d.inArray(q[x].toLowerCase(),e[v].meridiem);break;case"z":case"Z":r;break}}m[t]=B}for(var x=0,n;x<z.length;x++){n=z[x];if(n in m&&!isNaN(m[n])){o[n](A,m[n])}}}return A},formatDate:function(l,q,m,p,o){if(l===null){return""}var k;if(p==="standard"){k={t:l.getTime(),yy:l.getUTCFullYear().toString().substring(2),yyyy:l.getUTCFullYear(),m:l.getUTCMonth()+1,M:e[m].monthsShort[l.getUTCMonth()],MM:e[m].months[l.getUTCMonth()],d:l.getUTCDate(),D:e[m].daysShort[l.getUTCDay()],DD:e[m].days[l.getUTCDay()],p:(e[m].meridiem.length===2?e[m].meridiem[l.getUTCHours()<12?0:1]:""),h:l.getUTCHours(),i:l.getUTCMinutes(),s:l.getUTCSeconds(),z:o};if(e[m].meridiem.length===2){k.H=(k.h%12===0?12:k.h%12)}else{k.H=k.h}k.HH=(k.H<10?"0":"")+k.H;k.P=k.p.toUpperCase();k.Z=k.z;k.hh=(k.h<10?"0":"")+k.h;k.ii=(k.i<10?"0":"")+k.i;k.ss=(k.s<10?"0":"")+k.s;k.dd=(k.d<10?"0":"")+k.d;k.mm=(k.m<10?"0":"")+k.m}else{if(p==="php"){k={y:l.getUTCFullYear().toString().substring(2),Y:l.getUTCFullYear(),F:e[m].months[l.getUTCMonth()],M:e[m].monthsShort[l.getUTCMonth()],n:l.getUTCMonth()+1,t:c.getDaysInMonth(l.getUTCFullYear(),l.getUTCMonth()),j:l.getUTCDate(),l:e[m].days[l.getUTCDay()],D:e[m].daysShort[l.getUTCDay()],w:l.getUTCDay(),N:(l.getUTCDay()===0?7:l.getUTCDay()),S:(l.getUTCDate()%10<=e[m].suffix.length?e[m].suffix[l.getUTCDate()%10-1]:""),a:(e[m].meridiem.length===2?e[m].meridiem[l.getUTCHours()<12?0:1]:""),g:(l.getUTCHours()%12===0?12:l.getUTCHours()%12),G:l.getUTCHours(),i:l.getUTCMinutes(),s:l.getUTCSeconds()};k.m=(k.n<10?"0":"")+k.n;k.d=(k.j<10?"0":"")+k.j;k.A=k.a.toString().toUpperCase();k.h=(k.g<10?"0":"")+k.g;k.H=(k.G<10?"0":"")+k.G;k.i=(k.i<10?"0":"")+k.i;k.s=(k.s<10?"0":"")+k.s}else{throw new Error("Invalid format type.")}}var l=[],r=d.extend([],q.separators);for(var n=0,j=q.parts.length;n<j;n++){if(r.length){l.push(r.shift())}l.push(k[q.parts[n]])}if(r.length){l.push(r.shift())}return l.join("")},convertViewMode:function(i){switch(i){case 4:case"decade":i=4;break;case 3:case"year":i=3;break;case 2:case"month":i=2;break;case 1:case"day":i=1;break;case 0:case"hour":i=0;break}return i},headTemplate:'<thead><tr><th class="prev"><i class="{iconType} {leftArrow}"/></th><th colspan="5" class="switch"></th><th class="next"><i class="{iconType} {rightArrow}"/></th></tr></thead>',headTemplateV3:'<thead><tr><th class="prev"><span class="{iconType} {leftArrow}"></span> </th><th colspan="5" class="switch"></th><th class="next"><span class="{iconType} {rightArrow}"></span> </th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>',footTemplate:'<tfoot><tr><th colspan="7" class="today"></th></tr><tr><th colspan="7" class="clear"></th></tr></tfoot>'};c.template='<div class="datetimepicker"><div class="datetimepicker-minutes"><table class=" table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-hours"><table class=" table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-days"><table class=" table-condensed">'+c.headTemplate+"<tbody></tbody>"+c.footTemplate+'</table></div><div class="datetimepicker-months"><table class="table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-years"><table class="table-condensed">'+c.headTemplate+c.contTemplate+c.footTemplate+"</table></div></div>";c.templateV3='<div class="datetimepicker"><div class="datetimepicker-minutes"><table class=" table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-hours"><table class=" table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-days"><table class=" table-condensed">'+c.headTemplateV3+"<tbody></tbody>"+c.footTemplate+'</table></div><div class="datetimepicker-months"><table class="table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+'</table></div><div class="datetimepicker-years"><table class="table-condensed">'+c.headTemplateV3+c.contTemplate+c.footTemplate+"</table></div></div>";d.fn.datetimepicker.DPGlobal=c;d.fn.datetimepicker.noConflict=function(){d.fn.datetimepicker=b;return this};d(document).on("focus.datetimepicker.data-api click.datetimepicker.data-api",'[data-provide="datetimepicker"]',function(j){var i=d(this);if(i.data("datetimepicker")){return}j.preventDefault();i.datetimepicker("show")});d(function(){d('[data-provide="datetimepicker-inline"]').datetimepicker()})}));

		
		$('.datetimepicker').datetimepicker({
			startView:'decade',
			minView:'month',
			format: 'yyyy-mm-dd',
			autoclose:true
		});
		
		// this showing and hiding makes sure that there are no open ones at the bottom of the page
		$('.datetimepicker').datetimepicker('show');
		$('.datetimepicker').datetimepicker('hide');
		
		//link the start- and end- datetimepickers
		$(".datetimepicker").datetimepicker().on('changeDate', function(ev){
				var changed_datepicker = this.getAttribute("id");
				if (changed_datepicker.substr(-3) == "end") {
					$("#" + changed_datepicker.replace("end","start")).datetimepicker("setEndDate", '"' + ev.date.toISOString().substring(0,10) + '"');
				} else  {
					$("#" + changed_datepicker.replace("start","end")).datetimepicker("setStartDate", '"' + ev.date.toISOString().substring(0,10) + '"');
				}
		});
				
		
		
		// Other stuff ================================================================
		
		// activate the invalid-fact Popovers
		$(document).ready(function(){
			$('[data-toggle="popover"]').popover();   
		});

		//automatically check the fact-formats when a value was edited
		$(".value").focusout(function(){
			checkAdditionalFactFormats();
		});
	}
	
	

</script>

<script src="{% static 'js/jquery.js' %}"></script>

{% endblock %}



